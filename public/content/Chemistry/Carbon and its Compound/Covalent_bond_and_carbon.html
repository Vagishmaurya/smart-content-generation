<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covalent Bonds & Carbon - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #3a7bd5 50%, #2a5298 75%, #1e3c72 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(3px 3px at 20% 30%, rgba(255,255,255,0.3), transparent),
                radial-gradient(3px 3px at 60% 70%, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 50% 50%, rgba(255,255,255,0.2), transparent);
            background-size: 250px 250px;
            opacity: 0.4;
            animation: drift 80s linear infinite;
            pointer-events: none;
        }

        @keyframes drift {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-250px, -250px) rotate(360deg); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #f093fb, #f5576c, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 0 40px rgba(240, 147, 251, 0.3);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { 
                filter: brightness(1) drop-shadow(0 0 20px rgba(240, 147, 251, 0.5)); 
            }
            50% { 
                filter: brightness(1.2) drop-shadow(0 0 40px rgba(79, 172, 254, 0.7)); 
            }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Molecule Stage */
        .molecule-stage {
            background: linear-gradient(135deg, 
                rgba(30, 60, 114, 0.9) 0%,
                rgba(42, 82, 152, 0.9) 50%,
                rgba(30, 60, 114, 0.9) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            margin: 40px 0;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 120px rgba(79, 172, 254, 0.2);
            overflow: hidden;
            border: 3px solid rgba(102, 126, 234, 0.4);
        }

        #moleculeCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #moleculeCanvas:active {
            cursor: grabbing;
        }

        /* Stage Info Overlay */
        .stage-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            max-width: 320px;
        }

        .stage-info h3 {
            font-size: 1.3rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stage-info p {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Formula Display */
        .formula-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            font-size: 1.4rem;
            font-weight: bold;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        /* Molecule Selector */
        .molecule-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .molecule-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.4);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .molecule-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            transform: scale(1.05);
        }

        .molecule-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        /* Info Panel */
        .info-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.7),
                rgba(30, 60, 114, 0.7));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(15px);
        }

        .info-title {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        /* Properties Grid */
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .property-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .property-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .property-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .property-title {
            font-size: 1.1rem;
            color: #a5b4fc;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .property-value {
            font-size: 1.3rem;
            color: #fbbf24;
            font-weight: bold;
        }

        .property-description {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-top: 8px;
            line-height: 1.4;
        }

        /* Bond Type Display */
        .bond-types {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .bond-type {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            min-width: 150px;
        }

        .bond-visual {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fbbf24;
        }

        .bond-label {
            font-size: 1rem;
            color: #cbd5e1;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.4);
        }

        .legend-title {
            font-size: 1rem;
            color: #a5b4fc;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .molecule-stage {
                height: 400px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
            }
            
            .bond-types {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">üîä</span>
            <span class="mute-icon">üîá</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Covalent Bonds & Carbon</h1>
            <p>Discover how atoms share electrons to form molecules and explore the unique bonding nature of carbon</p>
        </div>

        <!-- Molecule Stage -->
        <div class="molecule-stage" id="stage">
            <canvas id="moleculeCanvas"></canvas>
            
            <div class="stage-info" id="stageInfo">
                <h3 id="infoTitle">Carbon's Electronic Configuration</h3>
                <p id="infoText">Carbon has 6 electrons: 2 in K-shell, 4 in L-shell</p>
            </div>
            
            <div class="formula-display" id="formulaDisplay">
                C (1s¬≤ 2s¬≤ 2p¬≤)
            </div>
            
            <div class="legend">
                <div class="legend-title">Atom Colors</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4a4a4a;"></div>
                        <span class="legend-label">Carbon</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffffff;"></div>
                        <span class="legend-label">Hydrogen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span class="legend-label">Oxygen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4444ff;"></div>
                        <span class="legend-label">Nitrogen</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Explore Covalent Bonding</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="playCompleteLesson()">üìö Complete Lesson</button>
                <button class="demo-btn" onclick="showElectronConfig()">‚öõÔ∏è Electron Config</button>
                <button class="demo-btn" onclick="showBondFormation()">üîó Bond Formation</button>
                <button class="demo-btn" onclick="showBondTypes()">‚ö° Bond Types</button>
                <button class="demo-btn" onclick="showAllotropes()">üíé Allotropes</button>
                <button class="demo-btn" onclick="resetAllClick()">üîÑ Reset</button>
            </div>

            <div class="molecule-selector">
                <button class="molecule-btn" onclick="selectMolecule('carbon')">Carbon Atom</button>
                <button class="molecule-btn" onclick="selectMolecule('hydrogen')">H‚ÇÇ</button>
                <button class="molecule-btn" onclick="selectMolecule('methane')">CH‚ÇÑ</button>
                <button class="molecule-btn" onclick="selectMolecule('ethane')">C‚ÇÇH‚ÇÜ</button>
                <button class="molecule-btn" onclick="selectMolecule('ethene')">C‚ÇÇH‚ÇÑ</button>
                <button class="molecule-btn" onclick="selectMolecule('oxygen')">O‚ÇÇ</button>
                <button class="molecule-btn" onclick="selectMolecule('nitrogen')">N‚ÇÇ</button>
                <button class="molecule-btn" onclick="selectMolecule('diamond')">Diamond</button>
                <button class="molecule-btn" onclick="selectMolecule('graphite')">Graphite</button>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="info-title">‚öõÔ∏è Covalent Bond Properties</div>
            
            <!-- Properties Grid -->
            <div class="properties-grid">
                <div class="property-card">
                    <div class="property-icon">‚öõÔ∏è</div>
                    <div class="property-title">Bond Type</div>
                    <div class="property-value" id="bondType">Electron Sharing</div>
                    <div class="property-description">Atoms share electron pairs</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">üî•</div>
                    <div class="property-title">Melting Point</div>
                    <div class="property-value" id="meltingPoint">Low</div>
                    <div class="property-description">Weak intermolecular forces</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">‚ö°</div>
                    <div class="property-title">Conductivity</div>
                    <div class="property-value" id="conductivity">Poor</div>
                    <div class="property-description">No free electrons or ions</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">üíé</div>
                    <div class="property-title">Structure</div>
                    <div class="property-value" id="structure">Molecular</div>
                    <div class="property-description">Discrete molecules</div>
                </div>
            </div>

            <!-- Bond Types -->
            <div class="bond-types">
                <div class="bond-type">
                    <div class="bond-visual">C‚ÄîC</div>
                    <div class="bond-label">Single Bond</div>
                </div>
                <div class="bond-type">
                    <div class="bond-visual">C‚ïêC</div>
                    <div class="bond-label">Double Bond</div>
                </div>
                <div class="bond-type">
                    <div class="bond-visual">C‚â°C</div>
                    <div class="bond-label">Triple Bond</div>
                </div>
            </div>

            <div id="current-info" style="text-align: center; margin-top: 20px; font-size: 1.1rem; color: #e2e8f0; line-height: 1.6;">
                Carbon forms covalent bonds by sharing its four valence electrons, creating the foundation for all organic chemistry!
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator" style="display: none;">
        <div class="progress-dot" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
        <div class="progress-dot" data-step="4"></div>
        <div class="progress-dot" data-step="5"></div>
        <div class="progress-dot" data-step="6"></div>
    </div>

    <script>
        // Voice System with Proper Cleanup
        class CovalentNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State Management
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let isPlaying = false;
        let currentDemoAborted = false;
        let activeAnimations = [];
        let currentRunId = 0;
        let currentTaskId = null;

        // Three.js variables
        let scene, camera, renderer;
        let currentMolecule = null;
        let currentMoleculeType = 'carbon';
        let animationId;
        let rotationAnimation = null;
        let bondAnimation = null;

        // Molecule Data
        const molecules = {
            carbon: {
                formula: 'C',
                atoms: [
                    { element: 'C', position: [0, 0, 0] }
                ],
                electrons: {
                    K: 2,
                    L: 4
                },
                bonds: [],
                description: "Carbon atom with 4 valence electrons"
            },
            hydrogen: {
                formula: 'H‚ÇÇ',
                atoms: [
                    { element: 'H', position: [-0.5, 0, 0] },
                    { element: 'H', position: [0.5, 0, 0] }
                ],
                bonds: [[0, 1]],
                bondTypes: ['single'],
                description: "Hydrogen molecule - simplest covalent bond"
            },
            methane: {
                formula: 'CH‚ÇÑ',
                atoms: [
                    { element: 'C', position: [0, 0, 0] },
                    { element: 'H', position: [1, 1, 1] },
                    { element: 'H', position: [-1, -1, 1] },
                    { element: 'H', position: [-1, 1, -1] },
                    { element: 'H', position: [1, -1, -1] }
                ],
                bonds: [[0,1], [0,2], [0,3], [0,4]],
                bondTypes: ['single', 'single', 'single', 'single'],
                description: "Methane - tetrahedral structure"
            },
            ethane: {
                formula: 'C‚ÇÇH‚ÇÜ',
                atoms: [
                    { element: 'C', position: [-0.7, 0, 0] },
                    { element: 'C', position: [0.7, 0, 0] },
                    { element: 'H', position: [-1.5, 0.6, 0.6] },
                    { element: 'H', position: [-1.5, -0.6, 0.6] },
                    { element: 'H', position: [-1.5, 0, -0.8] },
                    { element: 'H', position: [1.5, 0.6, 0.6] },
                    { element: 'H', position: [1.5, -0.6, 0.6] },
                    { element: 'H', position: [1.5, 0, -0.8] }
                ],
                bonds: [[0,1], [0,2], [0,3], [0,4], [1,5], [1,6], [1,7]],
                bondTypes: ['single', 'single', 'single', 'single', 'single', 'single', 'single'],
                description: "Ethane - single C-C bond"
            },
            ethene: {
                formula: 'C‚ÇÇH‚ÇÑ',
                atoms: [
                    { element: 'C', position: [-0.6, 0, 0] },
                    { element: 'C', position: [0.6, 0, 0] },
                    { element: 'H', position: [-1.4, 0.7, 0] },
                    { element: 'H', position: [-1.4, -0.7, 0] },
                    { element: 'H', position: [1.4, 0.7, 0] },
                    { element: 'H', position: [1.4, -0.7, 0] }
                ],
                bonds: [[0,1], [0,2], [0,3], [1,4], [1,5]],
                bondTypes: ['double', 'single', 'single', 'single', 'single'],
                description: "Ethene - double C=C bond"
            },
            oxygen: {
                formula: 'O‚ÇÇ',
                atoms: [
                    { element: 'O', position: [-0.6, 0, 0] },
                    { element: 'O', position: [0.6, 0, 0] }
                ],
                bonds: [[0, 1]],
                bondTypes: ['double'],
                description: "Oxygen - double bond"
            },
            nitrogen: {
                formula: 'N‚ÇÇ',
                atoms: [
                    { element: 'N', position: [-0.5, 0, 0] },
                    { element: 'N', position: [0.5, 0, 0] }
                ],
                bonds: [[0, 1]],
                bondTypes: ['triple'],
                description: "Nitrogen - triple bond"
            },
            diamond: {
                formula: 'Diamond (C)',
                atoms: [],
                description: "Diamond - tetrahedral network"
            },
            graphite: {
                formula: 'Graphite (C)',
                atoms: [],
                description: "Graphite - layered hexagonal"
            }
        };

        // Stop Current Demo with Complete Cleanup
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentRunId++;
            
            // Clear task context
            currentTaskId = null;
            
            // Stop narrator
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            // Clear animations
            if (rotationAnimation) {
                cancelAnimationFrame(rotationAnimation);
                rotationAnimation = null;
            }
            if (bondAnimation) {
                clearInterval(bondAnimation);
                bondAnimation = null;
            }
            
            // Hide progress
            hideProgress();
            
            isPlaying = false;
        }

        // Check if Demo Should Continue
        function shouldContinue(taskId = null) {
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        // Create New Narrator
        function createNewNarrator(taskId = null) {
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentNarrator = new CovalentNarrator();
            return currentNarrator;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('moleculeCanvas');
            const container = document.getElementById('stage');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = null;
            
            // Camera
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 0, 10);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x667eea, 0.5);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            // Create initial molecule
            createMolecule('carbon');
            
            // Setup controls
            setupMouseControls();
            
            // Start animation loop
            animate();
        }

        // Create molecule visualization
        function createMolecule(type) {
            // Clear existing molecule
            if (currentMolecule) {
                scene.remove(currentMolecule);
            }
            
            currentMoleculeType = type;
            currentMolecule = new THREE.Group();
            
            if (type === 'carbon') {
                createCarbonAtom();
            } else if (type === 'diamond') {
                createDiamondStructure();
            } else if (type === 'graphite') {
                createGraphiteStructure();
            } else {
                const moleculeData = molecules[type];
                if (!moleculeData) return;
                
                createMolecularStructure(moleculeData);
            }
            
            scene.add(currentMolecule);
            
            // Update displays
            const moleculeData = molecules[type];
            if (moleculeData) {
                document.getElementById('formulaDisplay').textContent = moleculeData.formula;
                updateInfo(type, moleculeData.description);
            }
        }

        // Create carbon atom with electron shells
        function createCarbonAtom() {
            // Nucleus
            const nucleusGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({
                color: 0x4a4a4a,
                emissive: 0x1a1a1a,
                emissiveIntensity: 0.3
            });
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            currentMolecule.add(nucleus);
            
            // K-shell (2 electrons)
            const kShellRadius = 1.5;
            const kRingGeometry = new THREE.TorusGeometry(kShellRadius, 0.05, 8, 64);
            const kRingMaterial = new THREE.MeshBasicMaterial({
                color: 0x60a5fa,
                opacity: 0.3,
                transparent: true
            });
            const kRing = new THREE.Mesh(kRingGeometry, kRingMaterial);
            kRing.rotation.x = Math.PI / 2;
            currentMolecule.add(kRing);
            
            // K-shell electrons
            for (let i = 0; i < 2; i++) {
                const electronGeometry = new THREE.SphereGeometry(0.1, 16, 16);
                const electronMaterial = new THREE.MeshPhongMaterial({
                    color: 0x3b82f6,
                    emissive: 0x3b82f6,
                    emissiveIntensity: 0.5
                });
                const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                
                const angle = (i / 2) * Math.PI * 2;
                electron.position.x = Math.cos(angle) * kShellRadius;
                electron.position.z = Math.sin(angle) * kShellRadius;
                
                electron.userData = { shell: 'K', angle: angle, radius: kShellRadius };
                currentMolecule.add(electron);
            }
            
            // L-shell (4 electrons)
            const lShellRadius = 2.5;
            const lRingGeometry = new THREE.TorusGeometry(lShellRadius, 0.05, 8, 64);
            const lRingMaterial = new THREE.MeshBasicMaterial({
                color: 0x60a5fa,
                opacity: 0.3,
                transparent: true
            });
            const lRing = new THREE.Mesh(lRingGeometry, lRingMaterial);
            lRing.rotation.x = Math.PI / 2;
            currentMolecule.add(lRing);
            
            // L-shell electrons (valence)
            for (let i = 0; i < 4; i++) {
                const electronGeometry = new THREE.SphereGeometry(0.12, 16, 16);
                const electronMaterial = new THREE.MeshPhongMaterial({
                    color: 0xfbbf24,
                    emissive: 0xfbbf24,
                    emissiveIntensity: 0.6
                });
                const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                
                const angle = (i / 4) * Math.PI * 2;
                electron.position.x = Math.cos(angle) * lShellRadius;
                electron.position.z = Math.sin(angle) * lShellRadius;
                
                electron.userData = { shell: 'L', angle: angle, radius: lShellRadius, valence: true };
                currentMolecule.add(electron);
            }
        }

        // Create molecular structure
        function createMolecularStructure(moleculeData) {
            const atomMeshes = [];
            
            // Create atoms
            moleculeData.atoms.forEach((atom, index) => {
                const geometry = new THREE.SphereGeometry(
                    getAtomRadius(atom.element),
                    32,
                    32
                );
                
                const material = new THREE.MeshPhongMaterial({
                    color: getAtomColor(atom.element),
                    emissive: getAtomColor(atom.element),
                    emissiveIntensity: 0.3
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(...atom.position);
                mesh.userData = { element: atom.element, index: index };
                
                atomMeshes.push(mesh);
                currentMolecule.add(mesh);
            });
            
            // Create bonds
            if (moleculeData.bonds) {
                moleculeData.bonds.forEach((bond, index) => {
                    const bondType = moleculeData.bondTypes ? moleculeData.bondTypes[index] : 'single';
                    const atom1 = atomMeshes[bond[0]];
                    const atom2 = atomMeshes[bond[1]];
                    
                    createBond(atom1.position, atom2.position, bondType);
                });
            }
        }

        // Create bond between atoms
        function createBond(pos1, pos2, type = 'single') {
            const direction = new THREE.Vector3().subVectors(pos2, pos1);
            const length = direction.length();
            const center = new THREE.Vector3().addVectors(pos1, pos2).multiplyScalar(0.5);
            
            if (type === 'single') {
                createSingleBond(center, direction, length);
            } else if (type === 'double') {
                createDoubleBond(center, direction, length);
            } else if (type === 'triple') {
                createTripleBond(center, direction, length);
            }
        }

        function createSingleBond(center, direction, length) {
            const geometry = new THREE.CylinderGeometry(0.08, 0.08, length, 8);
            const material = new THREE.MeshPhongMaterial({ color: 0x888888 });
            const cylinder = new THREE.Mesh(geometry, material);
            
            cylinder.position.copy(center);
            cylinder.lookAt(center.clone().add(direction));
            cylinder.rotateX(Math.PI / 2);
            
            currentMolecule.add(cylinder);
        }

        function createDoubleBond(center, direction, length) {
            const offset = 0.15;
            const perpendicular = new THREE.Vector3(-direction.y, direction.x, 0).normalize();
            
            for (let i = -1; i <= 1; i += 2) {
                const geometry = new THREE.CylinderGeometry(0.08, 0.08, length, 8);
                const material = new THREE.MeshPhongMaterial({ color: 0x888888 });
                const cylinder = new THREE.Mesh(geometry, material);
                
                const bondPos = center.clone().add(perpendicular.clone().multiplyScalar(offset * i));
                cylinder.position.copy(bondPos);
                cylinder.lookAt(bondPos.clone().add(direction));
                cylinder.rotateX(Math.PI / 2);
                
                currentMolecule.add(cylinder);
            }
        }

        function createTripleBond(center, direction, length) {
            const positions = [
                { offset: [0, 0] },
                { offset: [0.2, 0] },
                { offset: [-0.2, 0] }
            ];
            
            positions.forEach(pos => {
                const geometry = new THREE.CylinderGeometry(0.08, 0.08, length, 8);
                const material = new THREE.MeshPhongMaterial({ color: 0x888888 });
                const cylinder = new THREE.Mesh(geometry, material);
                
                const bondPos = center.clone();
                bondPos.x += pos.offset[0];
                bondPos.y += pos.offset[1];
                
                cylinder.position.copy(bondPos);
                cylinder.lookAt(bondPos.clone().add(direction));
                cylinder.rotateX(Math.PI / 2);
                
                currentMolecule.add(cylinder);
            });
        }

        // Create diamond structure
        function createDiamondStructure() {
            const positions = [
                [0, 0, 0],
                [1.5, 1.5, 1.5],
                [-1.5, -1.5, 1.5],
                [-1.5, 1.5, -1.5],
                [1.5, -1.5, -1.5],
                [3, 0, 0],
                [0, 3, 0],
                [0, 0, 3],
                [-3, 0, 0],
                [0, -3, 0],
                [0, 0, -3]
            ];
            
            positions.forEach(pos => {
                const geometry = new THREE.SphereGeometry(0.3, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x4a4a4a,
                    emissive: 0x1a1a1a,
                    emissiveIntensity: 0.3
                });
                const atom = new THREE.Mesh(geometry, material);
                atom.position.set(...pos);
                currentMolecule.add(atom);
            });
            
            // Add bonds for tetrahedral structure
            const bonds = [
                [0, 1], [0, 2], [0, 3], [0, 4],
                [1, 5], [1, 6], [1, 7],
                [2, 8], [2, 9], [2, 10]
            ];
            
            bonds.forEach(bond => {
                const pos1 = new THREE.Vector3(...positions[bond[0]]);
                const pos2 = new THREE.Vector3(...positions[bond[1]]);
                createBond(pos1, pos2, 'single');
            });
        }

        // Create graphite structure
        function createGraphiteStructure() {
            // Layer 1
            const layer1Y = 0;
            const hexagon1 = createHexagonalLayer(layer1Y, 0x4a4a4a);
            currentMolecule.add(hexagon1);
            
            // Layer 2
            const layer2Y = 2;
            const hexagon2 = createHexagonalLayer(layer2Y, 0x5a5a5a);
            hexagon2.rotation.z = Math.PI / 6;
            currentMolecule.add(hexagon2);
            
            // Layer 3
            const layer3Y = -2;
            const hexagon3 = createHexagonalLayer(layer3Y, 0x3a3a3a);
            hexagon3.rotation.z = -Math.PI / 6;
            currentMolecule.add(hexagon3);
        }

        function createHexagonalLayer(yPos, color) {
            const layer = new THREE.Group();
            const radius = 1.4;
            
            // Central hexagon
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;
                
                const geometry = new THREE.SphereGeometry(0.25, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.2
                });
                const atom = new THREE.Mesh(geometry, material);
                atom.position.set(x, yPos, z);
                layer.add(atom);
                
                // Create bonds
                const nextI = (i + 1) % 6;
                const nextAngle = (nextI / 6) * Math.PI * 2;
                const nextX = Math.cos(nextAngle) * radius;
                const nextZ = Math.sin(nextAngle) * radius;
                
                const bondGeometry = new THREE.CylinderGeometry(0.06, 0.06, radius, 8);
                const bondMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
                const bond = new THREE.Mesh(bondGeometry, bondMaterial);
                
                bond.position.set(
                    (x + nextX) / 2,
                    yPos,
                    (z + nextZ) / 2
                );
                
                const direction = new THREE.Vector3(nextX - x, 0, nextZ - z);
                bond.lookAt(bond.position.clone().add(direction));
                bond.rotateX(Math.PI / 2);
                
                layer.add(bond);
            }
            
            return layer;
        }

        // Helper functions
        function getAtomRadius(element) {
            const radii = {
                'C': 0.4,
                'H': 0.25,
                'O': 0.35,
                'N': 0.35
            };
            return radii[element] || 0.3;
        }

        function getAtomColor(element) {
            const colors = {
                'C': 0x4a4a4a,
                'H': 0xffffff,
                'O': 0xff4444,
                'N': 0x4444ff
            };
            return colors[element] || 0x888888;
        }

        // Setup mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !currentMolecule) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                currentMolecule.rotation.y += deltaX * 0.01;
                currentMolecule.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(5, Math.min(20, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Rotate electrons for carbon atom
            if (currentMoleculeType === 'carbon' && currentMolecule) {
                currentMolecule.children.forEach(child => {
                    if (child.userData && child.userData.shell) {
                        const time = Date.now() * 0.001;
                        const speed = child.userData.shell === 'K' ? 1 : 0.8;
                        const angle = child.userData.angle + time * speed;
                        child.position.x = Math.cos(angle) * child.userData.radius;
                        child.position.z = Math.sin(angle) * child.userData.radius;
                    }
                });
            }
            
            // Gentle rotation for molecules
            if (currentMolecule && !isPlaying) {
                currentMolecule.rotation.y += 0.005;
            }
            
            renderer.render(scene, camera);
        }

        // Complete Lesson
        async function playCompleteLesson() {
            const taskId = 'complete-lesson';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(0);
            
            const narrator = createNewNarrator(taskId);
            await playCompleteLessonInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function playCompleteLessonInternal(narrator, taskId) {
            showProgress();
            
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("üìö Complete Lesson: Covalent Bonding");
            updateInfo("Introduction", "Understanding covalent bonds");
            
            // Chapter 1: Carbon's Electronic Configuration
            updateProgress(1);
            await narrator.speak("Welcome to the world of covalent bonding! Let's start by understanding carbon's unique electronic configuration.");
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('carbon');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Carbon has 6 electrons: 2 in the K-shell and 4 in the L-shell. These 4 valence electrons make carbon tetravalent.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Carbon can't easily lose or gain 4 electrons to form ions. Instead, it shares electrons to form covalent bonds!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 2: Simple Covalent Bonds
            updateProgress(2);
            updateInfo("Single Bonds", "Electron sharing");
            
            await selectMolecule('hydrogen');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Here's hydrogen gas - the simplest covalent bond. Two hydrogen atoms share their electrons to achieve helium's configuration.");
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('methane');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("In methane, carbon shares its 4 electrons with 4 hydrogen atoms, forming a perfect tetrahedral structure.");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 3: Multiple Bonds
            updateProgress(3);
            updateInfo("Multiple Bonds", "Double and triple bonds");
            
            await selectMolecule('ethene');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Ethene has a carbon-carbon double bond. Two pairs of electrons are shared between the carbon atoms.");
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('oxygen');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Oxygen molecules also have a double bond, sharing two pairs of electrons.");
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('nitrogen');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Nitrogen forms a triple bond - the strongest covalent bond, sharing three pairs of electrons!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 4: Properties
            updateProgress(4);
            updateInfo("Properties", "Covalent compound characteristics");
            
            await narrator.speak("Covalent compounds have low melting points, poor electrical conductivity, and exist as discrete molecules.");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 5: Diamond
            updateProgress(5);
            updateInfo("Allotropes", "Diamond structure");
            
            await selectMolecule('diamond');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Diamond is pure carbon with each atom bonded to four others in a tetrahedral network. This makes it the hardest natural substance!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 6: Graphite
            updateProgress(6);
            updateInfo("Allotropes", "Graphite structure");
            
            await selectMolecule('graphite');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Graphite has carbon atoms in hexagonal layers. The free electrons between layers make it a conductor and give it its slippery feel.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This concludes our journey through covalent bonding and carbon's unique properties!");
            
            hideProgress();
        }

        // Show Electron Configuration
        async function showElectronConfig() {
            const taskId = 'electron-config';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(1);
            
            const narrator = createNewNarrator(taskId);
            await showElectronConfigInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showElectronConfigInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("‚öõÔ∏è Electronic Configuration");
            
            await selectMolecule('carbon');
            await narrator.speak("Carbon has atomic number 6. Its electronic configuration is 1s¬≤ 2s¬≤ 2p¬≤.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("The 4 electrons in the outer shell are valence electrons. They participate in chemical bonding.");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Carbon needs 4 more electrons to complete its octet, achieved through covalent bonding.");
        }

        // Show Bond Formation
        async function showBondFormation() {
            const taskId = 'bond-formation';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(2);
            
            const narrator = createNewNarrator(taskId);
            await showBondFormationInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showBondFormationInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("üîó Covalent Bond Formation");
            
            await selectMolecule('hydrogen');
            await narrator.speak("Watch how two hydrogen atoms share electrons to form H2.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('methane');
            await narrator.speak("In methane, carbon shares one electron with each hydrogen, forming 4 single bonds.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('ethane');
            await narrator.speak("Ethane shows a carbon-carbon single bond plus C-H bonds.");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Covalent bonds form through electron sharing, allowing atoms to achieve noble gas configuration.");
        }

        // Show Bond Types
        async function showBondTypes() {
            const taskId = 'bond-types';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(3);
            
            const narrator = createNewNarrator(taskId);
            await showBondTypesInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showBondTypesInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("‚ö° Types of Covalent Bonds");
            
            await selectMolecule('ethane');
            await narrator.speak("Single bond - one pair of electrons shared, like in ethane.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('ethene');
            await narrator.speak("Double bond - two pairs of electrons shared, making the bond stronger and shorter.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('nitrogen');
            await narrator.speak("Triple bond - three pairs of electrons shared, the strongest covalent bond!");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Bond strength increases: Single < Double < Triple");
        }

        // Show Allotropes
        async function showAllotropes() {
            const taskId = 'allotropes';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(4);
            
            const narrator = createNewNarrator(taskId);
            await showAllotropesInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showAllotropesInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("üíé Allotropes of Carbon");
            
            await selectMolecule('diamond');
            await narrator.speak("Diamond - each carbon bonds to 4 others in a 3D tetrahedral network. Extremely hard!");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            await selectMolecule('graphite');
            await narrator.speak("Graphite - carbon atoms in flat hexagonal layers. Soft and conducts electricity!");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Same element, different structures, completely different properties!");
            
            updateCurrentInfo("Allotropes show how structure determines properties.");
        }

        // Helper Functions
        async function resetAll() {
            // Stop narrator
            if (currentNarrator) {
                currentNarrator.stop();
            }
            
            // Reset to carbon atom
            createMolecule('carbon');
            
            // Reset displays
            updateInfo("Carbon Atom", "Select a demonstration to explore covalent bonding");
            updateCurrentInfo("Carbon forms covalent bonds by sharing its four valence electrons!");
            
            await wait(300);
        }

        async function resetAllClick() {
            stopCurrentDemo();
            isPlaying = false;
            await resetAll();
        }

        function selectMolecule(type) {
            createMolecule(type);
            
            // Update button states
            document.querySelectorAll('.molecule-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.toLowerCase().includes(type.toLowerCase()));
            });
            
            return new Promise(resolve => setTimeout(resolve, 500));
        }

        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function updateCurrentInfo(text) {
            document.getElementById('current-info').textContent = text;
        }

        function setActiveButton(index) {
            document.querySelectorAll('.demo-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function showProgress() {
            document.getElementById('progressIndicator').style.display = 'flex';
        }

        function hideProgress() {
            document.getElementById('progressIndicator').style.display = 'none';
        }

        function updateProgress(step) {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === step - 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentNarrator) {
                currentNarrator.stop();
            }
            
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        function initialize() {
            initThreeJS();
            const narrator = createNewNarrator('initialization');
            narrator.speak("Welcome to Covalent Bonds and Carbon! Discover how atoms share electrons to form molecules. Select a demonstration to begin!");
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>