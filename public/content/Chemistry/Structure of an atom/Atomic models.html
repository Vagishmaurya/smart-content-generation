<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.2 The Structure of an Atom - Interactive Models</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #16213e 75%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200px 200px;
            opacity: 0.2;
            animation: drift 60s linear infinite;
            pointer-events: none;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-200px, -200px); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #e94560, #c13651);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(233, 69, 96, 0.5);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(78, 205, 196, 0.5)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 40px rgba(69, 183, 209, 0.7)); }
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Model Stage */
        .model-stage {
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.95) 0%,
                rgba(30, 41, 59, 0.95) 50%,
                rgba(15, 23, 42, 0.95) 100%);
            border-radius: 20px;
            height: 500px;
            position: relative;
            margin: 40px 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 2px solid rgba(78, 205, 196, 0.3);
        }

        #atomCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #atomCanvas:active {
            cursor: grabbing;
        }

        /* Model Info Overlay */
        .model-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            max-width: 350px;
        }

        .model-info h3 {
            font-size: 1.3rem;
            color: #4ecdc4;
            margin-bottom: 10px;
        }

        .model-info p {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .action-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6);
            }
        }

        /* Model Description */
        .description-section {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 20px;
            padding: 30px;
            margin: 35px 0;
            border: 2px solid rgba(78, 205, 196, 0.2);
        }

        .description-title {
            font-size: 1.6rem;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .key-points {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
            line-height: 1.6;
        }

        .key-points li::before {
            content: '⚛️';
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Scientists Section */
        .scientists-section {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.7),
                rgba(30, 41, 59, 0.7));
            border-radius: 20px;
            padding: 40px;
            margin: 50px 0;
            border: 2px solid rgba(78, 205, 196, 0.2);
        }

        .scientists-title {
            font-size: 2.2rem;
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .scientists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .scientist-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(78, 205, 196, 0.2);
            transition: all 0.3s ease;
        }

        .scientist-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(78, 205, 196, 0.4);
        }

        .scientist-portrait {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .scientist-name {
            font-size: 1.3rem;
            color: #4ecdc4;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .scientist-years {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .scientist-contribution {
            font-size: 0.9rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: none;
            z-index: 100;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #4ecdc4;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .model-stage { height: 400px; }
            .control-buttons { flex-direction: column; align-items: center; }
            .scientists-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>4.2 The Structure of an Atom</h1>
            <p>Journey through the evolution of atomic models and discover how our understanding of atoms has transformed</p>
        </div>

        <!-- Model Stage -->
        <div class="model-stage" id="stage">
            <canvas id="atomCanvas"></canvas>
            
            <div class="model-info" id="modelInfo">
                <h3 id="modelTitle">Welcome to Atomic Models</h3>
                <p id="modelDescription">Select a model below to explore how scientists discovered the structure of atoms</p>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="controls">
            <div class="control-buttons">
                <button class="action-btn" id="btn-complete" onclick="playCompleteStory()">📖 Complete Story</button>
                <button class="action-btn" id="btn-thomson" onclick="showThomsonModel()">🍰 Thomson's Model</button>
                <button class="action-btn" id="btn-rutherford" onclick="showRutherfordModel()">☢️ Rutherford's Model</button>
                <button class="action-btn" id="btn-bohr" onclick="showBohrModel()">🌀 Bohr's Model</button>
                <button class="action-btn" id="btn-reset" onclick="resetView()">🔄 Reset</button>
            </div>
        </div>

        <!-- Model Description -->
        <div class="description-section">
            <div class="description-title" id="descTitle">Understanding Atomic Structure</div>
            <ul class="key-points" id="keyPoints">
                <li>Dalton's theory suggested atoms were indivisible, but discoveries of electrons and protons proved otherwise</li>
                <li>Scientists proposed various models to explain how electrons and protons are arranged within atoms</li>
                <li>Each model built upon previous discoveries, gradually revealing the true nature of atomic structure</li>
            </ul>
        </div>

        <!-- Scientists Section -->
        <div class="scientists-section">
            <div class="scientists-title">The Atomic Pioneers</div>
            
            <div class="scientists-grid">
                <div class="scientist-card">
                    <div class="scientist-portrait">⚛️</div>
                    <div class="scientist-name">J.J. Thomson</div>
                    <div class="scientist-years">1856 - 1940</div>
                    <div class="scientist-contribution">
                        First to propose an atomic model with internal structure. His "plum pudding" model showed electrons embedded in a positive sphere, proving atoms are electrically neutral.
                    </div>
                </div>
                
                <div class="scientist-card">
                    <div class="scientist-portrait">💫</div>
                    <div class="scientist-name">Ernest Rutherford</div>
                    <div class="scientist-years">1871 - 1937</div>
                    <div class="scientist-contribution">
                        Discovered the atomic nucleus through the gold foil experiment. Showed atoms are mostly empty space with a dense positive center containing nearly all mass.
                    </div>
                </div>
                
                <div class="scientist-card">
                    <div class="scientist-portrait">🔬</div>
                    <div class="scientist-name">Niels Bohr</div>
                    <div class="scientist-years">1885 - 1962</div>
                    <div class="scientist-contribution">
                        Solved the stability problem by proposing electrons orbit in discrete energy levels. Electrons in these special orbits don't radiate energy, explaining atomic stability.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Container -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-text" id="progressText">Loading...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        // Voice Narrator
        class AtomicNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.isDestroyed = false;
                this.isSpeaking = false;
            }

            speak(text) {
                if (!this.isEnabled || !text || this.isDestroyed) return Promise.resolve();
                
                return new Promise((resolve) => {
                    this.stop();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.95;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.85;
                    
                    this.isSpeaking = true;
                    utterance.onend = () => {
                        this.isSpeaking = false;
                        resolve();
                    };
                    utterance.onerror = () => {
                        this.isSpeaking = false;
                        resolve();
                    };
                    
                    this.currentUtterance = utterance;
                    speechSynthesis.speak(utterance);
                });
            }

            stop() {
                this.isSpeaking = false;
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
            }
        }

        // Global variables
        let globalAudioEnabled = true;
        let narrator = null;
        let scene, camera, renderer;
        let currentModel = null;
        let animationId;
        let particles = [];
        let isPlaying = false;
        let currentActiveButton = null;
        let storyInterval = null;

        // Button management functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        function stopAllAnimations() {
            // Stop current narrator
            if (narrator) {
                narrator.destroy();
                narrator = null;
            }
            
            // Clear any story interval
            if (storyInterval) {
                clearInterval(storyInterval);
                storyInterval = null;
            }
            
            // Hide progress bar
            hideProgress();
            
            // Set playing flag to false
            isPlaying = false;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('atomCanvas');
            const container = document.getElementById('stage');
            
            scene = new THREE.Scene();
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
            camera.position.set(0, 0, 25);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            renderer.setClearColor(0x000000, 0);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            setupMouseControls();
            animate();
        }

        // Clear the scene
        function clearScene() {
            while(scene.children.length > 2) { // Keep lights
                const child = scene.children[2];
                scene.remove(child);
                if(child.geometry) child.geometry.dispose();
                if(child.material) {
                    if(Array.isArray(child.material)) {
                        child.material.forEach(m => m.dispose());
                    } else {
                        child.material.dispose();
                    }
                }
            }
            particles = [];
            currentModel = null;
        }

        // Thomson's Plum Pudding Model
        function createThomsonModel() {
            clearScene();
            currentModel = new THREE.Group();
            
            // Positive sphere (red pudding)
            const sphereGeometry = new THREE.SphereGeometry(6, 32, 32);
            const sphereMaterial = new THREE.MeshPhongMaterial({
                color: 0xff4444,
                transparent: true,
                opacity: 0.4,
                emissive: 0xff4444,
                emissiveIntensity: 0.2
            });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            currentModel.add(sphere);
            
            // White electrons embedded on/near surface
            const electronGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const electronMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                emissive: 0xffffff,
                emissiveIntensity: 0.3
            });
            
            // Create electrons distributed on sphere surface
            const numElectrons = 10;
            for (let i = 0; i < numElectrons; i++) {
                const electron = new THREE.Mesh(electronGeometry, electronMaterial.clone());
                
                // Distribute on sphere surface
                const phi = Math.acos(1 - 2 * (i + 0.5) / numElectrons);
                const theta = Math.PI * (1 + Math.sqrt(5)) * i;
                
                const radius = 5.8; // Just inside sphere surface
                electron.position.x = radius * Math.sin(phi) * Math.cos(theta);
                electron.position.y = radius * Math.sin(phi) * Math.sin(theta);
                electron.position.z = radius * Math.cos(phi);
                
                // Add minus sign to electron
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'black';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('-', 32, 32);
                
                const texture = new THREE.CanvasTexture(canvas);
                const signGeometry = new THREE.PlaneGeometry(0.8, 0.8);
                const signMaterial = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true
                });
                const sign = new THREE.Mesh(signGeometry, signMaterial);
                sign.position.copy(electron.position);
                sign.position.multiplyScalar(1.1);
                sign.lookAt(0, 0, 0);
                
                electron.userData = {
                    originalPos: electron.position.clone(),
                    phase: Math.random() * Math.PI * 2
                };
                
                currentModel.add(electron);
                currentModel.add(sign);
                particles.push(electron);
                particles.push(sign);
            }
            
            scene.add(currentModel);
        }

        // Rutherford's Nuclear Model with Gold Foil Experiment
        function createRutherfordModel() {
            clearScene();
            currentModel = new THREE.Group();
            
            // Gold foil representation (vertical plane)
            const foilGeometry = new THREE.PlaneGeometry(12, 12);
            const foilMaterial = new THREE.MeshPhongMaterial({
                color: 0xffd700,
                transparent: true,
                opacity: 0.1,
                side: THREE.DoubleSide,
                emissive: 0xffd700,
                emissiveIntensity: 0.1
            });
            const foil = new THREE.Mesh(foilGeometry, foilMaterial);
            foil.position.x = 0;
            currentModel.add(foil);
            
            // Add grid lines to represent atoms in foil
            const gridHelper = new THREE.GridHelper(12, 10, 0xffd700, 0xffd700);
            gridHelper.rotation.z = Math.PI / 2;
            gridHelper.position.x = 0;
            gridHelper.material.opacity = 0.2;
            gridHelper.material.transparent = true;
            currentModel.add(gridHelper);
            
            // Central nucleus (tiny but visible)
            const nucleusGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 0.6
            });
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            currentModel.add(nucleus);
            
            // Create alpha particles shooting from left
            const createAlphaParticle = (index) => {
                const particleGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                const particleMaterial = new THREE.MeshPhongMaterial({
                    color: 0xffff00,
                    emissive: 0xffff00,
                    emissiveIntensity: 0.8
                });
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                
                // Starting positions (spread vertically)
                const yOffset = (index - 2.5) * 2;
                particle.position.set(-10, yOffset, 0);
                
                // Create trail
                const trailGeometry = new THREE.BufferGeometry();
                const trailMaterial = new THREE.LineBasicMaterial({
                    color: 0xffff00,
                    opacity: 0.5,
                    transparent: true
                });
                const trail = new THREE.Line(trailGeometry, trailMaterial);
                
                particle.userData = {
                    startX: -10,
                    yOffset: yOffset,
                    trail: trail,
                    trailPositions: [],
                    deflectionType: index === 2 ? 'rebound' : (Math.abs(yOffset) < 1 ? 'deflect' : 'straight'),
                    time: 0,
                    speed: 0.02
                };
                
                currentModel.add(particle);
                currentModel.add(trail);
                particles.push(particle);
                
                return particle;
            };
            
            // Create multiple alpha particles
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    if (currentModel) {
                        createAlphaParticle(i);
                    }
                }, i * 500);
            }
            
            // Add labels
            const createLabel = (text, position) => {
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text, 128, 32);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelGeometry = new THREE.PlaneGeometry(4, 1);
                const labelMaterial = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true
                });
                const label = new THREE.Mesh(labelGeometry, labelMaterial);
                label.position.copy(position);
                return label;
            };
            
            currentModel.add(createLabel('Gold Foil', new THREE.Vector3(0, 7, 0)));
            currentModel.add(createLabel('α particles', new THREE.Vector3(-8, 6, 0)));
            
            scene.add(currentModel);
        }

        // Bohr's Model with Labels
        function createBohrModel() {
            clearScene();
            currentModel = new THREE.Group();
            
            // Nucleus
            const nucleusGeometry = new THREE.SphereGeometry(1, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 0.4
            });
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            currentModel.add(nucleus);
            
            // Energy levels with labels (K, L, M shells)
            const shells = [
                { radius: 3, electrons: 2, color: 0xffff00, label: 'K (n=1)' },
                { radius: 5, electrons: 8, color: 0x00ff00, label: 'L (n=2)' },
                { radius: 7, electrons: 1, color: 0x00ffff, label: 'M (n=3)' }
            ];
            
            shells.forEach((shell, shellIndex) => {
                // Create orbit ring
                const ringGeometry = new THREE.TorusGeometry(shell.radius, 0.08, 8, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: shell.color,
                    opacity: 0.5,
                    transparent: true
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                currentModel.add(ring);
                
                // Add shell label
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(shell.label, 64, 32);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelGeometry = new THREE.PlaneGeometry(2, 1);
                const labelMaterial = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true
                });
                const label = new THREE.Mesh(labelGeometry, labelMaterial);
                label.position.set(shell.radius + 1.5, 0, 0);
                currentModel.add(label);
                
                // Add electrons
                for (let i = 0; i < shell.electrons; i++) {
                    const electronGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                    const electronMaterial = new THREE.MeshPhongMaterial({
                        color: 0x0088ff,
                        emissive: 0x0088ff,
                        emissiveIntensity: 0.5
                    });
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    
                    const angle = (i / shell.electrons) * Math.PI * 2;
                    electron.userData = {
                        radius: shell.radius,
                        angle: angle,
                        speed: 1 - shellIndex * 0.2,
                        shell: shellIndex
                    };
                    
                    currentModel.add(electron);
                    particles.push(electron);
                }
            });
            
            scene.add(currentModel);
        }

        // Show Thomson's Model
        function showThomsonModel() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-thomson');
            
            isPlaying = true;
            createThomsonModel();
            updateModelInfo(
                "Thomson's Plum Pudding Model (1897)",
                "Electrons embedded uniformly in a sphere of positive charge, like plums in a pudding. The first model to show internal structure."
            );
            updateDescription("Thomson's Model", [
                "Positive charge spread uniformly throughout the atom",
                "Electrons embedded within the positive sphere",
                "Total charge is neutral - equal positive and negative",
                "Could not explain Rutherford's gold foil results"
            ]);
            
            narrator = new AtomicNarrator();
            narrator.speak("Thomson's plum pudding model showed electrons embedded in positive matter, like raisins in a pudding.");
            
            isPlaying = false;
        }

        // Show Rutherford's Model
        function showRutherfordModel() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-rutherford');
            
            isPlaying = true;
            createRutherfordModel();
            updateModelInfo(
                "Rutherford's Gold Foil Experiment (1911)",
                "Alpha particles fired at thin gold foil. Most pass through, few deflect, rare ones rebound - revealing the tiny dense nucleus!"
            );
            updateDescription("Rutherford's Discovery", [
                "Fired alpha particles (He²⁺ ions) at gold foil 1000 atoms thick",
                "Most particles passed straight through - atoms are mostly empty space",
                "Some deflected at small angles - positive charge concentrated in center",
                "1 in 12,000 rebounded - nucleus is extremely small but dense",
                "Nucleus is 10,000 times smaller than the atom itself"
            ]);
            
            narrator = new AtomicNarrator();
            narrator.speak("Watch Rutherford's gold foil experiment! Most alpha particles pass through, but some deflect or even rebound, revealing the tiny nucleus.");
            
            isPlaying = false;
        }

        // Show Bohr's Model
        function showBohrModel() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-bohr');
            
            isPlaying = true;
            createBohrModel();
            updateModelInfo(
                "Bohr's Energy Level Model (1913)",
                "Electrons orbit in fixed energy levels (K, L, M shells). They don't radiate energy while in these special orbits."
            );
            updateDescription("Bohr's Model", [
                "Electrons in discrete circular orbits (energy levels)",
                "Orbits named K, L, M, N... or n=1, 2, 3, 4...",
                "Electrons don't radiate energy in these orbits",
                "Can jump between levels by absorbing/emitting energy",
                "Solved the stability problem of Rutherford's model"
            ]);
            
            narrator = new AtomicNarrator();
            narrator.speak("Bohr's model introduced quantum theory. Electrons orbit in fixed energy levels without losing energy.");
            
            isPlaying = false;
        }

        // Play Complete Story
        async function playCompleteStory() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-complete');
            
            isPlaying = true;
            showProgress("Starting journey through atomic models...");
            
            // Thomson
            showProgress("Thomson's Model - 1897", 20);
            createThomsonModel();
            updateModelInfo(
                "Thomson's Plum Pudding Model (1897)",
                "Electrons embedded uniformly in a sphere of positive charge."
            );
            
            narrator = new AtomicNarrator();
            await narrator.speak("Thomson's plum pudding model showed electrons embedded in positive matter.");
            if (!isPlaying) return;
            
            await wait(3000);
            if (!isPlaying) return;
            
            // Rutherford
            showProgress("Rutherford's Model - 1911", 50);
            createRutherfordModel();
            updateModelInfo(
                "Rutherford's Gold Foil Experiment (1911)",
                "Discovering the tiny, dense atomic nucleus."
            );
            
            narrator = new AtomicNarrator();
            await narrator.speak("Rutherford's experiment revealed atoms are mostly empty space with a tiny nucleus.");
            if (!isPlaying) return;
            
            await wait(3000);
            if (!isPlaying) return;
            
            // Bohr
            showProgress("Bohr's Model - 1913", 80);
            createBohrModel();
            updateModelInfo(
                "Bohr's Energy Level Model (1913)",
                "Electrons in fixed energy levels, solving the stability problem."
            );
            
            narrator = new AtomicNarrator();
            await narrator.speak("Bohr introduced quantum theory with electrons in stable energy levels.");
            if (!isPlaying) return;
            
            await wait(3000);
            
            showProgress("Journey complete!", 100);
            await wait(2000);
            hideProgress();
            
            narrator = new AtomicNarrator();
            narrator.speak("The evolution of atomic models shows how science builds upon discoveries to reveal nature's secrets!");
            
            isPlaying = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        // Reset View
        function resetView() {
            // Stop all animations
            stopAllAnimations();
            
            // Remove active button state
            setActiveButton(null);
            
            clearScene();
            camera.position.set(0, 0, 25);
            camera.rotation.set(0, 0, 0);
            if(currentModel) currentModel.rotation.set(0, 0, 0);
            
            updateModelInfo(
                "Welcome to Atomic Models",
                "Select a model to explore how scientists discovered the structure of atoms"
            );
            updateDescription("Understanding Atomic Structure", [
                "Dalton's theory suggested atoms were indivisible, but discoveries of electrons and protons proved otherwise",
                "Scientists proposed various models to explain how electrons and protons are arranged within atoms",
                "Each model built upon previous discoveries, gradually revealing the true nature of atomic structure"
            ]);
            
            narrator = new AtomicNarrator();
            narrator.speak("View reset. Select a model to explore.");
        }

        // Helper Functions
        function updateModelInfo(title, description) {
            document.getElementById('modelTitle').textContent = title;
            document.getElementById('modelDescription').textContent = description;
        }

        function updateDescription(title, points) {
            document.getElementById('descTitle').textContent = title;
            const keyPoints = document.getElementById('keyPoints');
            keyPoints.innerHTML = points.map(point => `<li>${point}</li>`).join('');
        }

        function showProgress(text, percent = 0) {
            const container = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            container.style.display = 'block';
            progressText.textContent = text;
            progressFill.style.width = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Mouse Controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !currentModel) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                currentModel.rotation.y += deltaX * 0.01;
                currentModel.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(15, Math.min(40, camera.position.z));
            });
        }

        // Animation Loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Animate particles based on model
            if (currentModel && particles.length > 0) {
                particles.forEach((particle, i) => {
                    if (particle.userData.originalPos) {
                        // Thomson model - electrons vibrate slightly
                        const time = Date.now() * 0.001;
                        const offset = Math.sin(time * 2 + particle.userData.phase) * 0.1;
                        particle.position.x = particle.userData.originalPos.x + offset * Math.cos(particle.userData.phase);
                        particle.position.y = particle.userData.originalPos.y + offset * Math.sin(particle.userData.phase);
                    } else if (particle.userData.radius) {
                        // Bohr model - circular orbits
                        const time = Date.now() * 0.001;
                        const angle = particle.userData.angle + time * particle.userData.speed;
                        particle.position.x = Math.cos(angle) * particle.userData.radius;
                        particle.position.z = Math.sin(angle) * particle.userData.radius;
                        particle.position.y = 0;
                    } else if (particle.userData.deflectionType) {
                        // Rutherford model - alpha particle trajectories
                        particle.userData.time += particle.userData.speed;
                        const t = particle.userData.time;
                        
                        if (particle.userData.deflectionType === 'straight') {
                            // Most particles pass straight through
                            particle.position.x = particle.userData.startX + t * 20;
                            particle.position.y = particle.userData.yOffset;
                        } else if (particle.userData.deflectionType === 'deflect') {
                            // Some particles deflect slightly
                            particle.position.x = particle.userData.startX + t * 20;
                            particle.position.y = particle.userData.yOffset;
                            if (particle.position.x > -2 && particle.position.x < 2) {
                                particle.position.y += Math.sin(t * 5) * 0.5;
                            }
                        } else if (particle.userData.deflectionType === 'rebound') {
                            // Rare particles rebound
                            if (t < 0.5) {
                                particle.position.x = particle.userData.startX + t * 20;
                            } else {
                                particle.position.x = 0 - (t - 0.5) * 15;
                                particle.position.y = particle.userData.yOffset + (t - 0.5) * 8;
                            }
                        }
                        
                        // Reset particle when it goes off screen
                        if (particle.position.x > 12 || particle.position.x < -12) {
                            particle.position.x = particle.userData.startX;
                            particle.userData.time = 0;
                        }
                        
                        // Update trail
                        if (particle.userData.trail) {
                            particle.userData.trailPositions.push(particle.position.clone());
                            if (particle.userData.trailPositions.length > 20) {
                                particle.userData.trailPositions.shift();
                            }
                            const positions = new Float32Array(particle.userData.trailPositions.length * 3);
                            particle.userData.trailPositions.forEach((pos, i) => {
                                positions[i * 3] = pos.x;
                                positions[i * 3 + 1] = pos.y;
                                positions[i * 3 + 2] = pos.z;
                            });
                            particle.userData.trail.geometry.setAttribute('position', 
                                new THREE.BufferAttribute(positions, 3));
                        }
                    }
                });
            }
            
            // Gentle rotation (except for Rutherford model)
            if (currentModel && !particles.some(p => p.userData.deflectionType)) {
                currentModel.rotation.y += 0.003;
            }
            
            renderer.render(scene, camera);
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && narrator) {
                narrator.stop();
            }
            
            if (narrator) {
                narrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            narrator = new AtomicNarrator();
            narrator.speak("Welcome! Explore the evolution of atomic models from Thomson to Bohr. Select any model to begin.");
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    </script>
</body>
</html>