<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valency and Electronic Configuration - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a40 25%, #2d2d5f 50%, #1a1a40 75%, #0f0f23 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background Stars */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200px 200px;
            opacity: 0.3;
            animation: drift 60s linear infinite;
            pointer-events: none;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-200px, -200px); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(96, 165, 250, 0.5)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 40px rgba(167, 139, 250, 0.7)); }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 40px;
        }

        /* Atomic Stage */
        .atomic-stage {
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.9) 0%,
                rgba(30, 41, 59, 0.9) 50%,
                rgba(15, 23, 42, 0.9) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 100px rgba(96, 165, 250, 0.1);
            overflow: hidden;
            border: 3px solid rgba(96, 165, 250, 0.3);
        }

        #atomCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #atomCanvas:active {
            cursor: grabbing;
        }

        /* Stage States */
        .atomic-stage.losing-state {
            border-color: #fbbf24;
            box-shadow: 0 25px 50px rgba(251, 191, 36, 0.3);
        }

        .atomic-stage.gaining-state {
            border-color: #10b981;
            box-shadow: 0 25px 50px rgba(16, 185, 129, 0.3);
        }

        .atomic-stage.stable-state {
            border-color: #a78bfa;
            box-shadow: 0 25px 50px rgba(167, 139, 250, 0.4);
            animation: stablePulse 2s ease-in-out infinite;
        }

        @keyframes stablePulse {
            0%, 100% { 
                box-shadow: 0 25px 50px rgba(167, 139, 250, 0.4);
            }
            50% { 
                box-shadow: 0 30px 60px rgba(167, 139, 250, 0.6);
            }
        }

        /* Stage Info */
        .stage-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(96, 165, 250, 0.3);
            max-width: 300px;
        }

        .stage-info h3 {
            font-size: 1.2rem;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .stage-info p {
            font-size: 0.9rem;
            color: #e2e8f0;
            line-height: 1.4;
        }

        /* Data Panel */
        .data-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 25px;
            padding: 30px;
            border: 3px solid rgba(96, 165, 250, 0.3);
            backdrop-filter: blur(15px);
        }

        .data-panel h2 {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
        }

        .element-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .element-symbol {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .element-name {
            font-size: 1.3rem;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        /* Electron Configuration Display */
        .electron-config {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .config-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 10px;
        }

        .shell-config {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .shell-display {
            background: rgba(96, 165, 250, 0.1);
            border: 2px solid #60a5fa;
            border-radius: 10px;
            padding: 8px 12px;
            min-width: 40px;
            text-align: center;
        }

        .shell-display.valence {
            border-color: #f472b6;
            background: rgba(244, 114, 182, 0.1);
            animation: valencePulse 2s ease-in-out infinite;
        }

        @keyframes valencePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .shell-label {
            font-size: 0.7rem;
            color: #94a3b8;
            display: block;
        }

        .shell-electrons {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Valency Info */
        .valency-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .valency-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .valency-explanation {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: activePulse 2s ease-in-out infinite;
        }

        @keyframes activePulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Element Grid */
        .element-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .element-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(96, 165, 250, 0.3);
            color: white;
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .element-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: #60a5fa;
            transform: scale(1.05);
        }

        .element-btn.selected {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #60a5fa;
        }

        .element-btn .symbol {
            font-size: 1.2rem;
            font-weight: bold;
            display: block;
        }

        .element-btn .number {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        /* Valency Calculator */
        .calculator-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(96, 165, 250, 0.3);
            backdrop-filter: blur(15px);
            text-align: center;
        }

        .calculator-panel h3 {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .valence-input {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .valence-input input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(96, 165, 250, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1.2rem;
            width: 100px;
            text-align: center;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .calculate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .calculator-result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .data-panel {
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .atomic-stage {
                height: 400px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .element-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">üîä</span>
            <span class="mute-icon">üîá</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Valency & Electronic Configuration</h1>
            <p>Discover how valence electrons determine the combining capacity of atoms</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Atomic Stage -->
            <div class="atomic-stage" id="stage">
                <canvas id="atomCanvas"></canvas>
                
                <div class="stage-info" id="stageInfo">
                    <h3 id="infoTitle">Ready to Begin</h3>
                    <p id="infoText">Select a demonstration to explore valency</p>
                </div>
            </div>

            <!-- Data Panel -->
            <div class="data-panel">
                <h2>‚öõÔ∏è Element Data</h2>
                
                <div class="element-display">
                    <div class="element-symbol" id="elementSymbol">Na</div>
                    <div class="element-name" id="elementName">Sodium</div>
                </div>

                <div class="electron-config">
                    <div class="config-title">Electronic Configuration:</div>
                    <div class="shell-config" id="shellConfig">
                        <div class="shell-display">
                            <span class="shell-label">K</span>
                            <span class="shell-electrons">2</span>
                        </div>
                        <div class="shell-display">
                            <span class="shell-label">L</span>
                            <span class="shell-electrons">8</span>
                        </div>
                        <div class="shell-display valence">
                            <span class="shell-label">M</span>
                            <span class="shell-electrons">1</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span style="color: #f472b6;">Valence Electrons: </span>
                        <span style="font-size: 1.3rem; font-weight: bold;" id="valenceCount">1</span>
                    </div>
                </div>

                <div class="valency-info">
                    <div class="valency-value">Valency: <span id="valencyValue">1</span></div>
                    <div class="valency-explanation" id="valencyExplanation">
                        Loses 1 electron to achieve stable octet
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Explore Valency</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" id="btn-complete" onclick="playCompleteStory()">üìñ Complete Story</button>
                <button class="demo-btn" id="btn-explore" onclick="exploreElements()">üî¨ Explore Elements</button>
                <button class="demo-btn" id="btn-rules" onclick="showValencyRules()">üìã Valency Rules</button>
                <button class="demo-btn" id="btn-calculator" onclick="openCalculator()">üßÆ Valency Calculator</button>
                <button class="demo-btn" id="btn-reset" onclick="resetAll()">üîÑ Reset</button>
            </div>

            <!-- Element Grid -->
            <div class="element-grid" id="elementGrid">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Valency Calculator -->
        <div class="calculator-panel" id="calculatorPanel" style="display: none;">
            <h3>üßÆ Valency Calculator</h3>
            <p>Enter the number of valence electrons to calculate valency:</p>
            <div class="valence-input">
                <label>Valence Electrons:</label>
                <input type="number" id="valenceInput" min="1" max="8" value="1">
                <button class="calculate-btn" onclick="calculateValency()">Calculate</button>
            </div>
            <div class="calculator-result" id="calculatorResult">
                Enter a value and click Calculate
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator" style="display: none;">
        <div class="progress-dot" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
        <div class="progress-dot" data-step="4"></div>
        <div class="progress-dot" data-step="5"></div>
        <div class="progress-dot" data-step="6"></div>
    </div>

    <script>
        // Narrator System
        class ValencyNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
                this.isSpeaking = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        this.isSpeaking = true;
                        utterance.onend = () => {
                            this.isSpeaking = false;
                            resolve();
                        };
                        utterance.onerror = () => {
                            this.isSpeaking = false;
                            resolve();
                        };
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                this.isSpeaking = false;
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State
        let globalAudioEnabled = true;
        let narrator = null;
        let currentElement = 'Na';
        let isAnimating = false;
        let currentActiveButton = null;

        // Three.js variables
        let scene, camera, renderer;
        let atomGroup, nucleus;
        let electrons = [], electronShells = [];
        let transferringElectrons = [];
        let animationId;

        // Element Data (First 18 elements)
        const elements = {
            'H': { symbol: 'H', name: 'Hydrogen', atomicNumber: 1, config: [1], valency: 1, explanation: 'Loses 1 electron or shares to form duplet' },
            'He': { symbol: 'He', name: 'Helium', atomicNumber: 2, config: [2], valency: 0, explanation: 'Stable duplet - chemically inert' },
            'Li': { symbol: 'Li', name: 'Lithium', atomicNumber: 3, config: [2, 1], valency: 1, explanation: 'Loses 1 electron to achieve stable configuration' },
            'Be': { symbol: 'Be', name: 'Beryllium', atomicNumber: 4, config: [2, 2], valency: 2, explanation: 'Loses 2 electrons to achieve stable configuration' },
            'B': { symbol: 'B', name: 'Boron', atomicNumber: 5, config: [2, 3], valency: 3, explanation: 'Loses 3 electrons or shares to achieve stability' },
            'C': { symbol: 'C', name: 'Carbon', atomicNumber: 6, config: [2, 4], valency: 4, explanation: 'Shares 4 electrons to complete octet' },
            'N': { symbol: 'N', name: 'Nitrogen', atomicNumber: 7, config: [2, 5], valency: 3, explanation: 'Gains 3 electrons to complete octet (8-5=3)' },
            'O': { symbol: 'O', name: 'Oxygen', atomicNumber: 8, config: [2, 6], valency: 2, explanation: 'Gains 2 electrons to complete octet (8-6=2)' },
            'F': { symbol: 'F', name: 'Fluorine', atomicNumber: 9, config: [2, 7], valency: 1, explanation: 'Gains 1 electron to complete octet (8-7=1)' },
            'Ne': { symbol: 'Ne', name: 'Neon', atomicNumber: 10, config: [2, 8], valency: 0, explanation: 'Stable octet - chemically inert' },
            'Na': { symbol: 'Na', name: 'Sodium', atomicNumber: 11, config: [2, 8, 1], valency: 1, explanation: 'Loses 1 electron to achieve stable octet' },
            'Mg': { symbol: 'Mg', name: 'Magnesium', atomicNumber: 12, config: [2, 8, 2], valency: 2, explanation: 'Loses 2 electrons to achieve stable octet' },
            'Al': { symbol: 'Al', name: 'Aluminum', atomicNumber: 13, config: [2, 8, 3], valency: 3, explanation: 'Loses 3 electrons to achieve stable octet' },
            'Si': { symbol: 'Si', name: 'Silicon', atomicNumber: 14, config: [2, 8, 4], valency: 4, explanation: 'Shares 4 electrons to complete octet' },
            'P': { symbol: 'P', name: 'Phosphorus', atomicNumber: 15, config: [2, 8, 5], valency: 3, explanation: 'Gains 3 electrons to complete octet (can also be 5)' },
            'S': { symbol: 'S', name: 'Sulphur', atomicNumber: 16, config: [2, 8, 6], valency: 2, explanation: 'Gains 2 electrons to complete octet (8-6=2)' },
            'Cl': { symbol: 'Cl', name: 'Chlorine', atomicNumber: 17, config: [2, 8, 7], valency: 1, explanation: 'Gains 1 electron to complete octet (8-7=1)' },
            'Ar': { symbol: 'Ar', name: 'Argon', atomicNumber: 18, config: [2, 8, 8], valency: 0, explanation: 'Stable octet - chemically inert' }
        };

        // Button management functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        function stopAllAnimations() {
            // Stop current narrator
            if (narrator) {
                narrator.destroy();
                narrator = null;
            }
            
            // Set animation flag to false
            isAnimating = false;
            
            // Hide progress indicator
            hideProgress();
            
            // Remove stage states
            document.getElementById('stage').classList.remove('losing-state', 'gaining-state', 'stable-state');
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('atomCanvas');
            const container = document.getElementById('stage');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = null;
            
            // Camera
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 5, 20);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 0.5);
            pointLight.position.set(-10, -10, -5);
            scene.add(pointLight);
            
            // Create initial atom
            createAtom(currentElement);
            
            // Setup controls
            setupMouseControls();
            
            // Populate element grid
            populateElementGrid();
            
            // Start animation loop
            animate();
        }

        // Create atom model
        function createAtom(elementKey, animated = false) {
            // Clear existing atom
            if (atomGroup) {
                scene.remove(atomGroup);
            }
            
            // Clear transferring electrons
            transferringElectrons.forEach(e => scene.remove(e));
            transferringElectrons = [];
            
            electrons = [];
            electronShells = [];
            
            const element = elements[elementKey];
            if (!element) return;
            
            atomGroup = new THREE.Group();
            
            // Create nucleus
            nucleus = new THREE.Group();
            const nucleusGeometry = new THREE.SphereGeometry(1, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({
                color: 0xff6b6b,
                emissive: 0xff6b6b,
                emissiveIntensity: 0.3
            });
            const nucleusMesh = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            nucleus.add(nucleusMesh);
            atomGroup.add(nucleus);
            
            // Create electron shells
            const shellRadii = [2.5, 4, 5.5, 7];
            const shellNames = ['K', 'L', 'M', 'N'];
            
            element.config.forEach((electronCount, shellIndex) => {
                const shellRadius = shellRadii[shellIndex];
                
                // Shell ring
                const ringGeometry = new THREE.TorusGeometry(shellRadius, 0.05, 8, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0x60a5fa,
                    opacity: 0.3,
                    transparent: true
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                atomGroup.add(ring);
                electronShells.push(ring);
                
                // Add electrons to shell
                for (let i = 0; i < electronCount; i++) {
                    const electronGeometry = new THREE.SphereGeometry(0.15, 32, 32);
                    const isValence = shellIndex === element.config.length - 1;
                    const electronMaterial = new THREE.MeshPhongMaterial({
                        color: isValence ? 0xf472b6 : 0x3b82f6,
                        emissive: isValence ? 0xf472b6 : 0x3b82f6,
                        emissiveIntensity: isValence ? 0.5 : 0.3
                    });
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    
                    const angle = (i / electronCount) * Math.PI * 2;
                    electron.userData = {
                        shellIndex: shellIndex,
                        angle: angle,
                        radius: shellRadius,
                        speed: 1 - shellIndex * 0.2,
                        isValence: isValence
                    };
                    
                    electron.position.x = Math.cos(angle) * shellRadius;
                    electron.position.z = Math.sin(angle) * shellRadius;
                    
                    atomGroup.add(electron);
                    electrons.push(electron);
                    
                    if (animated) {
                        electron.scale.set(0, 0, 0);
                        animateParticleAppear(electron, i * 50 + shellIndex * 200);
                    }
                }
            });
            
            scene.add(atomGroup);
            updateDataPanel(element);
        }

        // Animate particle appearance
        function animateParticleAppear(particle, delay) {
            setTimeout(() => {
                let scale = 0;
                const interval = setInterval(() => {
                    scale += 0.1;
                    if (scale >= 1) {
                        scale = 1;
                        clearInterval(interval);
                    }
                    particle.scale.set(scale, scale, scale);
                }, 20);
            }, delay);
        }

        // Animate electron transfer
        async function animateElectronTransfer(type) {
            return new Promise((resolve) => {
                const element = elements[currentElement];
                const valenceElectrons = electrons.filter(e => e.userData.isValence);
                
                if (type === 'lose' && element.valency > 0 && element.valency <= 3) {
                    // Animate losing electrons
                    let count = 0;
                    valenceElectrons.slice(0, element.valency).forEach((electron, index) => {
                        setTimeout(() => {
                            const transferElectron = electron.clone();
                            transferringElectrons.push(transferElectron);
                            scene.add(transferElectron);
                            electron.visible = false;
                            
                            let progress = 0;
                            const interval = setInterval(() => {
                                progress += 0.02;
                                if (progress >= 1) {
                                    clearInterval(interval);
                                    scene.remove(transferElectron);
                                    count++;
                                    if (count === element.valency) resolve();
                                }
                                
                                transferElectron.position.y += 0.1;
                                transferElectron.position.x *= 1.02;
                                transferElectron.position.z *= 1.02;
                                transferElectron.material.opacity = 1 - progress;
                            }, 16);
                        }, index * 500);
                    });
                } else if (type === 'gain' && element.config[element.config.length - 1] > 4) {
                    // Animate gaining electrons
                    const electronsNeeded = 8 - element.config[element.config.length - 1];
                    for (let i = 0; i < electronsNeeded; i++) {
                        setTimeout(() => {
                            const electronGeometry = new THREE.SphereGeometry(0.15, 32, 32);
                            const electronMaterial = new THREE.MeshPhongMaterial({
                                color: 0x10b981,
                                emissive: 0x10b981,
                                emissiveIntensity: 0.5
                            });
                            const newElectron = new THREE.Mesh(electronGeometry, electronMaterial);
                            
                            newElectron.position.set(
                                Math.random() * 10 - 5,
                                10,
                                Math.random() * 10 - 5
                            );
                            
                            scene.add(newElectron);
                            transferringElectrons.push(newElectron);
                            
                            let progress = 0;
                            const targetRadius = valenceElectrons[0].userData.radius;
                            const targetAngle = Math.PI * 2 * Math.random();
                            
                            const interval = setInterval(() => {
                                progress += 0.02;
                                if (progress >= 1) {
                                    clearInterval(interval);
                                    if (i === electronsNeeded - 1) resolve();
                                }
                                
                                const t = easeInOutCubic(progress);
                                newElectron.position.x = (1 - t) * newElectron.position.x + t * Math.cos(targetAngle) * targetRadius;
                                newElectron.position.y = (1 - t) * newElectron.position.y;
                                newElectron.position.z = (1 - t) * newElectron.position.z + t * Math.sin(targetAngle) * targetRadius;
                            }, 16);
                        }, i * 500);
                    }
                } else {
                    resolve();
                }
            });
        }

        // Update data panel
        function updateDataPanel(element) {
            document.getElementById('elementSymbol').textContent = element.symbol;
            document.getElementById('elementName').textContent = element.name;
            
            // Update electron configuration
            const shellNames = ['K', 'L', 'M', 'N'];
            let configHTML = '';
            element.config.forEach((count, index) => {
                const isValence = index === element.config.length - 1;
                configHTML += `
                    <div class="shell-display ${isValence ? 'valence' : ''}">
                        <span class="shell-label">${shellNames[index]}</span>
                        <span class="shell-electrons">${count}</span>
                    </div>
                `;
            });
            document.getElementById('shellConfig').innerHTML = configHTML;
            
            // Update valence electrons
            const valenceElectrons = element.config[element.config.length - 1];
            document.getElementById('valenceCount').textContent = valenceElectrons;
            
            // Update valency
            document.getElementById('valencyValue').textContent = element.valency;
            document.getElementById('valencyExplanation').textContent = element.explanation;
        }

        // Populate element grid
        function populateElementGrid() {
            const grid = document.getElementById('elementGrid');
            grid.innerHTML = '';
            
            Object.entries(elements).forEach(([key, element]) => {
                const btn = document.createElement('button');
                btn.className = 'element-btn';
                if (key === currentElement) btn.classList.add('selected');
                btn.innerHTML = `
                    <span class="symbol">${element.symbol}</span>
                    <span class="number">${element.atomicNumber}</span>
                `;
                btn.onclick = () => selectElement(key);
                grid.appendChild(btn);
            });
        }

        // Complete Story
        async function playCompleteStory() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-complete');
            
            isAnimating = true;
            narrator = new ValencyNarrator();
            
            showProgress();
            updateTitle("üìñ The Complete Story of Valency");
            
            // Chapter 1: Introduction
            updateProgress(1);
            updateStageInfo("Chapter 1: Valence Electrons", "The outermost shell matters");
            createAtom('Ne', true);
            
            await narrator.speak("Welcome to the world of valency! Let's discover how atoms combine with each other. We'll start with neon, a noble gas.");
            
            if (!isAnimating) return;
            await wait(2000);
            
            await narrator.speak("Notice how neon has 8 electrons in its outermost shell. This is called a stable octet. Atoms with 8 valence electrons are chemically inert.");
            
            if (!isAnimating) return;
            document.getElementById('stage').classList.add('stable-state');
            await wait(3000);
            document.getElementById('stage').classList.remove('stable-state');
            
            // Chapter 2: Valency by Losing
            updateProgress(2);
            updateStageInfo("Chapter 2: Losing Electrons", "Metals tend to lose");
            createAtom('Na', true);
            
            await narrator.speak("Now let's look at sodium. It has 1 electron in its outermost shell. To achieve stability, it will lose this electron.");
            
            if (!isAnimating) return;
            await wait(2000);
            
            document.getElementById('stage').classList.add('losing-state');
            await animateElectronTransfer('lose');
            
            await narrator.speak("Sodium loses 1 electron to achieve a stable octet in its new outermost shell. Therefore, sodium has a valency of 1.");
            
            if (!isAnimating) return;
            await wait(2000);
            document.getElementById('stage').classList.remove('losing-state');
            
            // Chapter 3: More examples of losing
            updateProgress(3);
            updateStageInfo("Chapter 3: Multiple Electrons", "Some lose more than one");
            createAtom('Mg', true);
            
            await narrator.speak("Magnesium has 2 valence electrons. It loses both to achieve stability, giving it a valency of 2.");
            
            if (!isAnimating) return;
            await wait(2000);
            
            createAtom('Al', true);
            await narrator.speak("Aluminum has 3 valence electrons, so its valency is 3. It loses all three to achieve a stable configuration.");
            
            if (!isAnimating) return;
            await wait(3000);
            
            // Chapter 4: Valency by Gaining
            updateProgress(4);
            updateStageInfo("Chapter 4: Gaining Electrons", "Non-metals tend to gain");
            createAtom('F', true);
            
            await narrator.speak("Now let's look at fluorine. It has 7 valence electrons. It's easier to gain 1 electron than to lose 7!");
            
            if (!isAnimating) return;
            await wait(2000);
            
            document.getElementById('stage').classList.add('gaining-state');
            await animateElectronTransfer('gain');
            
            await narrator.speak("Fluorine gains 1 electron to complete its octet. We calculate: 8 minus 7 equals 1. So fluorine's valency is 1.");
            
            if (!isAnimating) return;
            await wait(2000);
            document.getElementById('stage').classList.remove('gaining-state');
            
            // Chapter 5: The 8-x Rule
            updateProgress(5);
            updateStageInfo("Chapter 5: The 8-x Rule", "For elements with many valence electrons");
            createAtom('O', true);
            
            await narrator.speak("Oxygen has 6 valence electrons. Using the 8 minus x rule: 8 minus 6 equals 2. Oxygen's valency is 2.");
            
            if (!isAnimating) return;
            await wait(3000);
            
            // Chapter 6: Summary
            updateProgress(6);
            updateStageInfo("Chapter 6: Summary", "Understanding valency");
            createAtom('C', true);
            
            await narrator.speak("Carbon is special with 4 valence electrons. It can share 4 electrons, giving it a valency of 4. This makes carbon the basis of organic chemistry!");
            
            if (!isAnimating) return;
            await wait(3000);
            
            await narrator.speak("Remember: valency is the combining capacity of an atom, determined by how it achieves a stable electron configuration!");
            
            hideProgress();
            isAnimating = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        // Explore Elements
        async function exploreElements() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-explore');
            
            isAnimating = true;
            updateTitle("üî¨ Exploring Elements");
            updateStageInfo("Interactive Exploration", "Click any element to explore");
            
            narrator = new ValencyNarrator();
            await narrator.speak("Explore any of the first 18 elements! Click on an element to see its electronic configuration and valency.");
            
            document.getElementById('elementGrid').style.display = 'grid';
            isAnimating = false;
        }

        // Show Valency Rules
        async function showValencyRules() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-rules');
            
            isAnimating = true;
            updateTitle("üìã Understanding Valency Rules");
            updateStageInfo("Valency Rules", "How to determine valency");
            
            narrator = new ValencyNarrator();
            
            // Rule 1: Elements with 1-3 electrons
            createAtom('Li', true);
            await narrator.speak("Rule 1: Elements with 1 to 3 valence electrons lose them all. Their valency equals the number of valence electrons.");
            
            if (!isAnimating) return;
            await wait(3000);
            
            // Rule 2: Elements with 5-7 electrons
            createAtom('Cl', true);
            await narrator.speak("Rule 2: Elements with 5 to 7 valence electrons gain electrons. Their valency equals 8 minus the number of valence electrons.");
            
            if (!isAnimating) return;
            await wait(3000);
            
            // Rule 3: Elements with 4 electrons
            createAtom('C', true);
            await narrator.speak("Rule 3: Elements with 4 valence electrons can share. Carbon shares 4 electrons, giving it a valency of 4.");
            
            if (!isAnimating) return;
            await wait(3000);
            
            // Rule 4: Noble gases
            createAtom('Ar', true);
            await narrator.speak("Rule 4: Noble gases have complete octets or duplets. Their valency is zero - they don't react!");
            
            isAnimating = false;
        }

        // Open Calculator
        function openCalculator() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-calculator');
            
            updateTitle("üßÆ Valency Calculator");
            document.getElementById('calculatorPanel').style.display = 'block';
            document.getElementById('elementGrid').style.display = 'none';
            
            narrator = new ValencyNarrator();
            narrator.speak("Use the calculator to determine valency based on the number of valence electrons!");
        }

        // Calculate Valency
        function calculateValency() {
            const valenceElectrons = parseInt(document.getElementById('valenceInput').value);
            const resultDiv = document.getElementById('calculatorResult');
            
            let valency, explanation;
            
            if (valenceElectrons <= 0 || valenceElectrons > 8) {
                resultDiv.innerHTML = '<p style="color: #ef4444;">Please enter a number between 1 and 8</p>';
                return;
            }
            
            if (valenceElectrons <= 3) {
                valency = valenceElectrons;
                explanation = `With ${valenceElectrons} valence electron${valenceElectrons > 1 ? 's' : ''}, the atom loses ${valenceElectrons > 1 ? 'them' : 'it'} to achieve stability.`;
            } else if (valenceElectrons === 4) {
                valency = 4;
                explanation = 'With 4 valence electrons, the atom typically shares all 4 to complete its octet.';
            } else if (valenceElectrons < 8) {
                valency = 8 - valenceElectrons;
                explanation = `With ${valenceElectrons} valence electrons, the atom gains ${8 - valenceElectrons} electron${(8 - valenceElectrons) > 1 ? 's' : ''} to complete its octet.`;
            } else {
                valency = 0;
                explanation = 'With 8 valence electrons (complete octet), the atom is stable and chemically inert.';
            }
            
            resultDiv.innerHTML = `
                <div>
                    <div style="font-size: 2rem; color: #60a5fa; margin-bottom: 10px;">
                        Valency: ${valency}
                    </div>
                    <div style="font-size: 1rem; color: #e2e8f0;">
                        ${explanation}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;">
                        Formula: ${valenceElectrons <= 4 ? `Valency = ${valenceElectrons}` : `Valency = 8 - ${valenceElectrons} = ${valency}`}
                    </div>
                </div>
            `;
            
            if (narrator) narrator.destroy();
            narrator = new ValencyNarrator();
            narrator.speak(`The valency is ${valency}. ${explanation}`);
        }

        // Helper Functions
        function selectElement(elementKey) {
            currentElement = elementKey;
            createAtom(elementKey, true);
            
            document.querySelectorAll('.element-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.element-btn').classList.add('selected');
            
            const element = elements[elementKey];
            
            if (narrator) narrator.destroy();
            narrator = new ValencyNarrator();
            narrator.speak(`${element.name}: ${element.config[element.config.length - 1]} valence electrons, valency ${element.valency}. ${element.explanation}`);
        }

        function resetAll() {
            // Stop all animations
            stopAllAnimations();
            
            // Remove active button state
            setActiveButton(null);
            
            createAtom('Na', false);
            updateTitle("Explore Valency");
            updateStageInfo("Ready to Begin", "Select a demonstration to explore valency");
            document.getElementById('calculatorPanel').style.display = 'none';
            document.getElementById('elementGrid').style.display = 'grid';
            hideProgress();
            document.getElementById('stage').classList.remove('losing-state', 'gaining-state', 'stable-state');
        }

        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateStageInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function showProgress() {
            document.getElementById('progressIndicator').style.display = 'flex';
        }

        function hideProgress() {
            document.getElementById('progressIndicator').style.display = 'none';
        }

        function updateProgress(step) {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === step - 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // Setup mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                if (atomGroup) {
                    atomGroup.rotation.y += deltaX * 0.01;
                    atomGroup.rotation.x += deltaY * 0.01;
                }
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(10, Math.min(40, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Rotate nucleus slowly
            if (nucleus) {
                nucleus.rotation.y += 0.005;
                nucleus.rotation.x += 0.003;
            }
            
            // Animate electrons
            electrons.forEach(electron => {
                if (electron.visible && electron.userData) {
                    const userData = electron.userData;
                    const time = Date.now() * 0.001;
                    const angle = userData.angle + time * userData.speed;
                    electron.position.x = Math.cos(angle) * userData.radius;
                    electron.position.z = Math.sin(angle) * userData.radius;
                    
                    // Pulse valence electrons
                    if (userData.isValence) {
                        const scale = 1 + Math.sin(time * 3) * 0.1;
                        electron.scale.set(scale, scale, scale);
                    }
                }
            });
            
            renderer.render(scene, camera);
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (narrator) {
                narrator.isEnabled = globalAudioEnabled;
                if (!globalAudioEnabled) {
                    narrator.stop();
                }
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            narrator = new ValencyNarrator();
            narrator.speak("Welcome to Valency and Electronic Configuration! Discover how valence electrons determine the combining capacity of atoms. Select a demonstration to begin!");
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>