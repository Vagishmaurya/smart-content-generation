<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery of Charged Particles in Atoms - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 25%, #2d3561 50%, #1a1f3a 75%, #0a0e27 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Starry Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255,255,255,0.7), transparent),
                radial-gradient(2px 2px at 10% 80%, rgba(255,255,255,0.5), transparent);
            background-size: 300px 300px;
            opacity: 0.4;
            animation: stardrift 120s linear infinite;
            pointer-events: none;
        }

        @keyframes stardrift {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-300px, -300px) rotate(360deg); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #00d4ff, #7a5cff, #ff6ec7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 0 40px rgba(0, 212, 255, 0.3);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { 
                filter: brightness(1) drop-shadow(0 0 20px rgba(122, 92, 255, 0.5)); 
            }
            50% { 
                filter: brightness(1.2) drop-shadow(0 0 40px rgba(0, 212, 255, 0.7)); 
            }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
            color: #c3d1f0;
        }

        /* 3D Canvas Stage */
        .canvas-stage {
            background: linear-gradient(135deg, 
                rgba(10, 14, 39, 0.95) 0%,
                rgba(26, 31, 58, 0.95) 50%,
                rgba(10, 14, 39, 0.95) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            margin: 40px 0;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 120px rgba(122, 92, 255, 0.2);
            overflow: hidden;
            border: 3px solid rgba(102, 126, 234, 0.4);
        }

        #atomCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #atomCanvas:active {
            cursor: grabbing;
        }

        /* Info Box Overlay */
        .info-box {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            max-width: 350px;
            transition: all 0.3s ease;
        }

        .info-box h3 {
            font-size: 1.3rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .info-box p {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Text Content Panel */
        .content-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.7),
                rgba(26, 31, 58, 0.7));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(15px);
        }

        .content-title {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .content-text {
            font-size: 1.1rem;
            color: #e2e8f0;
            line-height: 1.8;
            text-align: justify;
        }

        /* Question Box */
        .question-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .question-box h4 {
            color: #a5b4fc;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .question-box p {
            color: #e2e8f0;
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Particle Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.4);
        }

        .legend-title {
            font-size: 1rem;
            color: #a5b4fc;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .canvas-stage {
                height: 400px;
            }
            
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Structure of the Atom</h1>
            <p>Discovering Charged Particles: The Journey from Dalton's Indivisible Atom to Modern Understanding</p>
        </div>

        <!-- 3D Canvas Stage -->
        <div class="canvas-stage" id="stage">
            <canvas id="atomCanvas"></canvas>
            
            <div class="info-box" id="infoBox">
                <h3 id="infoTitle">Welcome to Atomic Discovery</h3>
                <p id="infoText">Press "Start Demo" to begin exploring how scientists discovered that atoms contain charged particles.</p>
            </div>
            
            <div class="legend">
                <div class="legend-title">Particle Colors</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span class="legend-label">Proton (p⁺)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4444ff;"></div>
                        <span class="legend-label">Electron (e⁻)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="controls">
            <div class="nav-buttons">
                <button class="nav-btn" id="btn-complete" onclick="playCompleteStory()">📖 Complete Story</button>
                <button class="nav-btn" id="btn-dalton" onclick="showDaltonAtom()">⚫ Dalton's Atom</button>
                <button class="nav-btn" id="btn-canal" onclick="showCanalRays()">⚡ Canal Rays</button>
                <button class="nav-btn" id="btn-composition" onclick="showAtomComposition()">⚛️ Atom Composition</button>
                <button class="nav-btn" id="btn-reset" onclick="resetScene()">🔄 Reset</button>
            </div>
        </div>

        <!-- Content Panel -->
        <div class="content-panel">
            <div class="content-title">📚 Understanding Charged Particles in Atoms</div>
            <div class="content-text" id="contentText">
                <h4 style="color: #a5b4fc; margin-bottom: 15px;">Key Concepts Summary</h4>
                
                <div style="margin-bottom: 20px;">
                    <strong style="color: #60a5fa;">The Journey from Indivisible to Divisible:</strong>
                    <p>Dalton's atomic theory proposed that atoms were solid, indivisible particles. However, experiments with static electricity revealed that atoms actually contain smaller charged particles that can be transferred between objects.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <strong style="color: #60a5fa;">Discovery of Sub-Atomic Particles:</strong>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Electrons (e⁻):</strong> Discovered by J.J. Thomson in 1897. These negatively charged particles have negligible mass and can be easily removed from atoms.</li>
                        <li><strong>Protons (p⁺):</strong> Discovered through Goldstein's canal ray experiments in 1886. These positively charged particles have approximately 2000 times the mass of an electron.</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <strong style="color: #60a5fa;">Modern Understanding:</strong>
                    <p>Atoms consist of a dense nucleus containing protons, surrounded by electrons in orbital shells. The positive charges of protons balance the negative charges of electrons, making atoms electrically neutral overall.</p>
                </div>
            </div>

            <div class="question-box">
                <h4>Quick Facts to Remember:</h4>
                <p>• Static electricity demonstrates electron transfer between atoms</p>
                <p>• Canal rays are streams of positive particles (protons) in gas discharge tubes</p>
                <p>• Atoms with equal protons and electrons have no net charge</p>
                <p>• Electrons can be removed from atoms more easily than protons</p>
            </div>
        </div>
    </div>

    <script>
        // Narrator Class
        class AtomicNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
                this.isSpeaking = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        this.isSpeaking = true;
                        utterance.onend = () => {
                            this.isSpeaking = false;
                            resolve();
                        };
                        utterance.onerror = () => {
                            this.isSpeaking = false;
                            resolve();
                        };
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                this.isSpeaking = false;
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let currentScene = 0;
        let isPlaying = false;
        let currentActiveButton = null;

        // Three.js variables
        let scene, camera, renderer;
        let daltonAtom, modernAtom, gasTube, particles = [];
        let animationId;
        let electronCloud, nucleus;
        let canalRayAnimation = null;
        let cathodeRayAnimation = null;

        // Scene Management
        const scenes = [
            { 
                title: "Dalton's Atom vs Reality",
                label: "Introduction",
                content: "Dalton proposed atoms were indivisible and indestructible. But experiments with electricity revealed otherwise..."
            },
            { 
                title: "Discovery of Charged Particles", 
                label: "Canal Rays & Electrons",
                content: "E. Goldstein discovered canal rays (positive particles) in 1886. J.J. Thomson identified electrons (negative particles) in 1897."
            },
            { 
                title: "The Atom's Composition",
                label: "Modern Understanding",
                content: "Atoms contain protons (p⁺) in the nucleus and electrons (e⁻) in outer regions, mutually balancing their charges."
            }
        ];

        // Button management functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        function stopAllAnimations() {
            // Stop current narrator
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            // Clear interval animations
            if (canalRayAnimation) {
                clearInterval(canalRayAnimation);
                canalRayAnimation = null;
            }
            if (cathodeRayAnimation) {
                clearInterval(cathodeRayAnimation);
                cathodeRayAnimation = null;
            }
            
            // Set playing flag to false
            isPlaying = false;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('atomCanvas');
            const container = document.getElementById('stage');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = null;
            
            // Camera
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 0, 15);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x667eea, 0.5);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            // Setup controls
            setupMouseControls();
            
            // Start with introduction scene
            createIntroductionScene();
            
            // Start animation loop
            animate();
        }

        // Scene 1: Introduction - Dalton's Atom
        function createIntroductionScene() {
            clearScene();
            
            // Create Dalton's indivisible atom (solid sphere)
            daltonAtom = new THREE.Group();
            
            const sphereGeometry = new THREE.SphereGeometry(3, 32, 32);
            const sphereMaterial = new THREE.MeshPhongMaterial({
                color: 0x888888,
                emissive: 0x444444,
                emissiveIntensity: 0.3,
                opacity: 0.9,
                transparent: true
            });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            daltonAtom.add(sphere);
            
            // Add label
            const labelGeometry = new THREE.PlaneGeometry(4, 1);
            const labelCanvas = createTextTexture("Dalton's Atom", 256, 64);
            const labelTexture = new THREE.CanvasTexture(labelCanvas);
            const labelMaterial = new THREE.MeshBasicMaterial({
                map: labelTexture,
                transparent: true
            });
            const label = new THREE.Mesh(labelGeometry, labelMaterial);
            label.position.y = -5;
            daltonAtom.add(label);
            
            daltonAtom.position.set(0, 0, 0);
            scene.add(daltonAtom);
            
            // Add subtle pulsing animation
            daltonAtom.userData.pulse = 0;
        }

        // Scene 2: Canal Ray Experiment
        function createCanalRayScene() {
            clearScene();
            
            // Create gas discharge tube
            gasTube = new THREE.Group();
            
            // Tube cylinder
            const tubeGeometry = new THREE.CylinderGeometry(2, 2, 12, 32, 1, true);
            const tubeMaterial = new THREE.MeshPhongMaterial({
                color: 0x333366,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const tube = new THREE.Mesh(tubeGeometry, tubeMaterial);
            tube.rotation.z = Math.PI / 2;
            gasTube.add(tube);
            
            // Cathode (negative plate)
            const cathodeGeometry = new THREE.BoxGeometry(0.2, 3, 3);
            const cathodeMaterial = new THREE.MeshPhongMaterial({
                color: 0x0000ff,
                emissive: 0x0000ff,
                emissiveIntensity: 0.5
            });
            const cathode = new THREE.Mesh(cathodeGeometry, cathodeMaterial);
            cathode.position.x = -6;
            gasTube.add(cathode);
            
            // Anode (positive plate)
            const anodeGeometry = new THREE.BoxGeometry(0.2, 3, 3);
            const anodeMaterial = new THREE.MeshPhongMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 0.5
            });
            const anode = new THREE.Mesh(anodeGeometry, anodeMaterial);
            anode.position.x = 6;
            gasTube.add(anode);
            
            // Labels
            const cathodeLabelCanvas = createTextTexture("Cathode (-)", 128, 32);
            const cathodeLabelTexture = new THREE.CanvasTexture(cathodeLabelCanvas);
            const cathodeLabelMaterial = new THREE.MeshBasicMaterial({
                map: cathodeLabelTexture,
                transparent: true
            });
            const cathodeLabel = new THREE.Mesh(new THREE.PlaneGeometry(2, 0.5), cathodeLabelMaterial);
            cathodeLabel.position.set(-6, -3, 0);
            gasTube.add(cathodeLabel);
            
            const anodeLabelCanvas = createTextTexture("Anode (+)", 128, 32);
            const anodeLabelTexture = new THREE.CanvasTexture(anodeLabelCanvas);
            const anodeLabelMaterial = new THREE.MeshBasicMaterial({
                map: anodeLabelTexture,
                transparent: true
            });
            const anodeLabel = new THREE.Mesh(new THREE.PlaneGeometry(2, 0.5), anodeLabelMaterial);
            anodeLabel.position.set(6, -3, 0);
            gasTube.add(anodeLabel);
            
            scene.add(gasTube);
            
            // Start particle animations
            startCanalRayAnimation();
            startCathodeRayAnimation();
        }

        // Scene 3: Modern Atom Composition
        function createModernAtomScene() {
            clearScene();
            
            modernAtom = new THREE.Group();
            
            // Nucleus with protons
            nucleus = new THREE.Group();
            const protonCount = 3;
            for (let i = 0; i < protonCount; i++) {
                const protonGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                const protonMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff4444,
                    emissive: 0xff4444,
                    emissiveIntensity: 0.3
                });
                const proton = new THREE.Mesh(protonGeometry, protonMaterial);
                
                const angle = (i / protonCount) * Math.PI * 2;
                proton.position.x = Math.cos(angle) * 0.5;
                proton.position.y = Math.sin(angle) * 0.5;
                proton.position.z = (Math.random() - 0.5) * 0.5;
                
                nucleus.add(proton);
            }
            modernAtom.add(nucleus);
            
            // Electron shells
            const shellRadii = [2, 3.5, 5];
            electronCloud = new THREE.Group();
            
            shellRadii.forEach((radius, shellIndex) => {
                // Shell ring
                const ringGeometry = new THREE.TorusGeometry(radius, 0.05, 8, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0x4444ff,
                    opacity: 0.3,
                    transparent: true
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                electronCloud.add(ring);
                
                // Electrons on shell
                const electronCount = shellIndex === 0 ? 2 : 1;
                for (let i = 0; i < electronCount; i++) {
                    const electronGeometry = new THREE.SphereGeometry(0.15, 16, 16);
                    const electronMaterial = new THREE.MeshPhongMaterial({
                        color: 0x4444ff,
                        emissive: 0x4444ff,
                        emissiveIntensity: 0.5
                    });
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    
                    const angle = (i / electronCount) * Math.PI * 2;
                    electron.position.x = Math.cos(angle) * radius;
                    electron.position.z = Math.sin(angle) * radius;
                    
                    electron.userData = {
                        angle: angle,
                        radius: radius,
                        speed: 1 - shellIndex * 0.2
                    };
                    
                    electronCloud.add(electron);
                    particles.push(electron);
                }
            });
            
            modernAtom.add(electronCloud);
            scene.add(modernAtom);
        }

        // Particle Animation for Canal Rays
        function startCanalRayAnimation() {
            if (canalRayAnimation) clearInterval(canalRayAnimation);
            
            canalRayAnimation = setInterval(() => {
                if (!gasTube) return;
                
                const proton = new THREE.Mesh(
                    new THREE.SphereGeometry(0.1, 16, 16),
                    new THREE.MeshPhongMaterial({
                        color: 0xff4444,
                        emissive: 0xff4444,
                        emissiveIntensity: 0.8
                    })
                );
                
                proton.position.set(4, (Math.random() - 0.5) * 1.5, (Math.random() - 0.5) * 1.5);
                gasTube.add(proton);
                
                const animateProton = () => {
                    if (!gasTube || !proton.parent) return;
                    proton.position.x -= 0.1;
                    if (proton.position.x < -6) {
                        gasTube.remove(proton);
                    } else {
                        requestAnimationFrame(animateProton);
                    }
                };
                animateProton();
            }, 500);
        }

        // Particle Animation for Cathode Rays
        function startCathodeRayAnimation() {
            if (cathodeRayAnimation) clearInterval(cathodeRayAnimation);
            
            cathodeRayAnimation = setInterval(() => {
                if (!gasTube) return;
                
                const electron = new THREE.Mesh(
                    new THREE.SphereGeometry(0.08, 16, 16),
                    new THREE.MeshPhongMaterial({
                        color: 0x4444ff,
                        emissive: 0x4444ff,
                        emissiveIntensity: 0.8
                    })
                );
                
                electron.position.set(-4, (Math.random() - 0.5) * 1.5, (Math.random() - 0.5) * 1.5);
                gasTube.add(electron);
                
                const animateElectron = () => {
                    if (!gasTube || !electron.parent) return;
                    electron.position.x += 0.12;
                    if (electron.position.x > 6) {
                        gasTube.remove(electron);
                    } else {
                        requestAnimationFrame(animateElectron);
                    }
                };
                animateElectron();
            }, 400);
        }

        // Clear Scene
        function clearScene() {
            while(scene.children.length > 2) { 
                const child = scene.children[2];
                scene.remove(child);
            }
            particles = [];
            
            if (canalRayAnimation) {
                clearInterval(canalRayAnimation);
                canalRayAnimation = null;
            }
            if (cathodeRayAnimation) {
                clearInterval(cathodeRayAnimation);
                cathodeRayAnimation = null;
            }
        }

        // Create Text Texture
        function createTextTexture(text, width = 256, height = 64) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const context = canvas.getContext('2d');
            
            context.fillStyle = 'transparent';
            context.fillRect(0, 0, width, height);
            
            context.font = `bold ${height/2}px Arial`;
            context.fillStyle = '#ffffff';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, width/2, height/2);
            
            return canvas;
        }

        // Setup Mouse Controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                if (scene.children[2]) {
                    scene.children[2].rotation.y += deltaX * 0.01;
                    scene.children[2].rotation.x += deltaY * 0.01;
                }
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(5, Math.min(25, camera.position.z));
            });
        }

        // Animation Loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Animate Dalton's atom pulse
            if (daltonAtom) {
                daltonAtom.userData.pulse += 0.02;
                const scale = 1 + Math.sin(daltonAtom.userData.pulse) * 0.05;
                daltonAtom.scale.set(scale, scale, scale);
                daltonAtom.rotation.y += 0.005;
            }
            
            // Animate modern atom electrons
            if (modernAtom && particles.length > 0) {
                particles.forEach(electron => {
                    const time = Date.now() * 0.001;
                    const angle = electron.userData.angle + time * electron.userData.speed;
                    electron.position.x = Math.cos(angle) * electron.userData.radius;
                    electron.position.z = Math.sin(angle) * electron.userData.radius;
                });
                
                modernAtom.rotation.y += 0.003;
            }
            
            // Rotate gas tube
            if (gasTube) {
                gasTube.rotation.y += 0.002;
            }
            
            renderer.render(scene, camera);
        }

        // Demo Control Functions
        async function playCompleteStory() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-complete');
            
            isPlaying = true;
            currentNarrator = new AtomicNarrator();
            
            // Scene 1: Dalton's Atom
            currentScene = 0;
            updateScene();
            await currentNarrator.speak("Our story begins with John Dalton's atomic theory, which proposed that atoms were solid, indivisible spheres.");
            
            if (!isPlaying) return; // Check if stopped
            await wait(2000);
            
            await currentNarrator.speak("But experiments with static electricity, like combing hair or rubbing objects together, suggested atoms contained charged particles.");
            
            if (!isPlaying) return;
            await wait(3000);
            
            // Scene 2: Canal Rays
            currentScene = 1;
            updateScene();
            await wait(1000);
            await currentNarrator.speak("In 1886, Goldstein discovered canal rays - positive particles streaming toward the cathode in gas discharge tubes.");
            
            if (!isPlaying) return;
            await wait(3000);
            
            await currentNarrator.speak("J.J. Thomson later identified electrons - negative particles with negligible mass moving toward the positive electrode.");
            
            if (!isPlaying) return;
            await wait(3000);
            
            // Scene 3: Modern Atom
            currentScene = 2;
            updateScene();
            await wait(1000);
            await currentNarrator.speak("We now understand that atoms contain a nucleus with positive protons, surrounded by negative electrons in orbital shells.");
            
            if (!isPlaying) return;
            await wait(3000);
            
            await currentNarrator.speak("These particles balance each other's charges, making atoms electrically neutral. This discovery revolutionized our understanding of matter!");
            
            isPlaying = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function showDaltonAtom() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-dalton');
            
            isPlaying = true;
            currentScene = 0;
            updateScene();
            
            currentNarrator = new AtomicNarrator();
            await currentNarrator.speak("Dalton's model: atoms as solid, indivisible spheres. This model couldn't explain electrical phenomena or why objects become charged when rubbed together.");
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showCanalRays() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-canal');
            
            isPlaying = true;
            currentScene = 1;
            updateScene();
            
            currentNarrator = new AtomicNarrator();
            await currentNarrator.speak("Watch the gas discharge tube experiment. Red particles are positive protons moving toward the negative cathode. Blue particles are negative electrons moving toward the positive anode.");
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showAtomComposition() {
            // Stop any current animations/narration
            stopAllAnimations();
            
            // Set active button
            setActiveButton('btn-composition');
            
            isPlaying = true;
            currentScene = 2;
            updateScene();
            
            currentNarrator = new AtomicNarrator();
            await currentNarrator.speak("The modern atom: a dense nucleus containing protons, with electrons orbiting in shells. The number of protons determines the element's identity.");
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        function resetScene() {
            // Stop all animations
            stopAllAnimations();
            
            // Remove active button state
            setActiveButton(null);
            
            currentScene = 0;
            createIntroductionScene();
            document.getElementById('infoTitle').textContent = "Welcome to Atomic Discovery";
            document.getElementById('infoText').textContent = "Select a demonstration to explore how scientists discovered that atoms contain charged particles.";
        }

        function updateScene() {
            const sceneData = scenes[currentScene];
            
            // Update info box
            document.getElementById('infoTitle').textContent = sceneData.title;
            document.getElementById('infoText').textContent = sceneData.content;
            
            // Load appropriate 3D scene
            switch(currentScene) {
                case 0:
                    createIntroductionScene();
                    break;
                case 1:
                    createCanalRayScene();
                    break;
                case 2:
                    createModernAtomScene();
                    break;
            }
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentNarrator) {
                currentNarrator.stop();
            }
            
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        function initialize() {
            initThreeJS();
            const narrator = new AtomicNarrator();
            narrator.speak("Welcome to the Structure of the Atom! Press Start Demo to begin exploring how scientists discovered charged particles within atoms.");
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>