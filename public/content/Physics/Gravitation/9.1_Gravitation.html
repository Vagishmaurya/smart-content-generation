<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Law of Gravitation - Physics in Motion</title>
    <!-- GSAP for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: rgba(147, 51, 234, 0.9);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: rgba(147, 51, 234, 1);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #9333ea, #c084fc, #f9a8d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Demo Stage */
        .demo-stage {
            background: linear-gradient(to bottom, #1a1a2e, #16213e, #0f3460);
            border-radius: 25px;
            min-height: 500px;
            position: relative;
            margin: 40px 0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 3px solid rgba(147, 51, 234, 0.4);
            padding: 40px;
        }

        /* Newton's Apple Demo */
        .apple-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 400px;
        }

        .apple-demo.active {
            display: block;
        }

        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, #4a5f3a, #2d3d22);
            border-top: 3px solid #3a4f2a;
        }

        .ground::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: repeating-linear-gradient(
                90deg,
                #5a7f3a 0px,
                #5a7f3a 3px,
                #4a6f2a 3px,
                #4a6f2a 6px
            );
            opacity: 0.6;
        }

        .tree {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            height: 300px;
        }

        .tree-trunk {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 120px;
            background: linear-gradient(to bottom, #8b4513, #654321);
            border-radius: 0 0 5px 5px;
        }

        .tree-leaves {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 180px;
            background: radial-gradient(ellipse, #228b22, #006400);
            border-radius: 50% 50% 45% 45%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .apple {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #dc143c);
            border-radius: 50% 50% 60% 60%;
            top: 60px;
            left: calc(50% - 30px);
            transform: translateX(-50%);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .newton {
            position: absolute;
            bottom: 80px;
            left: calc(50% - 50px);
            transform: translateX(-50%);
            font-size: 80px;
        }

        .thought-bubble {
            position: absolute;
            top: 30px;
            left: 20%;
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 20px;
            max-width: 250px;
            opacity: 0;
            transform: scale(0.8);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .thought-bubble::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: 50px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 20px solid white;
        }

        /* Circular Motion Demo */
        .circular-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 400px;
        }

        .circular-demo.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circular-path {
            position: relative;
            width: 300px;
            height: 300px;
            border: 2px dashed rgba(147, 51, 234, 0.5);
            border-radius: 50%;
        }

        .center-point {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .stone {
            position: absolute;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-radius: 50%;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .thread {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150px;
            height: 2px;
            background: #9ca3af;
            transform-origin: left center;
            transform: translateY(-50%);
        }

        .velocity-arrow {
            position: absolute;
            width: 60px;
            height: 3px;
            background: #ef4444;
            opacity: 0;
            transform-origin: left center;
        }

        .velocity-arrow::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 10px solid #ef4444;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .force-arrow-center {
            position: absolute;
            color: #10b981;
            font-size: 30px;
            opacity: 0;
        }

        /* Earth-Moon System */
        .earth-moon-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 400px;
        }

        .earth-moon-demo.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earth {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle at 30% 30%, #4fc3f7, #1976d2);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(79, 195, 247, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            z-index: 5;
        }

        .moon-orbit {
            position: absolute;
            width: 350px;
            height: 350px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .moon {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #e0e0e0, #9e9e9e);
            border-radius: 50%;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 20px rgba(224, 224, 224, 0.5);
            z-index: 10;
        }

        .moon-velocity-arrow {
            position: absolute;
            width: 70px;
            height: 4px;
            background: #ef4444;
            opacity: 0;
            transform-origin: left center;
            z-index: 8;
        }

        .moon-velocity-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -5px;
            width: 0;
            height: 0;
            border-left: 12px solid #ef4444;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        .moon-centripetal-arrow {
            position: absolute;
            width: 60px;
            height: 4px;
            background: #10b981;
            opacity: 0;
            transform-origin: right center; /* Changed to right so arrow points inward */
            z-index: 8;
        }

        .moon-centripetal-arrow::after {
            content: '';
            position: absolute;
            left: -10px; /* Changed to left side for inward pointing */
            top: -5px;
            width: 0;
            height: 0;
            border-right: 12px solid #10b981; /* Changed border direction */
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        .vector-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            z-index: 9;
        }

        .velocity-label {
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .centripetal-label {
            color: #10b981;
            border: 1px solid #10b981;
        }

        .gravitational-field {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, 
                rgba(147, 51, 234, 0.1) 0%, 
                rgba(147, 51, 234, 0.05) 30%, 
                transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Force Calculation Demo */
        .calculation-demo {
            display: none;
            padding: 30px;
        }

        .calculation-demo.active {
            display: block;
        }

        .objects-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
        }

        .object-box {
            text-align: center;
            padding: 20px;
            background: rgba(147, 51, 234, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(147, 51, 234, 0.5);
        }

        .object-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .mass-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px;
            border-radius: 5px;
            width: 120px;
            text-align: center;
            font-size: 1rem;
            margin-top: 10px;
        }

        .distance-container {
            text-align: center;
            margin: 30px 0;
        }

        .distance-slider {
            width: 300px;
            margin: 10px auto;
        }

        .formula-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .formula {
            font-size: 1.5rem;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .result {
            font-size: 1.3rem;
            color: #10b981;
            font-weight: bold;
            margin-top: 15px;
        }

        .force-visualization {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .force-line {
            flex: 1;
            height: 3px;
            background: linear-gradient(to right, #ef4444, #fbbf24, #ef4444);
            position: relative;
        }

        .force-arrow-left,
        .force-arrow-right {
            color: #ef4444;
            font-size: 30px;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #9333ea;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.3);
            min-width: 150px;
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(147, 51, 234, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Theory Section */
        .theory-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(147, 51, 234, 0.4);
            backdrop-filter: blur(15px);
        }

        .law-statement {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(192, 132, 252, 0.15));
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #9333ea;
        }

        .law-title {
            font-size: 1.4rem;
            color: #c084fc;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .law-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #e2e8f0;
        }

        .formula-box {
            background: rgba(251, 191, 36, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid rgba(251, 191, 36, 0.3);
        }

        .main-equation {
            font-size: 2rem;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .activity-card {
            background: rgba(16, 185, 129, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #10b981;
        }

        .activity-title {
            color: #10b981;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .activity-steps {
            list-style: none;
            padding: 0;
        }

        .activity-steps li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .activity-steps li:before {
            content: '•';
            position: absolute;
            left: 0;
            color: #10b981;
            font-size: 1.2rem;
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .card-title {
            font-size: 1.2rem;
            color: #c084fc;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }

        .card-content {
            font-size: 1rem;
            line-height: 1.6;
            opacity: 0.9;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 2.2rem; }
            .demo-stage { padding: 30px 20px; }
            .demo-buttons { flex-direction: column; align-items: center; }
            .info-cards { grid-template-columns: 1fr; }
            .main-equation { font-size: 1.5rem; }
        }

        @media (max-width: 480px) {
            .container { padding: 20px 15px; }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 1rem; }
            .demo-stage { padding: 20px 15px; }
            .theory-section { padding: 20px; }
            .main-equation { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Universal Law of Gravitation</h1>
            <p>Explore how Newton discovered that every object in the universe attracts every other object, from falling apples to orbiting moons.</p>
        </div>

        <!-- Demo Stage -->
        <div class="demo-stage" id="stage">
            <!-- Newton's Apple Demo -->
            <div class="apple-demo" id="apple-demo">
                <div class="ground"></div>
                <div class="tree">
                    <div class="tree-trunk"></div>
                    <div class="tree-leaves"></div>
                </div>
                <div class="apple" id="apple"></div>
                <div class="newton" id="newton">🧑‍🔬</div>
                <div class="thought-bubble" id="thought">
                    "If Earth attracts the apple, does it also attract the Moon?"
                </div>
            </div>

            <!-- Circular Motion Demo -->
            <div class="circular-demo" id="circular-demo">
                <div class="circular-path" id="circular-path">
                    <div class="center-point"></div>
                    <div class="thread" id="thread"></div>
                    <div class="stone" id="stone"></div>
                </div>
                <!-- Vectors outside circular-path to prevent inheritance of rotation -->
                <div class="velocity-arrow" id="velocity-arrow"></div>
                <div class="force-arrow-center" id="centripetal-force">→</div>
            </div>

            <!-- Earth-Moon System -->
            <div class="earth-moon-demo" id="earth-moon-demo">
                <div class="gravitational-field"></div>
                <div class="earth">🌍</div>
                <div class="moon-orbit" id="moon-orbit">
                    <div class="moon" id="moon">🌙</div>
                </div>
                <!-- Vectors outside orbit container to prevent double rotation -->
                <div class="moon-velocity-arrow" id="moon-velocity"></div>
                <div class="moon-centripetal-arrow" id="moon-centripetal"></div>
                <div class="vector-label velocity-label" id="velocity-label">Tangential Velocity</div>
                <div class="vector-label centripetal-label" id="centripetal-label">Gravitational Force<br>(Centripetal)</div>
            </div>

            <!-- Force Calculation Demo -->
            <div class="calculation-demo" id="calculation-demo">
                <div class="objects-container">
                    <div class="object-box">
                        <div class="object-icon">🌍</div>
                        <div>Object A</div>
                        <input type="number" class="mass-input" id="mass1" value="100" min="1" max="1000">
                        <div style="margin-top: 5px; font-size: 0.9rem;">Mass (kg)</div>
                    </div>
                    <div class="force-visualization">
                        <span class="force-arrow-left">←</span>
                        <div class="force-line"></div>
                        <span class="force-arrow-right">→</span>
                    </div>
                    <div class="object-box">
                        <div class="object-icon">🌑</div>
                        <div>Object B</div>
                        <input type="number" class="mass-input" id="mass2" value="50" min="1" max="1000">
                        <div style="margin-top: 5px; font-size: 0.9rem;">Mass (kg)</div>
                    </div>
                </div>
                <div class="distance-container">
                    <label>Distance: <span id="distance-value">10</span> m</label>
                    <input type="range" class="distance-slider" id="distance" min="1" max="50" value="10">
                </div>
                <div class="formula-display">
                    <div class="formula">F = G × (M × m) / d²</div>
                    <div class="formula" id="calculation">F = 6.67×10⁻¹¹ × (100 × 50) / 10²</div>
                    <div class="result" id="result">F = 3.34 × 10⁻⁸ N</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="demo-title">Explore Gravitation</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="playFullLesson()">📚 Complete Lesson</button>
                <button class="demo-btn" onclick="showAppleDemo()">🍎 Newton's Apple</button>
                <button class="demo-btn" onclick="showCircularDemo()">🔄 Circular Motion</button>
                <button class="demo-btn" onclick="showEarthMoonDemo()">🌍 Earth-Moon</button>
                <button class="demo-btn" onclick="showCalculationDemo()">🧮 Calculate Force</button>
                <button class="demo-btn" onclick="resetAllClick()">🔄 Reset</button>
            </div>
        </div>

        <!-- Activity Section -->
        <div class="activity-card">
            <div class="activity-title">Activity 9.1: Stone and Thread Experiment</div>
            <ul class="activity-steps">
                <li>Take a piece of thread and tie a small stone at one end</li>
                <li>Hold the other end and whirl it round in a circular path</li>
                <li>Note the motion of the stone - it follows a circular path</li>
                <li>Release the thread and observe the stone fly off tangentially</li>
                <li>This demonstrates that centripetal force keeps objects in circular motion</li>
            </ul>
        </div>

        <!-- Theory Section -->
        <div class="theory-section">
            <div class="law-statement">
                <div class="law-title">Universal Law of Gravitation</div>
                <div class="law-content">
                    Every object in the universe attracts every other object with a force which is proportional to the product 
                    of their masses and inversely proportional to the square of the distance between them. The force is along 
                    the line joining the centres of two objects.
                </div>
            </div>

            <div class="formula-box">
                <div class="main-equation">F = G × (M × m) / d²</div>
                <div style="margin-top: 15px; line-height: 1.8;">
                    <strong>Where:</strong><br>
                    F = Gravitational force (N)<br>
                    G = 6.67 × 10⁻¹¹ N m² kg⁻² (Universal gravitational constant)<br>
                    M, m = Masses of the two objects (kg)<br>
                    d = Distance between centers (m)
                </div>
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <div class="card-icon">🍎</div>
                    <div class="card-title">Newton's Insight</div>
                    <div class="card-content">
                        Newton realized that the same force that makes an apple fall also keeps the Moon in orbit around Earth. 
                        This was a revolutionary unification of terrestrial and celestial mechanics.
                    </div>
                </div>
                <div class="info-card">
                    <div class="card-icon">🎯</div>
                    <div class="card-title">Centripetal Force</div>
                    <div class="card-content">
                        Objects in circular motion require a center-seeking force. For celestial bodies, gravity provides 
                        this centripetal force, preventing them from flying off in straight lines.
                    </div>
                </div>
                <div class="info-card">
                    <div class="card-icon">⚖️</div>
                    <div class="card-title">Action-Reaction</div>
                    <div class="card-content">
                        By Newton's third law, if Earth attracts an apple, the apple attracts Earth equally. 
                        We don't see Earth move because its mass is enormously larger than the apple's.
                    </div>
                </div>
                <div class="info-card">
                    <div class="card-icon">🌌</div>
                    <div class="card-title">Universal Application</div>
                    <div class="card-content">
                        The law applies to all objects: from tiny particles to massive stars. It explains planetary orbits, 
                        tides, and why we stay grounded on Earth's surface.
                    </div>
                </div>
            </div>

            <div class="law-statement" style="background: rgba(16, 185, 129, 0.1); border-left-color: #10b981;">
                <div class="law-title" style="color: #10b981;">Importance of Gravitational Law</div>
                <div class="law-content">
                    The universal law of gravitation explains:<br>
                    • The force that binds us to Earth<br>
                    • The motion of the Moon around Earth<br>
                    • The motion of planets around the Sun<br>
                    • Ocean tides caused by the Moon and Sun
                </div>
            </div>
        </div>
    </div>

    <script>
        // Voice Teacher System
        class PhysicsTeacher {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global state management
        let globalAudioEnabled = true;
        let currentTeacher = null;
        let isPlaying = false;
        let animationTimeline = null;
        let currentDemoAborted = false;
        let activeAnimations = [];
        let currentRunId = 0;
        let currentTaskId = null; // Track current task ID
        let taskQueue = []; // Queue for task-specific content

        // Function to create new animation timeline
        function createNewTimeline() {
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            activeAnimations.forEach(anim => {
                if (anim) anim.kill();
            });
            activeAnimations = [];
            gsap.killTweensOf("*");
            
            const newTimeline = gsap.timeline();
            animationTimeline = newTimeline;
            return newTimeline;
        }

        function trackAnimation(animation) {
            if (animation) {
                activeAnimations.push(animation);
            }
            return animation;
        }

        // Function to stop current demo
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentRunId++;
            
            // Clear current task context
            currentTaskId = null;
            taskQueue = [];
            
            // Stop teacher
            if (currentTeacher) {
                currentTeacher.destroy();
                currentTeacher = null;
            }
            
            // Kill all animations
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            
            activeAnimations.forEach(anim => {
                if (anim) anim.kill();
            });
            activeAnimations = [];
            
            gsap.killTweensOf("*");
            
            // Hide all demos immediately
            document.querySelectorAll('.apple-demo, .circular-demo, .earth-moon-demo, .calculation-demo').forEach(demo => {
                demo.classList.remove('active');
            });
            
            isPlaying = false;
        }

        // Function to check if demo should continue
        function shouldContinue(taskId = null) {
            // If a specific task ID is provided, check if it matches current task
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        // Function to create new teacher
        function createNewTeacher(taskId = null) {
            if (currentTeacher) {
                currentTeacher.destroy();
                currentTeacher = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentTeacher = new PhysicsTeacher();
            return currentTeacher;
        }

        // Initialize
        window.addEventListener('load', () => {
            const teacher = createNewTeacher('initialization');
            teacher.speak("Welcome to the Universal Law of Gravitation! Let's explore how Newton discovered that every object attracts every other object in the universe.");
        });

        // Complete Lesson
        async function playFullLesson() {
            const taskId = 'complete-lesson';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(0);
            
            const teacher = createNewTeacher(taskId);
            const runId = currentRunId;
            
            await resetAll();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            updateTitle("📚 Complete Gravitation Lesson");
            
            await teacher.speak("Let's begin with Newton's famous apple story.");
            if (!shouldContinue(taskId)) return;
            await showAppleDemoInternal(teacher, runId, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(3000);
            
            await teacher.speak("Now let's understand circular motion and centripetal force.");
            if (!shouldContinue(taskId)) return;
            await showCircularDemoInternal(teacher, runId, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(3000);
            
            await teacher.speak("This same principle keeps the Moon orbiting Earth.");
            if (!shouldContinue(taskId)) return;
            await showEarthMoonDemoInternal(teacher, runId, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(3000);
            
            await teacher.speak("Finally, let's calculate gravitational forces between objects.");
            if (!shouldContinue(taskId)) return;
            await showCalculationDemoInternal(teacher, runId, taskId);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Remember: Gravity is universal - it acts between all objects with mass, everywhere in the universe!");
            
            isPlaying = false;
        }

        // Newton's Apple Demo
        async function showAppleDemo() {
            const taskId = 'apple-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(1);
            
            const teacher = createNewTeacher(taskId);
            const runId = currentRunId;
            await showAppleDemoInternal(teacher, runId, taskId);
            
            isPlaying = false;
        }

        async function showAppleDemoInternal(teacher, runId, taskId = 'apple-demo') {
            await resetAll();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🍎 Newton's Discovery");
            
            document.getElementById('apple-demo').classList.add('active');
            
            await teacher.speak("Newton was sitting under a tree when an apple fell on him.");
            if (!shouldContinue(taskId)) return;
            
            // Animate apple falling on Newton
            const apple = document.getElementById('apple');
            trackAnimation(gsap.to(apple, {
                duration: 1.5,
                y: 240, // Fall distance to hit Newton's head level
                ease: "power2.in",
                onComplete: () => {
                    if (!shouldContinue(taskId)) return;
                    // Small bounce off Newton's head
                    trackAnimation(gsap.to(apple, {
                        duration: 0.3,
                        y: 260,
                        x: -20,
                        rotation: 45,
                        ease: "power2.out"
                    }));
                    // Show thought bubble after apple hits
                    trackAnimation(gsap.to('#thought', {
                        duration: 0.5,
                        opacity: 1,
                        scale: 1,
                        ease: "back.out(1.7)",
                        delay: 0.5
                    }));
                }
            }));
            
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            await teacher.speak("This made Newton wonder: If Earth attracts the apple, does it also attract the Moon? He realized the same force - gravity - acts on both!");
        }

        // Circular Motion Demo
        async function showCircularDemo() {
            const taskId = 'circular-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(2);
            
            const teacher = createNewTeacher(taskId);
            const runId = currentRunId;
            await showCircularDemoInternal(teacher, runId, taskId);
            
            isPlaying = false;
        }

        async function showCircularDemoInternal(teacher, runId, taskId = 'circular-demo') {
            await resetAll();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🔄 Circular Motion & Centripetal Force");
            
            document.getElementById('circular-demo').classList.add('active');
            
            await teacher.speak("When you whirl a stone tied to a thread, it moves in a circle.");
            if (!shouldContinue(taskId)) return;
            
            // Animate circular motion
            const thread = document.getElementById('thread');
            const stone = document.getElementById('stone');
            const velocityArrow = document.getElementById('velocity-arrow');
            const centripetalForce = document.getElementById('centripetal-force');
            const circularPath = document.getElementById('circular-path');
            
            animationTimeline = createNewTimeline();
            
            // Rotate the entire circular path container with thread and stone together
            animationTimeline
                .to([thread, stone], {
                    duration: 4,
                    rotation: 360,
                    transformOrigin: "center center",
                    ease: "none",
                    repeat: -1,
                    onUpdate: function() {
                        // Calculate stone position based on rotation
                        const angle = this.progress() * 360;
                        const radius = 150;
                        const centerX = circularPath.offsetLeft + circularPath.offsetWidth / 2;
                        const centerY = circularPath.offsetTop + circularPath.offsetHeight / 2;
                        const stoneX = Math.cos((angle - 90) * Math.PI / 180) * radius;
                        const stoneY = Math.sin((angle - 90) * Math.PI / 180) * radius;

                         gsap.set(stone, {
                left: stoneX + circularPath.offsetWidth / 2,
                top:   stoneY + circularPath.offsetHeight / 2,
                rotation: angle - 90,
                xPercent: -50,
                yPercent: -50
            });
            
            // Position and rotate thread to connect center to stone
            gsap.set(thread, {
                right: centerX,
                bottom: centerY,
                width: radius + 'px',
                rotation: angle - 90,
                transformOrigin: "0 50%",
                xPercent: 0,
                yPercent: -50
            });
                        
                        // Position velocity arrow tangent to the circle
                        gsap.set(velocityArrow, {
                            opacity: 0.8,
                            left: centerX + stoneX,
                            top: centerY + stoneY,
                            rotation: angle,
                            xPercent: -10,
                            yPercent: -50,
                            transformOrigin: "left center"
                        });
                        
                        // Position centripetal force arrow pointing toward center
                        // Arrow points FROM stone TO center
                        gsap.set(centripetalForce, {
                            opacity: 0.8,
                            left: centerX + stoneX,
                            top: centerY + stoneY,
                            rotation: angle + 90,
                            xPercent: -50,
                            yPercent: -50,
                            transformOrigin: "center center"
                        });
                    }
                });
            
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("The red arrow shows velocity - always tangent to the circle. The green arrow shows centripetal force - always pointing toward the center.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("The centripetal force constantly changes the stone's direction, keeping it in circular motion.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            // Simulate thread release
            if (animationTimeline) {
                animationTimeline.kill();
            }
            
            // Hide force arrows
            gsap.set([velocityArrow, centripetalForce], { opacity: 0 });
            
            // Get current angle for tangential release
            const currentRotation = gsap.getProperty(stone, "rotation");
            const releaseAngle = currentRotation * Math.PI / 180;
            const tangentX = Math.cos(releaseAngle) * 400;
            const tangentY = Math.sin(releaseAngle) * 400;
            
            // Stone flies off tangentially
            trackAnimation(gsap.to(stone, {
                duration: 1.5,
                x: tangentX,
                y: tangentY,
                ease: "none"
            }));
            
            await teacher.speak("When you release the thread, the stone flies off tangentially - there's no force to keep it in circular motion!");
        }

        // Earth-Moon System Demo
        async function showEarthMoonDemo() {
            const taskId = 'earth-moon-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(3);
            
            const teacher = createNewTeacher(taskId);
            const runId = currentRunId;
            await showEarthMoonDemoInternal(teacher, runId, taskId);
            
            isPlaying = false;
        }

        async function showEarthMoonDemoInternal(teacher, runId, taskId = 'earth-moon-demo') {
            await resetAll();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🌍 Earth-Moon Gravitational System");
            
            document.getElementById('earth-moon-demo').classList.add('active');
            
            await teacher.speak("The Moon orbits Earth because Earth's gravity provides the centripetal force.");
            if (!shouldContinue(taskId)) return;
            
            // Get elements
            const moonOrbit = document.getElementById('moon-orbit');
            const moon = document.getElementById('moon');
            const velocityArrow = document.getElementById('moon-velocity');
            const centripetalArrow = document.getElementById('moon-centripetal');
            const velocityLabel = document.getElementById('velocity-label');
            const centripetalLabel = document.getElementById('centripetal-label');
            
            // Animate moon orbit with vectors
            animationTimeline = createNewTimeline();
            animationTimeline
                .to(moonOrbit, {
                    duration: 8,
                    rotation: 360,
                    ease: "none",
                    repeat: -1,
                    onUpdate: function() {
                        // Calculate moon position
                        const angle = this.progress() * 360;
                        const radius = 175; // Half of orbit diameter
                        const moonX = Math.cos((angle - 90) * Math.PI / 180) * radius;
                        const moonY = Math.sin((angle - 90) * Math.PI / 180) * radius;
                        
                        // Position velocity arrow at moon's position, pointing tangentially
                        gsap.set(velocityArrow, {
                            opacity: 0.9,
                            left: `calc(50% + ${moonX}px)`,
                            top: `calc(50% + ${moonY}px)`,
                            rotation: angle,
                            xPercent: 0,
                            yPercent: -50,
                            transformOrigin: "0% center"
                        });
                        
                        // Position centripetal arrow at moon's position, pointing toward Earth (inward)
                        // The arrow should point FROM the moon TO the Earth (opposite of outward direction)
                        gsap.set(centripetalArrow, {
                            opacity: 0.9,
                            left: `calc(50% + ${moonX}px)`,
                            top: `calc(50% + ${moonY}px)`,
                            rotation: angle - 90, // Points inward toward Earth
                            xPercent: -100, // Shift arrow so it points inward from moon position
                            yPercent: -50,
                            transformOrigin: "100% center"
                        });
                        
                        // Update label positions relative to moon
                        gsap.set(velocityLabel, {
                            opacity: 0.9,
                            left: `calc(50% + ${moonX + Math.cos(angle * Math.PI / 180) * 90}px)`,
                            top: `calc(50% + ${moonY + Math.sin(angle * Math.PI / 180) * 90}px)`,
                            xPercent: -50,
                            yPercent: -50
                        });
                        
                        // Position centripetal label between moon and Earth
                        gsap.set(centripetalLabel, {
                            opacity: 0.9,
                            left: `calc(50% + ${moonX * 0.5}px)`,
                            top: `calc(50% + ${moonY * 0.5}px)`,
                            xPercent: -50,
                            yPercent: -50
                        });
                    }
                });
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("The red arrow shows the Moon's tangential velocity - it wants to move in a straight line. The green arrow shows Earth's gravitational pull toward the center.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Without gravity, the Moon would fly off tangentially into space. With gravity, it continuously 'falls' toward Earth but its tangential velocity keeps it in orbit.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("This perfect balance between tangential velocity and gravitational force keeps the Moon, satellites, and all planets in their stable orbits!");
        }

        // Force Calculation Demo
        async function showCalculationDemo() {
            const taskId = 'calculation-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(4);
            
            const teacher = createNewTeacher(taskId);
            const runId = currentRunId;
            await showCalculationDemoInternal(teacher, runId, taskId);
            
            isPlaying = false;
        }

        async function showCalculationDemoInternal(teacher, runId, taskId = 'calculation-demo') {
            await resetAll();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🧮 Calculate Gravitational Force");
            
            document.getElementById('calculation-demo').classList.add('active');
            
            await teacher.speak("Let's calculate the gravitational force between two objects using Newton's equation.");
            if (!shouldContinue(taskId)) return;
            
            // Add event listeners for interactive calculation
            document.getElementById('mass1').addEventListener('input', updateCalculation);
            document.getElementById('mass2').addEventListener('input', updateCalculation);
            document.getElementById('distance').addEventListener('input', updateCalculation);
            
            updateCalculation();
            
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            await teacher.speak("Try changing the masses or distance to see how the force changes. Notice that doubling the distance makes the force four times weaker!");
        }

        // Update calculation
        function updateCalculation() {
            const m1 = parseFloat(document.getElementById('mass1').value);
            const m2 = parseFloat(document.getElementById('mass2').value);
            const d = parseFloat(document.getElementById('distance').value);
            
            document.getElementById('distance-value').textContent = d;
            
            const G = 6.67e-11;
            const F = G * (m1 * m2) / (d * d);
            
            document.getElementById('calculation').textContent = 
                `F = 6.67×10⁻¹¹ × (${m1} × ${m2}) / ${d}²`;
            
            document.getElementById('result').textContent = 
                `F = ${F.toExponential(2)} N`;
        }

        // Helper Functions
        async function resetAll() {
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            
            // Kill all tracked animations
            activeAnimations.forEach(anim => {
                if (anim) anim.kill();
            });
            activeAnimations = [];
            
            gsap.killTweensOf("*");
            
            // Stop current teacher if exists
            if (currentTeacher) {
                currentTeacher.stop();
            }
            
            // Hide all demos
            document.querySelectorAll('.apple-demo, .circular-demo, .earth-moon-demo, .calculation-demo').forEach(demo => {
                demo.classList.remove('active');
            });
            
            // Reset elements
            gsap.set('#apple', { y: 0 });
            gsap.set('#thought', { opacity: 0, scale: 0.8 });
            gsap.set('#thread', { rotation: 0 });
            gsap.set('#stone', { rotation: 0, x: 0, y: 0 , top :'-15px', left: '50%' });
            gsap.set('#velocity-arrow', { opacity: 0 });
            gsap.set('#centripetal-force', { opacity: 0 });
            
            // Remove event listeners to prevent duplicates
            const mass1 = document.getElementById('mass1');
            const mass2 = document.getElementById('mass2');
            const distance = document.getElementById('distance');
            
            if (mass1) {
                const newMass1 = mass1.cloneNode(true);
                mass1.parentNode.replaceChild(newMass1, mass1);
            }
            if (mass2) {
                const newMass2 = mass2.cloneNode(true);
                mass2.parentNode.replaceChild(newMass2, mass2);
            }
            if (distance) {
                const newDistance = distance.cloneNode(true);
                distance.parentNode.replaceChild(newDistance, distance);
            }
            
            updateTitle("Explore Gravitation");
            
            await wait(300);
        }

        function updateTitle(title) {
            document.getElementById('demo-title').textContent = title;
        }

        function setActiveButton(index) {
            document.querySelectorAll('.demo-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Reset Button Handler
        async function resetAllClick() {
            stopCurrentDemo();
            isPlaying = false;
            await resetAll();
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentTeacher) {
                currentTeacher.stop();
            }
        });
    </script>
</body>
</html>