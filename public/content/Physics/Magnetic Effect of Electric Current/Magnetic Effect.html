<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Effects of Electric Current - Interactive Learning Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --magnetic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --electric-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --field-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --copper-gradient: linear-gradient(135deg, #b87333 0%, #cd7f32 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-accent: #00f2fe;
            --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 25px 50px rgba(0, 0, 0, 0.4);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-magnetic {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto 30px;
        }

        .magnetic-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: magneticOrbit 3s linear infinite;
        }

        .magnetic-particle:nth-child(1) { 
            background: #ff6b6b; 
            animation-delay: 0s;
            --orbit-radius: 80px;
        }
        .magnetic-particle:nth-child(2) { 
            background: #4facfe; 
            animation-delay: 0.5s;
            --orbit-radius: 60px;
        }
        .magnetic-particle:nth-child(3) { 
            background: #f093fb; 
            animation-delay: 1s;
            --orbit-radius: 40px;
        }
        .magnetic-particle:nth-child(4) { 
            background: #00f2fe; 
            animation-delay: 1.5s;
            --orbit-radius: 70px;
        }

        @keyframes magneticOrbit {
            0% {
                transform: translate(100px, 100px) rotate(0deg) translateX(var(--orbit-radius)) rotate(0deg);
            }
            100% {
                transform: translate(100px, 100px) rotate(360deg) translateX(var(--orbit-radius)) rotate(-360deg);
            }
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
            background: var(--magnetic-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            padding: 50px;
            background: var(--glass-bg);
            border-radius: 30px;
            backdrop-filter: blur(20px);
            margin-bottom: 40px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-primary);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--magnetic-gradient);
            opacity: 0.3;
            z-index: -1;
            border-radius: 30px;
            animation: magneticPulse 5s ease-in-out infinite;
        }

        @keyframes magneticPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            font-size: 3.5rem;
            background: var(--magnetic-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-weight: 800;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .main-display {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 40px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-primary);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .demo-container {
            height: 500px;
            overflow: hidden;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .content-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            max-height: 600px;
        }

        .content-container::-webkit-scrollbar {
            width: 8px;
        }

        .content-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .content-container::-webkit-scrollbar-thumb {
            background: var(--magnetic-gradient);
            border-radius: 4px;
        }

        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: var(--magnetic-gradient);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .control-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .control-btn.active {
            background: var(--field-gradient);
            transform: translateY(-2px);
        }

        .reset-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            margin-top: 20px;
        }

        .display-section {
            display: none;
            animation: fadeInUp 0.8s ease-out;
        }

        .display-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .demo-stage {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            border: 2px solid var(--glass-border);
            overflow: hidden;
        }

        .demo-stage canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--text-accent);
            box-shadow: 0 8px 25px rgba(0, 242, 254, 0.15);
            backdrop-filter: blur(10px);
        }

        .info-title {
            color: var(--text-accent);
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .phenomenon-box {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            border-left: 4px solid #4facfe;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.2);
            backdrop-filter: blur(10px);
        }

        .phenomenon-box h3 {
            color: #4facfe;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .data-table {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .data-table th {
            background: var(--magnetic-gradient);
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .interactive-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-accent);
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--magnetic-gradient);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--magnetic-gradient);
            cursor: pointer;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            height: 400px;
            position: relative;
        }

        .lesson-progress {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--magnetic-gradient);
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        #audio-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--magnetic-gradient);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-primary);
            transition: var(--transition);
        }

        #audio-toggle:hover {
            transform: scale(1.1);
        }

        .example-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .example-card:hover {
            transform: translateX(5px);
        }

        .field-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: 600;
        }

        .north-pole {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
        }

        .south-pole {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-magnetic">
                <div class="magnetic-particle"></div>
                <div class="magnetic-particle"></div>
                <div class="magnetic-particle"></div>
                <div class="magnetic-particle"></div>
            </div>
            <div class="loading-text">Preparing Electromagnetic Lab...</div>
        </div>
    </div>

    <!-- Audio Control -->
    <button id="audio-toggle" title="Toggle Audio Narration">üîä</button>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° Magnetic Effects of Electric Current</h1>
            <p>Explore the fascinating connection between electricity and magnetism through interactive demonstrations</p>
        </div>

        <!-- Main Display Area -->
        <div class="main-display">
            <!-- Demo Container -->
            <div class="demo-container">
                <!-- Complete Lesson Section -->
                <div class="display-section active" id="lesson-section">
                    <div class="demo-stage">
                        <div id="lessonContent">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>

                <!-- Oersted's Experiment Section -->
                <div class="display-section" id="oersted-section">
                    <div class="demo-stage">
                        <canvas id="oerstedCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Magnetic Field Lines Section -->
                <div class="display-section" id="field-section">
                    <div class="demo-stage">
                        <canvas id="fieldCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Current Direction Section -->
                <div class="display-section" id="current-section">
                    <div class="demo-stage">
                        <canvas id="currentCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Electromagnet Section -->
                <div class="display-section" id="electromagnet-section">
                    <div class="demo-stage">
                        <canvas id="electromagnetCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Data Section -->
                <div class="display-section" id="data-section">
                    <div class="demo-stage">
                        <div class="chart-container">
                            <canvas id="magneticChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div class="content-container">
                <!-- Oersted's Experiment Content -->
                <div class="display-section" id="oersted-content">
                    <div class="info-panel">
                        <div class="info-title">üß≤ Oersted's Discovery</div>
                        <p>The historic experiment that revealed the connection between electricity and magnetism</p>
                    </div>
                    
                    <div class="phenomenon-box">
                        <h3>The Groundbreaking Experiment</h3>
                        <p>In 1820, Hans Christian Oersted discovered that electric current produces a magnetic field. When he passed current through a wire placed near a compass needle, the needle deflected, proving that electricity creates magnetism.</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Key Observations</h3>
                        <div class="example-card">
                            <h4>üß≠ Compass Deflection</h4>
                            <p>The compass needle deflects when current flows through a nearby wire, indicating the presence of a magnetic field.</p>
                        </div>
                        <div class="example-card">
                            <h4>‚ö° Current Direction Matters</h4>
                            <p>Reversing the current direction reverses the compass needle deflection, showing the magnetic field direction depends on current direction.</p>
                        </div>
                        <div class="example-card">
                            <h4>üìè Distance Effect</h4>
                            <p>The deflection decreases as the compass is moved away from the wire, indicating field strength decreases with distance.</p>
                        </div>
                    </div>

                    <div class="interactive-controls">
                        <div class="slider-container">
                            <label>Current Strength: <span id="currentStrength">5</span> A</label>
                            <input type="range" class="slider" id="currentSlider" min="0" max="10" value="5">
                        </div>
                        <button class="control-btn" id="reverseCurrentBtn">Reverse Current Direction</button>
                    </div>
                </div>

                <!-- Magnetic Field Lines Content -->
                <div class="display-section" id="field-content">
                    <div class="info-panel">
                        <div class="info-title">üîÑ Magnetic Field Lines</div>
                        <p>Understanding the invisible patterns of magnetic fields</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Properties of Magnetic Field Lines</h3>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Field lines emerge from the <span class="field-indicator north-pole">North Pole</span></li>
                            <li>Field lines merge at the <span class="field-indicator south-pole">South Pole</span></li>
                            <li>Field lines are closed curves</li>
                            <li>Field lines never intersect</li>
                            <li>Closer field lines indicate stronger magnetic field</li>
                        </ul>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Mapping Field Lines</h3>
                        <p>We can visualize magnetic field lines using:</p>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Iron filings sprinkled around a magnet</li>
                            <li>Small compass needles placed at different points</li>
                            <li>Mathematical models and simulations</li>
                        </ul>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Field Line Density</th>
                                <th>Field Strength</th>
                                <th>Force on Test Magnet</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Near Poles</td>
                                <td>High</td>
                                <td>Strong</td>
                                <td>Maximum</td>
                            </tr>
                            <tr>
                                <td>Between Poles</td>
                                <td>Medium</td>
                                <td>Moderate</td>
                                <td>Moderate</td>
                            </tr>
                            <tr>
                                <td>Far from Magnet</td>
                                <td>Low</td>
                                <td>Weak</td>
                                <td>Minimum</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Current Direction Content -->
                <div class="display-section" id="current-content">
                    <div class="info-panel">
                        <div class="info-title">‚û°Ô∏è Right-Hand Rules</div>
                        <p>Simple techniques to determine magnetic field direction</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Right-Hand Thumb Rule</h3>
                        <p>For a straight current-carrying conductor:</p>
                        <ol style="margin-left: 20px; line-height: 2;">
                            <li>Hold the conductor in your right hand</li>
                            <li>Point your thumb in the direction of current flow</li>
                            <li>Your fingers curl in the direction of magnetic field lines</li>
                        </ol>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Circular Loop Field</h3>
                        <p>For a circular loop carrying current:</p>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Field lines are circular around each segment</li>
                            <li>At the center, field lines are straight</li>
                            <li>Multiple loops create a stronger field (solenoid)</li>
                        </ul>
                    </div>

                    <div class="example-card">
                        <h4>üì± Practical Applications</h4>
                        <p>Understanding current direction and magnetic fields is crucial for:</p>
                        <ul style="margin-left: 20px;">
                            <li>Electric motors</li>
                            <li>Generators</li>
                            <li>Transformers</li>
                            <li>MRI machines</li>
                        </ul>
                    </div>
                </div>

                <!-- Electromagnet Content -->
                <div class="display-section" id="electromagnet-content">
                    <div class="info-panel">
                        <div class="info-title">üîå Electromagnets</div>
                        <p>Creating powerful magnets using electricity</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>What is an Electromagnet?</h3>
                        <p>An electromagnet is a magnet created by passing electric current through a coil of wire wrapped around a soft iron core. Unlike permanent magnets, electromagnets can be turned on and off, and their strength can be controlled.</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Factors Affecting Strength</h3>
                        <div class="example-card">
                            <h4>üî¢ Number of Turns</h4>
                            <p>More coil turns = Stronger magnetic field</p>
                        </div>
                        <div class="example-card">
                            <h4>‚ö° Current Strength</h4>
                            <p>Higher current = Stronger magnetic field</p>
                        </div>
                        <div class="example-card">
                            <h4>üß≤ Core Material</h4>
                            <p>Soft iron core greatly increases field strength</p>
                        </div>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Applications of Electromagnets</h3>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>üöó Electric motors in vehicles</li>
                            <li>üîî Electric bells and buzzers</li>
                            <li>üèóÔ∏è Magnetic cranes in junkyards</li>
                            <li>üöÑ Maglev trains</li>
                            <li>üè• MRI machines in hospitals</li>
                            <li>üîä Speakers and headphones</li>
                        </ul>
                    </div>

                    <div class="interactive-controls">
                        <div class="slider-container">
                            <label>Number of Coil Turns: <span id="coilTurns">100</span></label>
                            <input type="range" class="slider" id="turnsSlider" min="50" max="500" value="100" step="50">
                        </div>
                        <div class="slider-container">
                            <label>Current: <span id="electromagnetCurrent">3</span> A</label>
                            <input type="range" class="slider" id="electromagnetCurrentSlider" min="0" max="10" value="3">
                        </div>
                    </div>
                </div>

                <!-- Data Analysis Content -->
                <div class="display-section" id="data-content">
                    <div class="info-panel">
                        <div class="info-title">üìä Magnetic Field Analysis</div>
                        <p>Quantitative relationships in electromagnetic phenomena</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Magnetic Field Strength Formula</h3>
                        <p style="text-align: center; font-size: 1.2rem; margin: 20px 0;">
                            B = Œº‚ÇÄ √ó n √ó I
                        </p>
                        <p>Where:</p>
                        <ul style="margin-left: 20px;">
                            <li>B = Magnetic field strength (Tesla)</li>
                            <li>Œº‚ÇÄ = Permeability of free space</li>
                            <li>n = Number of turns per unit length</li>
                            <li>I = Current (Amperes)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="control-btn active" data-mode="lesson">üéØ Complete Lesson</button>
            <button class="control-btn" data-mode="oersted">üß≤ Oersted's Experiment</button>
            <button class="control-btn" data-mode="field">üîÑ Field Lines</button>
            <button class="control-btn" data-mode="current">‚û°Ô∏è Current Direction</button>
            <button class="control-btn" data-mode="electromagnet">üîå Electromagnets</button>
            <button class="control-btn" data-mode="data">üìä Data Analysis</button>
        </div>
        
        <!-- Reset Button -->
        <div style="text-align: center;">
            <button class="control-btn reset-btn" id="resetBtn">üîÑ Reset Everything</button>
        </div>
    </div>

    <script>
        // Global Variables
        let audioEnabled = true;
        let currentMode = 'lesson';
        let lessonSequence = null;
        let charts = {};
        let animationFrames = {};
        let lessonStarted = false;
        let currentDirection = 1; // 1 for forward, -1 for reverse

        // Audio System
        class AudioNarrator {
            constructor() {
                this.synth = window.speechSynthesis;
                this.enabled = true;
                this.speaking = false;
            }

            speak(text, priority = false) {
                if (!this.enabled) return Promise.resolve();
                
                return new Promise((resolve) => {
                    if (priority) {
                        this.stop();
                    }
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.9;
                    
                    utterance.onend = () => {
                        this.speaking = false;
                        resolve();
                    };
                    
                    this.synth.speak(utterance);
                    this.speaking = true;
                });
            }

            stop() {
                this.synth.cancel();
                this.speaking = false;
            }

            toggle() {
                this.enabled = !this.enabled;
                if (!this.enabled) this.stop();
                return this.enabled;
            }
        }

        const narrator = new AudioNarrator();

        // Replace the existing animateOersted function with this enhanced 3D version
function animateOersted() {
    const canvas = document.getElementById('oerstedCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    let time = 0;
    const currentStrength = parseFloat(document.getElementById('currentSlider')?.value || 5);
    
    function draw() {
        // Clear canvas with gradient background for depth
        const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGradient.addColorStop(0, '#0a1929');
        bgGradient.addColorStop(0.5, '#1e3c72');
        bgGradient.addColorStop(1, '#2a5298');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Add perspective grid for 3D effect
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 20; i++) {
            const y = 100 + (i * 20);
            const perspective = (y - 100) / 400;
            ctx.beginPath();
            ctx.moveTo(100 - perspective * 50, y);
            ctx.lineTo(1100 + perspective * 50, y);
            ctx.stroke();
        }
        
        // Draw 3D wire with gradient and shadow
        ctx.save();
        
        // Wire shadow for depth
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetY = 10;
        
        // Main wire with 3D gradient
        const wireGradient = ctx.createLinearGradient(100, 240, 100, 260);
        wireGradient.addColorStop(0, '#cd7f32');
        wireGradient.addColorStop(0.3, '#f4a460');
        wireGradient.addColorStop(0.5, '#ffd700');
        wireGradient.addColorStop(0.7, '#cd7f32');
        wireGradient.addColorStop(1, '#8b4513');
        
        ctx.strokeStyle = wireGradient;
        ctx.lineWidth = 20;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(100, 250);
        ctx.lineTo(1100, 250);
        ctx.stroke();
        
        // Wire highlight for 3D effect
        ctx.shadowBlur = 0;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(100, 242);
        ctx.lineTo(1100, 242);
        ctx.stroke();
        
        ctx.restore();
        
        // Animated current flow with 3D particles
        if (currentStrength > 0) {
            for (let i = 0; i < 30; i++) {
                const x = (time * 3 * currentDirection + i * 40) % 1200;
                const y = 250 + Math.sin(x * 0.01 + time * 0.1) * 3;
                
                // Electron particle with glow
                const glowGradient = ctx.createRadialGradient(x, y, 0, x, y, 15);
                glowGradient.addColorStop(0, 'rgba(255, 255, 0, 0.8)');
                glowGradient.addColorStop(0.5, 'rgba(255, 200, 0, 0.4)');
                glowGradient.addColorStop(1, 'rgba(255, 100, 0, 0)');
                
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // 3D Compass with realistic rendering
        const compassX = 600;
        const compassY = 250;
        const compassRadius = 80;
        
        ctx.save();
        
        // Compass shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;
        
        // Compass outer ring with gradient
        const ringGradient = ctx.createRadialGradient(compassX - 20, compassY - 20, 0, compassX, compassY, compassRadius);
        ringGradient.addColorStop(0, '#ffffff');
        ringGradient.addColorStop(0.7, '#e0e0e0');
        ringGradient.addColorStop(1, '#808080');
        
        ctx.strokeStyle = ringGradient;
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.arc(compassX, compassY, compassRadius, 0, Math.PI * 2);
        ctx.stroke();
        
        // Compass face with gradient
        const faceGradient = ctx.createRadialGradient(compassX - 30, compassY - 30, 0, compassX, compassY, compassRadius);
        faceGradient.addColorStop(0, '#f5f5f5');
        faceGradient.addColorStop(1, '#d0d0d0');
        
        ctx.fillStyle = faceGradient;
        ctx.beginPath();
        ctx.arc(compassX, compassY, compassRadius - 4, 0, Math.PI * 2);
        ctx.fill();
        
        // Calculate needle deflection
        const deflection = (currentStrength / 10) * Math.PI / 4 * currentDirection;
        
        // 3D Compass needle
        ctx.save();
        ctx.translate(compassX, compassY);
        ctx.rotate(deflection + Math.sin(time * 0.05) * 0.02);
        
        // Needle shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        // North pole with 3D effect
        const northGradient = ctx.createLinearGradient(-15, -50, 15, -20);
        northGradient.addColorStop(0, '#ff0000');
        northGradient.addColorStop(0.5, '#ff6666');
        northGradient.addColorStop(1, '#cc0000');
        
        ctx.fillStyle = northGradient;
        ctx.beginPath();
        ctx.moveTo(0, -50);
        ctx.lineTo(-15, 0);
        ctx.lineTo(0, -5);
        ctx.lineTo(15, 0);
        ctx.closePath();
        ctx.fill();
        
        // South pole with 3D effect
        const southGradient = ctx.createLinearGradient(-15, 20, 15, 50);
        southGradient.addColorStop(0, '#0000cc');
        southGradient.addColorStop(0.5, '#6666ff');
        southGradient.addColorStop(1, '#0000ff');
        
        ctx.fillStyle = southGradient;
        ctx.beginPath();
        ctx.moveTo(0, 50);
        ctx.lineTo(-15, 0);
        ctx.lineTo(0, 5);
        ctx.lineTo(15, 0);
        ctx.closePath();
        ctx.fill();
        
        // Center pivot with 3D sphere
        const pivotGradient = ctx.createRadialGradient(-2, -2, 0, 0, 0, 8);
        pivotGradient.addColorStop(0, '#ffffff');
        pivotGradient.addColorStop(0.5, '#c0c0c0');
        pivotGradient.addColorStop(1, '#606060');
        
        ctx.fillStyle = pivotGradient;
        ctx.beginPath();
        ctx.arc(0, 0, 8, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
        ctx.restore();
        
        // 3D Magnetic field visualization
        if (currentStrength > 0) {
            for (let r = 50; r < 250; r += 50) {
                const opacity = (250 - r) / 250 * (currentStrength / 10);
                
                ctx.save();
                ctx.translate(compassX, compassY);
                
                // Create 3D field rings
                ctx.strokeStyle = `rgba(79, 172, 254, ${opacity * 0.6})`;
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.lineDashOffset = -time * 0.5;
                
                // Draw elliptical field lines for 3D effect
                ctx.beginPath();
                ctx.ellipse(0, 0, r, r * 0.7, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.setLineDash([]);
                ctx.restore();
            }
        }
        
        // 3D Labels with shadow
        ctx.save();
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 18px Arial';
        ctx.fillText('Copper Wire', 100, 230);
        ctx.fillText('Magnetic Compass', compassX - 70, compassY + 110);
        
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`Current: ${currentStrength} A`, 100, 100);
        ctx.fillText(currentDirection > 0 ? 'Direction: Forward ‚Üí' : 'Direction: Reverse ‚Üê', 100, 130);
        
        ctx.restore();
        
        // Battery with 3D effect
        // Positive terminal
        const posGradient = ctx.createLinearGradient(50, 240, 80, 260);
        posGradient.addColorStop(0, '#ff6666');
        posGradient.addColorStop(0.5, '#ff0000');
        posGradient.addColorStop(1, '#cc0000');
        
        ctx.fillStyle = posGradient;
        ctx.fillRect(50, 240, 30, 20);
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 20px Arial';
        ctx.fillText('+', 58, 257);
        
        // Negative terminal
        const negGradient = ctx.createLinearGradient(1120, 240, 1150, 260);
        negGradient.addColorStop(0, '#666666');
        negGradient.addColorStop(0.5, '#000000');
        negGradient.addColorStop(1, '#333333');
        
        ctx.fillStyle = negGradient;
        ctx.fillRect(1120, 240, 30, 20);
        ctx.fillStyle = '#ffffff';
        ctx.fillText('‚àí', 1128, 257);
        
        time++;
        animationFrames.oersted = requestAnimationFrame(draw);
    }
    
    draw();
}

// Replace the existing animateFieldLines function with this enhanced 3D version
function animateFieldLines() {
    const canvas = document.getElementById('fieldCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    let time = 0;
    let particles = [];
    
    // Initialize 3D particles
    for (let i = 0; i < 30; i++) {
        particles.push({
            angle: (i / 30) * Math.PI * 2,
            radius: 100 + Math.random() * 150,
            speed: 0.01 + Math.random() * 0.02,
            z: Math.random() * 100,
            size: 2 + Math.random() * 3
        });
    }
    
    function draw() {
        // 3D gradient background
        const bgGradient = ctx.createRadialGradient(600, 250, 0, 600, 250, 500);
        bgGradient.addColorStop(0, '#2a5298');
        bgGradient.addColorStop(0.5, '#1e3c72');
        bgGradient.addColorStop(1, '#0a1929');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 3D grid floor
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.1)';
        ctx.lineWidth = 1;
        const vanishingPointY = 150;
        
        for (let z = 0; z <= 10; z++) {
            const y = vanishingPointY + z * 30;
            const perspective = z / 10;
            
            ctx.beginPath();
            ctx.moveTo(200 - perspective * 100, y);
            ctx.lineTo(1000 + perspective * 100, y);
            ctx.stroke();
        }
        
        for (let x = -5; x <= 5; x++) {
            const baseX = 600 + x * 80;
            ctx.beginPath();
            ctx.moveTo(baseX, vanishingPointY);
            ctx.lineTo(baseX + x * 20, 450);
            ctx.stroke();
        }
        
        // Draw 3D bar magnet
        const magnetX = 600;
        const magnetY = 250;
        const magnetWidth = 240;
        const magnetHeight = 100;
        const magnetDepth = 60;
        
        ctx.save();
        
        // Magnet shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 10;
        ctx.shadowOffsetY = 10;
        
        // Draw 3D magnet faces
        // Top face
        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.beginPath();
        ctx.moveTo(magnetX - magnetWidth/2, magnetY - magnetHeight/2);
        ctx.lineTo(magnetX - magnetWidth/2 + magnetDepth/2, magnetY - magnetHeight/2 - magnetDepth/2);
        ctx.lineTo(magnetX + magnetWidth/2 + magnetDepth/2, magnetY - magnetHeight/2 - magnetDepth/2);
        ctx.lineTo(magnetX + magnetWidth/2, magnetY - magnetHeight/2);
        ctx.closePath();
        ctx.fill();
        
        // Side face
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.beginPath();
        ctx.moveTo(magnetX + magnetWidth/2, magnetY - magnetHeight/2);
        ctx.lineTo(magnetX + magnetWidth/2 + magnetDepth/2, magnetY - magnetHeight/2 - magnetDepth/2);
        ctx.lineTo(magnetX + magnetWidth/2 + magnetDepth/2, magnetY + magnetHeight/2 - magnetDepth/2);
        ctx.lineTo(magnetX + magnetWidth/2, magnetY + magnetHeight/2);
        ctx.closePath();
        ctx.fill();
        
        // Front face with gradient
        // North pole
        const northGradient = ctx.createLinearGradient(magnetX - magnetWidth/2, magnetY, magnetX, magnetY);
        northGradient.addColorStop(0, '#ff3333');
        northGradient.addColorStop(0.5, '#ff6b6b');
        northGradient.addColorStop(1, '#ff9999');
        
        ctx.fillStyle = northGradient;
        ctx.fillRect(magnetX - magnetWidth/2, magnetY - magnetHeight/2, magnetWidth/2, magnetHeight);
        
        // South pole
        const southGradient = ctx.createLinearGradient(magnetX, magnetY, magnetX + magnetWidth/2, magnetY);
        southGradient.addColorStop(0, '#3333ff');
        southGradient.addColorStop(0.5, '#6b6bff');
        southGradient.addColorStop(1, '#9999ff');
        
        ctx.fillStyle = southGradient;
        ctx.fillRect(magnetX, magnetY - magnetHeight/2, magnetWidth/2, magnetHeight);
        
        // Metallic divider
        const dividerGradient = ctx.createLinearGradient(magnetX - 5, magnetY - magnetHeight/2, magnetX + 5, magnetY - magnetHeight/2);
        dividerGradient.addColorStop(0, '#808080');
        dividerGradient.addColorStop(0.5, '#ffffff');
        dividerGradient.addColorStop(1, '#808080');
        
        ctx.fillStyle = dividerGradient;
        ctx.fillRect(magnetX - 5, magnetY - magnetHeight/2, 10, magnetHeight);
        
        // 3D Labels
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 4;
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 32px Arial';
        ctx.fillText('N', magnetX - 40, magnetY + 8);
        ctx.fillText('S', magnetX + 20, magnetY + 8);
        
        ctx.restore();
        
        // Draw 3D field lines
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
        ctx.lineWidth = 2;
        
        for (let i = -4; i <= 4; i++) {
            if (i === 0) continue;
            
            ctx.save();
            ctx.globalAlpha = 0.6;
            
            // Create gradient for field lines
            const fieldGradient = ctx.createLinearGradient(magnetX - magnetWidth/2, 0, magnetX + magnetWidth/2, 0);
            fieldGradient.addColorStop(0, 'rgba(255, 107, 107, 0.6)');
            fieldGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.8)');
            fieldGradient.addColorStop(1, 'rgba(79, 172, 254, 0.6)');
            
            ctx.strokeStyle = fieldGradient;
            ctx.lineWidth = Math.abs(i) === 4 ? 1 : 2;
            
            ctx.beginPath();
            const startY = magnetY + i * 25;
            const startX = magnetX + magnetWidth/2;
            
            ctx.moveTo(startX, startY);
            
            // Create 3D curved field lines
            for (let x = startX; x > magnetX - magnetWidth/2; x -= 5) {
                const t = (startX - x) / magnetWidth;
                const curve = Math.sin(t * Math.PI) * i * 40;
                const z = Math.sin(t * Math.PI) * 20; // 3D depth effect
                const y = startY + curve;
                
                // Adjust line width based on "depth"
                ctx.lineWidth = 2 + z / 10;
                
                ctx.lineTo(x, y);
            }
            
            ctx.stroke();
            
            // 3D Arrow heads with glow
            const arrowX = startX - 120;
            const arrowY = startY + Math.sin(0.5 * Math.PI) * i * 40;
            
            ctx.save();
            ctx.translate(arrowX, arrowY);
            ctx.rotate(Math.atan2(i * 20, -60));
            
            // Arrow glow
            const arrowGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, 15);
            arrowGlow.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
            arrowGlow.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            ctx.fillStyle = arrowGlow;
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Arrow shape
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-12, -6);
            ctx.lineTo(-12, 6);
            ctx.closePath();
            ctx.fill();
            
            ctx.restore();
            ctx.restore();
        }
        
        // Animate 3D particles along field lines
        particles.forEach(particle => {
            particle.angle += particle.speed;
            
            const x = magnetX + Math.cos(particle.angle) * particle.radius;
            const y = magnetY + Math.sin(particle.angle) * 60;
            const z = particle.z + Math.sin(time * 0.05 + particle.angle) * 20;
            
            // Size based on depth
            const size = particle.size * (1 + z / 100);
            
            // Particle glow effect
            const particleGlow = ctx.createRadialGradient(x, y, 0, x, y, size * 3);
            particleGlow.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            particleGlow.addColorStop(0.5, 'rgba(79, 172, 254, 0.6)');
            particleGlow.addColorStop(1, 'rgba(79, 172, 254, 0)');
            
            ctx.fillStyle = particleGlow;
            ctx.beginPath();
            ctx.arc(x, y, size * 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Core particle
            ctx.fillStyle = 'rgba(255, 255, 255, 1)';
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Info text with 3D effect
        ctx.save();
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 3;
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.fillText('Field lines emerge from North pole', 100, 50);
        ctx.fillText('Field lines enter South pole', 100, 80);
        ctx.fillText('Field lines form closed loops', 100, 110);
        ctx.restore();
        
        time++;
        animationFrames.field = requestAnimationFrame(draw);
    }
    
    draw();
}

// Replace the existing animateCurrentDirection function with this enhanced 3D version
function animateCurrentDirection() {
    const canvas = document.getElementById('currentCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    let time = 0;
    
    function draw() {
        // 3D gradient background
        const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGradient.addColorStop(0, '#0a1929');
        bgGradient.addColorStop(0.5, '#1e3c72');
        bgGradient.addColorStop(1, '#2a5298');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Left side - 3D Straight wire with right-hand rule
        ctx.save();
        ctx.translate(300, 250);
        
        // Wire with 3D cylinder effect
        const wireGradient = ctx.createLinearGradient(-15, 0, 15, 0);
        wireGradient.addColorStop(0, '#8b4513');
        wireGradient.addColorStop(0.2, '#cd7f32');
        wireGradient.addColorStop(0.5, '#ffd700');
        wireGradient.addColorStop(0.8, '#cd7f32');
        wireGradient.addColorStop(1, '#8b4513');
        
        // Wire shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 5;
        
        ctx.strokeStyle = wireGradient;
        ctx.lineWidth = 30;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(0, -150);
        ctx.lineTo(0, 150);
        ctx.stroke();
        
        // Wire top cap (3D effect)
        const topCapGradient = ctx.createRadialGradient(0, -150, 0, 0, -150, 15);
        topCapGradient.addColorStop(0, '#ffd700');
        topCapGradient.addColorStop(1, '#cd7f32');
        
        ctx.fillStyle = topCapGradient;
        ctx.beginPath();
        ctx.arc(0, -150, 15, 0, Math.PI * 2);
        ctx.fill();
        
        // Current flow animation with 3D electrons
        for (let i = 0; i < 5; i++) {
            const y = -100 + (time * 2 + i * 40) % 200;
            
            const electronGlow = ctx.createRadialGradient(0, y, 0, 0, y, 20);
            electronGlow.addColorStop(0, 'rgba(255, 255, 0, 0.9)');
            electronGlow.addColorStop(0.5, 'rgba(255, 200, 0, 0.5)');
            electronGlow.addColorStop(1, 'rgba(255, 100, 0, 0)');
            
            ctx.fillStyle = electronGlow;
            ctx.beginPath();
            ctx.arc(0, y, 20, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Current arrow
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = 4;
        ctx.shadowBlur = 5;
        ctx.shadowColor = 'rgba(255, 255, 0, 0.5)';
        
        ctx.beginPath();
        ctx.moveTo(0, -100);
        ctx.lineTo(0, 100);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(0, 100);
        ctx.lineTo(-10, 80);
        ctx.moveTo(0, 100);
        ctx.lineTo(10, 80);
        ctx.stroke();
        
        // 3D Magnetic field circles
        for (let r = 40; r < 120; r += 30) {
            const opacity = 0.6 - r/200;
            
            // Create 3D effect with ellipses
            ctx.strokeStyle = `rgba(79, 172, 254, ${opacity})`;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'rgba(79, 172, 254, 0.5)';
            
            ctx.beginPath();
            ctx.ellipse(0, 0, r, r * 0.8, 0, 0, Math.PI * 2);
            ctx.stroke();
            
            // Animated direction arrows
            const numArrows = 8;
            for (let j = 0; j < numArrows; j++) {
                const angle = (j / numArrows) * Math.PI * 2 + time * 0.05;
                const ax = Math.cos(angle) * r;
                const ay = Math.sin(angle) * r * 0.8;
                
                ctx.save();
                ctx.translate(ax, ay);
                ctx.rotate(angle + Math.PI/2);
                
                // Arrow with glow
                const arrowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 10);
                arrowGradient.addColorStop(0, 'rgba(79, 172, 254, 1)');
                arrowGradient.addColorStop(1, 'rgba(79, 172, 254, 0)');
                
                ctx.fillStyle = arrowGradient;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-10, -5);
                ctx.lineTo(-10, 5);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
        }
        
        ctx.restore();
        
        // Right side - 3D Circular loop
        ctx.save();
        ctx.translate(800, 250);
        
        // Loop with 3D torus effect
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 8;
        ctx.shadowOffsetY = 8;
        
        // Back half of loop (darker)
        ctx.strokeStyle = '#8b4513';
        ctx.lineWidth = 12;
        ctx.beginPath();
        ctx.ellipse(0, 0, 100, 80, 0, Math.PI, Math.PI * 2);
        ctx.stroke();
        
        // Front half of loop (brighter)
        const loopGradient = ctx.createLinearGradient(-100, 0, 100, 0);
        loopGradient.addColorStop(0, '#cd7f32');
        loopGradient.addColorStop(0.5, '#ffd700');
        loopGradient.addColorStop(1, '#cd7f32');
        
        ctx.strokeStyle = loopGradient;
        ctx.lineWidth = 15;
        ctx.beginPath();
        ctx.ellipse(0, 0, 100, 80, 0, 0, Math.PI);
        ctx.stroke();
        
        // Current flow particles
        for (let i = 0; i < 12; i++) {
            const angle = (time * 0.05 + i * Math.PI / 6) % (Math.PI * 2);
            const x = Math.cos(angle) * 100;
            const y = Math.sin(angle) * 80;
            
            // Particle glow
            const particleGlow = ctx.createRadialGradient(x, y, 0, x, y, 15);
            particleGlow.addColorStop(0, 'rgba(255, 255, 0, 0.9)');
            particleGlow.addColorStop(1, 'rgba(255, 200, 0, 0)');
            
            ctx.fillStyle = particleGlow;
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // 3D Field lines through loop
        for (let y = -40; y <= 40; y += 20) {
            // Create depth effect
            const lineWidth = 3 - Math.abs(y) / 40;
            const opacity = 0.8 - Math.abs(y) / 80;
            
            ctx.strokeStyle = `rgba(79, 172, 254, ${opacity})`;
            ctx.lineWidth = lineWidth;
            ctx.shadowBlur = 5;
            ctx.shadowColor = 'rgba(79, 172, 254, 0.5)';
            
            ctx.beginPath();
            ctx.moveTo(-180, y);
            ctx.lineTo(180, y);
            ctx.stroke();
            
            // 3D Arrows
            const arrowGradient = ctx.createRadialGradient(180, y, 0, 180, y, 10);
            arrowGradient.addColorStop(0, 'rgba(79, 172, 254, 1)');
            arrowGradient.addColorStop(1, 'rgba(79, 172, 254, 0)');
            
            ctx.fillStyle = arrowGradient;
            ctx.beginPath();
            ctx.moveTo(180, y);
            ctx.lineTo(170, y - 5);
            ctx.lineTo(170, y + 5);
            ctx.closePath();
            ctx.fill();
        }
        
        // Central field concentration effect
        const centralGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, 50);
        centralGlow.addColorStop(0, 'rgba(79, 172, 254, 0.3)');
        centralGlow.addColorStop(1, 'rgba(79, 172, 254, 0)');
        
        ctx.fillStyle = centralGlow;
        ctx.beginPath();
        ctx.arc(0, 0, 50, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
        
        // 3D Labels
        ctx.save();
        ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 18px Arial';
        ctx.fillText('Straight Wire', 220, 420);
        ctx.fillText('Right-Hand Thumb Rule', 180, 450);
        ctx.fillText('Circular Loop', 740, 420);
        ctx.fillText('Concentrated Field', 720, 450);
        
        ctx.restore();
        
        time++;
        animationFrames.current = requestAnimationFrame(draw);
    }
    
    draw();
}

// Replace the existing animateElectromagnet function with this enhanced 3D version
function animateElectromagnet() {
    const canvas = document.getElementById('electromagnetCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    let time = 0;
    const turns = parseInt(document.getElementById('turnsSlider')?.value || 100);
    const current = parseFloat(document.getElementById('electromagnetCurrentSlider')?.value || 3);
    
    function draw() {
        // 3D gradient background
        const bgGradient = ctx.createRadialGradient(600, 250, 0, 600, 250, 600);
        bgGradient.addColorStop(0, '#2a5298');
        bgGradient.addColorStop(0.5, '#1e3c72');
        bgGradient.addColorStop(1, '#0a1929');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 3D perspective grid
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.1)';
        ctx.lineWidth = 1;
        
        for (let y = 350; y <= 500; y += 20) {
            const perspective = (y - 350) / 150;
            ctx.beginPath();
            ctx.moveTo(300 - perspective * 50, y);
            ctx.lineTo(900 + perspective * 50, y);
            ctx.stroke();
        }
        
        // Draw 3D electromagnet core with metallic gradient
        ctx.save();
        
        // Core shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.6)';
        ctx.shadowBlur = 20;
        ctx.shadowOffsetX = 10;
        ctx.shadowOffsetY = 10;
        
        // Core top surface (3D effect)
        ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
        ctx.beginPath();
        ctx.moveTo(400, 200);
        ctx.lineTo(420, 180);
        ctx.lineTo(820, 180);
        ctx.lineTo(800, 200);
        ctx.closePath();
        ctx.fill();
        
        // Core side surface (3D effect)
        ctx.fillStyle = 'rgba(100, 100, 100, 0.3)';
        ctx.beginPath();
        ctx.moveTo(800, 200);
        ctx.lineTo(820, 180);
        ctx.lineTo(820, 280);
        ctx.lineTo(800, 300);
        ctx.closePath();
        ctx.fill();
        
        // Core front surface with metallic gradient
        const coreGradient = ctx.createLinearGradient(400, 200, 400, 300);
        coreGradient.addColorStop(0, '#c0c0c0');
        coreGradient.addColorStop(0.5, '#808080');
        coreGradient.addColorStop(1, '#505050');
        
        ctx.fillStyle = coreGradient;
        ctx.fillRect(400, 200, 400, 100);
        
        // Metallic shine
        ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.fillRect(400, 210, 400, 5);
        
        ctx.restore();
        
        // Draw 3D coil windings
        const coilDensity = Math.min(turns / 10, 50);
        
        for (let i = 0; i < coilDensity; i++) {
            const x = 410 + i * (380 / coilDensity);
            
            // Back windings (darker)
            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.ellipse(x, 200, 8, 25, 0, Math.PI, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.ellipse(x, 300, 8, 25, 0, 0, Math.PI);
            ctx.stroke();
            
            // Front windings (brighter with gradient)
            const coilGradient = ctx.createLinearGradient(x - 8, 180, x + 8, 180);
            coilGradient.addColorStop(0, '#cd7f32');
            coilGradient.addColorStop(0.5, '#ffd700');
            coilGradient.addColorStop(1, '#cd7f32');
            
            ctx.strokeStyle = coilGradient;
            ctx.lineWidth = 4;
            
            // Top winding
            ctx.beginPath();
            ctx.ellipse(x, 200, 8, 25, 0, 0, Math.PI);
            ctx.stroke();
            
            // Bottom winding
            ctx.beginPath();
            ctx.ellipse(x, 300, 8, 25, 0, Math.PI, Math.PI * 2);
            ctx.stroke();
            
            // Current flow animation
            if (current > 0 && i % 3 === Math.floor(time / 10) % 3) {
                const glowGradient = ctx.createRadialGradient(x, 200, 0, x, 200, 30);
                glowGradient.addColorStop(0, 'rgba(255, 255, 0, 0.6)');
                glowGradient.addColorStop(1, 'rgba(255, 200, 0, 0)');
                
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(x, 200, 30, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // 3D Magnetic field visualization
        const fieldStrength = (current / 10) * (turns / 100);
        
        if (fieldStrength > 0) {
            // Field lines with 3D effect
            for (let i = -3; i <= 3; i++) {
                if (i === 0) continue;
                
                const opacity = fieldStrength * (1 - Math.abs(i) / 6);
                
                // Create gradient for field lines
                const fieldGradient = ctx.createLinearGradient(300, 250, 900, 250);
                fieldGradient.addColorStop(0, `rgba(255, 107, 107, ${opacity})`);
                fieldGradient.addColorStop(0.5, `rgba(79, 172, 254, ${opacity})`);
                fieldGradient.addColorStop(1, `rgba(79, 172, 254, ${opacity})`);
                
                ctx.strokeStyle = fieldGradient;
                ctx.lineWidth = 3 - Math.abs(i) / 2;
                ctx.setLineDash([10, 5]);
                ctx.lineDashOffset = -time * 0.5;
                
                ctx.beginPath();
                const startY = 250 + i * 35;
                ctx.moveTo(800, startY);
                
                // Create 3D curved path
                ctx.quadraticCurveTo(950, startY + i * 60, 950, 250);
                ctx.quadraticCurveTo(950, 250 - i * 60, 800, 250 - i * 35);
                ctx.lineTo(400, 250 - i * 35);
                ctx.quadraticCurveTo(250, 250 - i * 60, 250, 250);
                ctx.quadraticCurveTo(250, 250 + i * 60, 400, startY);
                ctx.closePath();
                ctx.stroke();
                
                ctx.setLineDash([]);
            }
            
            // Iron filings effect with 3D particles
            for (let i = 0; i < 80; i++) {
                const x = 250 + Math.random() * 700;
                const y = 100 + Math.random() * 300;
                const distance = Math.abs(x - 600) + Math.abs(y - 250);
                const angle = Math.atan2(y - 250, x - 600) + Math.PI/2;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                
                // 3D filing with gradient
                const filingGradient = ctx.createLinearGradient(-3, -10, 3, 10);
                filingGradient.addColorStop(0, `rgba(150, 150, 150, ${fieldStrength})`);
                filingGradient.addColorStop(0.5, `rgba(200, 200, 200, ${fieldStrength})`);
                filingGradient.addColorStop(1, `rgba(100, 100, 100, ${fieldStrength})`);
                
                ctx.fillStyle = filingGradient;
                ctx.fillRect(-3, -10, 6, 20);
                
                ctx.restore();
            }
            
            // Magnetic field glow effect
            const fieldGlow = ctx.createRadialGradient(600, 250, 0, 600, 250, 300);
            fieldGlow.addColorStop(0, `rgba(79, 172, 254, ${fieldStrength * 0.2})`);
            fieldGlow.addColorStop(1, 'rgba(79, 172, 254, 0)');
            
            ctx.fillStyle = fieldGlow;
            ctx.beginPath();
            ctx.arc(600, 250, 300, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // 3D Poles with glow
        if (current > 0) {
            // North pole
            ctx.save();
            ctx.shadowColor = 'rgba(255, 107, 107, 0.8)';
            ctx.shadowBlur = 20;
            
            const northGlow = ctx.createRadialGradient(370, 250, 0, 370, 250, 40);
            northGlow.addColorStop(0, 'rgba(255, 107, 107, 0.8)');
            northGlow.addColorStop(1, 'rgba(255, 107, 107, 0)');
            
            ctx.fillStyle = northGlow;
            ctx.beginPath();
            ctx.arc(370, 250, 40, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('N', 355, 262);
            
            // South pole
            ctx.shadowColor = 'rgba(79, 172, 254, 0.8)';
            
            const southGlow = ctx.createRadialGradient(830, 250, 0, 830, 250, 40);
            southGlow.addColorStop(0, 'rgba(79, 172, 254, 0.8)');
            southGlow.addColorStop(1, 'rgba(79, 172, 254, 0)');
            
            ctx.fillStyle = southGlow;
            ctx.beginPath();
            ctx.arc(830, 250, 40, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#4facfe';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('S', 818, 262);
            
            ctx.restore();
        }
        
        // Display panel with 3D effect
        ctx.save();
        
        // Panel shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;
        
        // Panel background
        const panelGradient = ctx.createLinearGradient(50, 50, 50, 180);
        panelGradient.addColorStop(0, 'rgba(0, 0, 0, 0.3)');
        panelGradient.addColorStop(1, 'rgba(0, 0, 0, 0.5)');
        
        ctx.fillStyle = panelGradient;
        ctx.fillRect(50, 50, 250, 130);
        
        // Panel border
        ctx.strokeStyle = 'rgba(79, 172, 254, 0.5)';
        ctx.lineWidth = 2;
        ctx.strokeRect(50, 50, 250, 130);
        
        // Display text
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 20px Arial';
        ctx.fillText('Electromagnet', 70, 80);
        
        ctx.font = '16px Arial';
        ctx.fillText(`Coil Turns: ${turns}`, 70, 110);
        ctx.fillText(`Current: ${current} A`, 70, 135);
        ctx.fillText(`Field Strength: ${(fieldStrength * 100).toFixed(0)}%`, 70, 160);
        
        ctx.restore();
        
        time++;
        animationFrames.electromagnet = requestAnimationFrame(draw);
    }
    
    draw();
}

        // Chart Setup
        function setupCharts() {
            const ctx1 = document.getElementById('magneticChart');
            if (ctx1) {
                charts.magnetic = new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['0', '2', '4', '6', '8', '10'],
                        datasets: [{
                            label: 'Field Strength vs Current (I)',
                            data: [0, 20, 40, 60, 80, 100],
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        }, {
                            label: 'Field Strength vs Turns (n)',
                            data: [10, 25, 45, 70, 85, 95],
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Magnetic Field Strength Relationships',
                                color: '#ffffff',
                                font: { size: 16 }
                            },
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        },
                        scales: {
                            y: {
                                title: { 
                                    display: true, 
                                    text: 'Field Strength (Relative)', 
                                    color: '#ffffff' 
                                },
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: {
                                title: { 
                                    display: true, 
                                    text: 'Parameter Value', 
                                    color: '#ffffff' 
                                },
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // Complete Lesson Sequence
        class LessonSequence {
            constructor() {
                this.sections = [
                    { id: 'oersted', name: "Oersted's Experiment", duration: 8000 },
                    { id: 'field', name: 'Magnetic Field Lines', duration: 8000 },
                    { id: 'current', name: 'Current Direction Rules', duration: 8000 },
                    { id: 'electromagnet', name: 'Electromagnets', duration: 8000 },
                    { id: 'data', name: 'Data Analysis', duration: 8000 }
                ];
                this.currentSection = 0;
                this.running = false;
            }

            async start() {
                this.stop();
                this.running = true;
                this.currentSection = 0;
                
                this.showProgressBar();
                
                await narrator.speak("Welcome to the comprehensive lesson on magnetic effects of electric current!");
                
                await this.runNextSection();
            }

            showProgressBar() {
                const html = `
                    <div class="lesson-progress">
                        <div class="section-indicator" style="color: #4facfe;">
                            Current Section: <span id="currentSectionName">Starting...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                        <p style="color: #e2e8f0; margin-top: 10px;">
                            Section <span id="currentNum">1</span> of ${this.sections.length}
                        </p>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = html;
            }

            updateProgress() {
                const progress = ((this.currentSection + 1) / this.sections.length) * 100;
                const progressFill = document.getElementById('progressFill');
                const currentSectionName = document.getElementById('currentSectionName');
                const currentNum = document.getElementById('currentNum');
                
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (currentSectionName && this.sections[this.currentSection]) {
                    currentSectionName.textContent = this.sections[this.currentSection].name;
                }
                if (currentNum) currentNum.textContent = this.currentSection + 1;
            }

            async runNextSection() {
                if (!this.running || this.currentSection >= this.sections.length) {
                    if (this.running) {
                        await narrator.speak("Lesson complete! You've mastered the magnetic effects of electric current.");
                        this.showCompletionMessage();
                    }
                    return;
                }

                const section = this.sections[this.currentSection];
                this.updateProgress();
                
                // Clear all animations
                this.clearAnimations();
                
                // Clear all sections
                document.querySelectorAll('.demo-container .display-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                document.querySelectorAll('.content-container .display-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                // Activate current sections
                const sectionElement = document.getElementById(`${section.id}-section`);
                const contentElement = document.getElementById(`${section.id}-content`);
                
                if (sectionElement) sectionElement.classList.add('active');
                if (contentElement) contentElement.classList.add('active');
                
                // Ensure narrator is ready before starting narration
                if (!narrator.enabled) {
                    narrator.enabled = true;
                }
                
                // Start animations and narration
                switch(section.id) {
                    case 'oersted':
                        animateOersted();
                        await narrator.speak("In 1820, Hans Christian Oersted made a groundbreaking discovery. He found that when electric current flows through a wire, it creates a magnetic field around it. This was the first demonstration that electricity and magnetism are connected. When current flows, a nearby compass needle deflects, proving the presence of a magnetic field. The direction and strength of deflection depends on the current direction and magnitude.");
                        break;
                        
                    case 'field':
                        animateFieldLines();
                        await narrator.speak("Magnetic field lines help us visualize the invisible magnetic field. These lines emerge from the north pole and enter the south pole, forming closed loops. Field lines never intersect because at any point in space, the magnetic field has only one direction. The density of field lines indicates field strength - closer lines mean a stronger field. We can map these lines using iron filings or small compasses.");
                        break;
                        
                    case 'current':
                        animateCurrentDirection();
                        await narrator.speak("The right-hand thumb rule helps determine the magnetic field direction around a current-carrying conductor. Hold the wire with your right hand, thumb pointing in the current direction, and your fingers curl in the field direction. For a circular loop, the field lines are concentrated through the center. Multiple loops form a solenoid, creating a strong, uniform field inside.");
                        break;
                        
                    case 'electromagnet':
                        animateElectromagnet();
                        await narrator.speak("Electromagnets are temporary magnets created by passing current through a coil wrapped around a soft iron core. Their strength depends on three factors: the number of coil turns, current strength, and core material. Unlike permanent magnets, electromagnets can be turned on and off, and their strength controlled. They're used in electric motors, MRI machines, magnetic cranes, and many other applications.");
                        break;
                        
                    case 'data':
                        setupCharts();
                        // Ensure narrator is still working
                        if (!narrator.enabled) {
                            narrator.enabled = true;
                        }
                        await narrator.speak("The magnetic field strength follows a linear relationship with both current and number of turns. The formula B equals mu naught times n times I shows this direct proportionality. Doubling the current doubles the field strength. Similarly, doubling the number of turns doubles the field. This predictable relationship makes electromagnets highly controllable and useful in various applications.");
                        break;
                }
                
                await this.wait(section.duration);
                
                if (this.running) {
                    this.currentSection++;
                    await this.runNextSection();
                }
            }

            showCompletionMessage() {
                const html = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #4facfe; margin-bottom: 20px;">
                            üéâ Lesson Complete!
                        </h2>
                        <p style="font-size: 1.2rem;">You've mastered electromagnetic concepts:</p>
                        <ul style="margin: 20px auto; max-width: 400px; text-align: left; list-style: none;">
                            ${this.sections.map(s => `
                                <li style="margin: 10px 0; color: #4facfe;">
                                    ‚úì ${s.name}
                                </li>
                            `).join('')}
                        </ul>
                        <p style="margin-top: 30px;">
                            Explore individual sections or reset to start over.
                        </p>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = html;
            }

            wait(ms) {
                return new Promise(resolve => {
                    this.timeout = setTimeout(resolve, ms);
                });
            }

            stop() {
                this.running = false;
                if (this.timeout) {
                    clearTimeout(this.timeout);
                    this.timeout = null;
                }
                narrator.stop();
                this.clearAnimations();
            }

            clearAnimations() {
                Object.values(animationFrames).forEach(frame => {
                    if (typeof frame === 'number') {
                        cancelAnimationFrame(frame);
                    }
                });
                animationFrames = {};
            }
        }

        // Reset Function
        function resetEverything() {
            lessonStarted = false;
            currentDirection = 1;
            
            if (lessonSequence) {
                lessonSequence.stop();
            }
            narrator.stop();
            
            Object.values(animationFrames).forEach(frame => {
                if (typeof frame === 'number') {
                    cancelAnimationFrame(frame);
                }
            });
            animationFrames = {};
            
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-mode="lesson"]').classList.add('active');
            
            document.querySelectorAll('.display-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('lesson-section').classList.add('active');
            document.getElementById('lessonContent').innerHTML = '';
            
            currentMode = 'lesson';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1500);

            lessonSequence = new LessonSequence();

            // Control buttons
            document.querySelectorAll('.control-btn:not(.reset-btn)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    
                    // Stop any running sequences
                    if (lessonSequence) lessonSequence.stop();
                    narrator.stop();
                    
                    // Clear animations
                    Object.values(animationFrames).forEach(frame => {
                        if (typeof frame === 'number') {
                            cancelAnimationFrame(frame);
                        }
                    });
                    animationFrames = {};
                    
                    // Update active states
                    document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Clear all sections
                    document.querySelectorAll('.display-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    currentMode = mode;
                    
                    // Activate appropriate sections
                    switch(mode) {
                        case 'lesson':
                            document.getElementById('lesson-section').classList.add('active');
                            if (!lessonStarted) {
                                lessonStarted = true;
                                lessonSequence.start();
                            }
                            break;
                            
                        case 'oersted':
                            document.getElementById('oersted-section').classList.add('active');
                            document.getElementById('oersted-content').classList.add('active');
                            animateOersted();
                            narrator.speak("In 1820, Hans Christian Oersted made a groundbreaking discovery. He found that when electric current flows through a wire, it creates a magnetic field around it. This was the first demonstration that electricity and magnetism are connected. When current flows, a nearby compass needle deflects, proving the presence of a magnetic field. The direction and strength of deflection depends on the current direction and magnitude.", true);
                            break;
                            
                        case 'field':
                            document.getElementById('field-section').classList.add('active');
                            document.getElementById('field-content').classList.add('active');
                            animateFieldLines();
                            narrator.speak("Magnetic field lines help us visualize the invisible magnetic field. These lines emerge from the north pole and enter the south pole, forming closed loops. Field lines never intersect because at any point in space, the magnetic field has only one direction. The density of field lines indicates field strength - closer lines mean a stronger field. We can map these lines using iron filings or small compasses.", true);
                            break;
                            
                        case 'current':
                            document.getElementById('current-section').classList.add('active');
                            document.getElementById('current-content').classList.add('active');
                            animateCurrentDirection();
                            narrator.speak("The right-hand thumb rule helps determine the magnetic field direction around a current-carrying conductor. Hold the wire with your right hand, thumb pointing in the current direction, and your fingers curl in the field direction. For a circular loop, the field lines are concentrated through the center. Multiple loops form a solenoid, creating a strong, uniform field inside.", true);
                            break;
                            
                        case 'electromagnet':
                            document.getElementById('electromagnet-section').classList.add('active');
                            document.getElementById('electromagnet-content').classList.add('active');
                            animateElectromagnet();
                            narrator.speak("Electromagnets are temporary magnets created by passing current through a coil wrapped around a soft iron core. Their strength depends on three factors: the number of coil turns, current strength, and core material. Unlike permanent magnets, electromagnets can be turned on and off, and their strength controlled. They're used in electric motors, MRI machines, magnetic cranes, and many other applications.", true);
                            break;
                            
                        case 'data':
                            document.getElementById('data-section').classList.add('active');
                            document.getElementById('data-content').classList.add('active');
                            setupCharts();
                            narrator.speak("The magnetic field strength follows a linear relationship with both current and number of turns. The formula B equals mu naught times n times I shows this direct proportionality. Doubling the current doubles the field strength. Similarly, doubling the number of turns doubles the field. This predictable relationship makes electromagnets highly controllable and useful in various applications.", true);
                            break;
                    }
                });
            });

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', function() {
                narrator.speak("Resetting lesson.", true);
                resetEverything();
            });

            // Audio toggle
            document.getElementById('audio-toggle').addEventListener('click', function() {
                audioEnabled = narrator.toggle();
                this.textContent = audioEnabled ? 'üîä' : 'üîá';
            });

            // Current slider
            const currentSlider = document.getElementById('currentSlider');
            if (currentSlider) {
                currentSlider.addEventListener('input', function() {
                    document.getElementById('currentStrength').textContent = this.value;
                });
            }

            // Reverse current button
            const reverseBtn = document.getElementById('reverseCurrentBtn');
            if (reverseBtn) {
                reverseBtn.addEventListener('click', function() {
                    currentDirection *= -1;
                    narrator.speak(`Current direction ${currentDirection > 0 ? 'forward' : 'reversed'}`, true);
                });
            }

            // Electromagnet sliders
            const turnsSlider = document.getElementById('turnsSlider');
            if (turnsSlider) {
                turnsSlider.addEventListener('input', function() {
                    document.getElementById('coilTurns').textContent = this.value;
                });
            }

            const electromagnetCurrentSlider = document.getElementById('electromagnetCurrentSlider');
            if (electromagnetCurrentSlider) {
                electromagnetCurrentSlider.addEventListener('input', function() {
                    document.getElementById('electromagnetCurrent').textContent = this.value;
                });
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            narrator.stop();
            if (lessonSequence) lessonSequence.stop();
        });
    </script>
</body>
</html>