<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Defects and Their Correction - Interactive Learning Experience</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --eye-gradient: linear-gradient(180deg, #87CEEB 0%, #1E90FF 50%, #4169E1 100%);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --vision-gradient: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-accent: #00bfff;
            --shadow-primary: 0 20px 40px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 25px 50px rgba(0, 0, 0, 0.4);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-particles {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 0 auto 30px;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: scatter 3s ease-in-out infinite;
        }

        .particle:nth-child(1) { background: #87CEEB; left: 100px; top: 100px; animation-delay: 0s; }
        .particle:nth-child(2) { background: #4169E1; left: 100px; top: 100px; animation-delay: 0.3s; }
        .particle:nth-child(3) { background: #1E90FF; left: 100px; top: 100px; animation-delay: 0.6s; }
        .particle:nth-child(4) { background: #00BFFF; left: 100px; top: 100px; animation-delay: 0.9s; }

        @keyframes scatter {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(calc(var(--x) * 50px), calc(var(--y) * 50px)) scale(1.5);
                opacity: 0.7;
            }
            100% {
                transform: translate(calc(var(--x) * 100px), calc(var(--y) * 100px)) scale(0.5);
                opacity: 0;
            }
        }

        .particle:nth-child(1) { --x: 1; --y: -1; }
        .particle:nth-child(2) { --x: -1; --y: -1; }
        .particle:nth-child(3) { --x: -1; --y: 1; }
        .particle:nth-child(4) { --x: 1; --y: 1; }

        .loading-text {
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 600;
            background: var(--eye-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            padding: 50px;
            background: var(--glass-bg);
            border-radius: 30px;
            backdrop-filter: blur(20px);
            margin-bottom: 40px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-primary);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--eye-gradient);
            opacity: 0.3;
            z-index: -1;
            border-radius: 30px;
            animation: eyePulse 5s ease-in-out infinite;
        }

        @keyframes eyePulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            font-size: 3.5rem;
            background: var(--eye-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-weight: 800;
            animation: titleFloat 3s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .main-display {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 40px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-primary);
            position: relative;
        }

        .demo-container {
            height: 500px;
            overflow: hidden;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .content-container {
            overflow-y: auto;
            padding-right: 10px;
            max-height: 600px;
        }

        .content-container::-webkit-scrollbar {
            width: 8px;
        }

        .content-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .content-container::-webkit-scrollbar-thumb {
            background: var(--eye-gradient);
            border-radius: 4px;
        }

        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .control-btn.reset-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .control-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .control-btn.active {
            background: var(--eye-gradient);
            transform: translateY(-2px);
        }

        .display-section {
            display: none;
            animation: fadeInUp 0.8s ease-out;
        }

        .display-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .demo-stage {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 20px;
            border: 2px solid var(--glass-border);
            overflow: hidden;
        }

        .demo-stage canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--text-accent);
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        .info-title {
            color: var(--text-accent);
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .phenomenon-box {
            background: linear-gradient(135deg, rgba(135, 206, 235, 0.1), rgba(30, 144, 255, 0.1));
            border-left: 4px solid #87CEEB;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(135, 206, 235, 0.2);
            backdrop-filter: blur(10px);
        }

        .phenomenon-box h3 {
            color: #87CEEB;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .data-table {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .data-table th {
            background: var(--eye-gradient);
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .interactive-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-accent);
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--eye-gradient);
            cursor: pointer;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            height: 400px;
            position: relative;
        }

        .lesson-progress {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--eye-gradient);
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        #audio-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--eye-gradient);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-primary);
            transition: var(--transition);
        }

        #audio-toggle:hover {
            transform: scale(1.1);
        }

        .example-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .example-card:hover {
            transform: translateX(5px);
        }

        .wavelength-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: 600;
        }

        .myopia-indicator {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .hypermetropia-indicator {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .presbyopia-indicator {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .start-message {
            text-align: center;
            padding: 60px 20px;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .problem-solution {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .problem-solution h4 {
            color: #3498db;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            <div class="loading-text">Preparing Vision Defects Lab...</div>
        </div>
    </div>

    <!-- Audio Control -->
    <button id="audio-toggle" title="Toggle Audio Narration">🔊</button>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>👓 Vision Defects & Their Correction</h1>
            <p>Understanding common refractive defects and how corrective lenses restore clear vision</p>
        </div>

        <!-- Main Display Area -->
        <div class="main-display">
            <!-- Demo Container -->
            <div class="demo-container">
                <!-- Complete Lesson Section -->
                <div class="display-section active" id="lesson-section">
                    <div class="demo-stage">
                        <div id="lessonContent"></div>
                    </div>
                </div>

                <!-- Myopia Section -->
                <div class="display-section" id="myopia-section">
                    <div class="demo-stage">
                        <canvas id="myopiaCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Hypermetropia Section -->
                <div class="display-section" id="hypermetropia-section">
                    <div class="demo-stage">
                        <canvas id="hypermetropiaCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Presbyopia Section -->
                <div class="display-section" id="presbyopia-section">
                    <div class="demo-stage">
                        <canvas id="presbyopiaCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Comparison Section -->
                <div class="display-section" id="comparison-section">
                    <div class="demo-stage">
                        <canvas id="comparisonCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>

                <!-- Problem Solving Section -->
                <div class="display-section" id="problem-section">
                    <div class="demo-stage">
                        <canvas id="problemCanvas" width="1200" height="500"></canvas>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div class="content-container">
                <!-- Myopia Content -->
                <div class="display-section" id="myopia-content">
                    <div class="info-panel">
                        <div class="info-title">🔍 Myopia (Near-sightedness)</div>
                        <p>A person with myopia can see nearby objects clearly but cannot see distant objects distinctly</p>
                    </div>
                    
                    <div class="phenomenon-box">
                        <h3>Key Characteristics</h3>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Far point is nearer than infinity</li>
                            <li>Can see clearly only up to a few metres</li>
                            <li>Image of distant object forms <strong>in front of retina</strong></li>
                        </ul>
                    </div>

                    <div class="example-card">
                        <h4>🔴 Causes of Myopia</h4>
                        <p><strong>(i)</strong> Excessive curvature of the eye lens</p>
                        <p><strong>(ii)</strong> Elongation of the eyeball</p>
                    </div>

                    <div class="example-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(52, 152, 219, 0.1));">
                        <h4>✅ Correction Method</h4>
                        <p>Use a <span class="myopia-indicator">CONCAVE LENS</span> of suitable power</p>
                        <p>The concave lens diverges light rays before they enter the eye, bringing the image back onto the retina</p>
                    </div>
                </div>

                <!-- Hypermetropia Content -->
                <div class="display-section" id="hypermetropia-content">
                    <div class="info-panel">
                        <div class="info-title">🔎 Hypermetropia (Far-sightedness)</div>
                        <p>A person with hypermetropia can see distant objects clearly but cannot see nearby objects distinctly</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Key Characteristics</h3>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Near point is farther than normal (> 25 cm)</li>
                            <li>Must keep reading material beyond 25 cm</li>
                            <li>Image of nearby object forms <strong>behind the retina</strong></li>
                        </ul>
                    </div>

                    <div class="example-card">
                        <h4>🟠 Causes of Hypermetropia</h4>
                        <p><strong>(i)</strong> Focal length of eye lens is too long</p>
                        <p><strong>(ii)</strong> Eyeball has become too small</p>
                    </div>

                    <div class="example-card" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(230, 126, 34, 0.1));">
                        <h4>✅ Correction Method</h4>
                        <p>Use a <span class="hypermetropia-indicator">CONVEX LENS</span> of appropriate power</p>
                        <p>The convex lens provides additional converging power to form the image on the retina</p>
                    </div>
                </div>

                <!-- Presbyopia Content -->
                <div class="display-section" id="presbyopia-content">
                    <div class="info-panel">
                        <div class="info-title">👴 Presbyopia (Age-related vision defect)</div>
                        <p>The power of accommodation decreases with ageing</p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Key Characteristics</h3>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li>Near point gradually recedes with age</li>
                            <li>Difficulty seeing nearby objects comfortably</li>
                            <li>Common in people above 40 years</li>
                        </ul>
                    </div>

                    <div class="example-card">
                        <h4>🟣 Causes of Presbyopia</h4>
                        <p><strong>(i)</strong> Gradual weakening of ciliary muscles</p>
                        <p><strong>(ii)</strong> Diminishing flexibility of the eye lens</p>
                    </div>

                    <div class="example-card" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(142, 68, 173, 0.1));">
                        <h4>✅ Correction Methods</h4>
                        <p>For presbyopia alone: Use <span class="hypermetropia-indicator">CONVEX LENS</span> (reading glasses)</p>
                        <p>For both myopia and hypermetropia: Use <span class="presbyopia-indicator">BI-FOCAL LENSES</span></p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Upper portion: Concave lens (distant vision)</li>
                            <li>Lower portion: Convex lens (near vision)</li>
                        </ul>
                    </div>

                    <div class="info-panel" style="background: rgba(52, 152, 219, 0.2);">
                        <p><strong>Modern Solutions:</strong> Contact lenses or surgical interventions can also correct refractive defects</p>
                    </div>
                </div>

                <!-- Comparison Content -->
                <div class="display-section" id="comparison-content">
                    <div class="info-panel">
                        <div class="info-title">📊 Comparing Vision Defects</div>
                        <p>Understanding the differences between common vision problems</p>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Defect</th>
                                <th>Vision Problem</th>
                                <th>Image Formation</th>
                                <th>Corrective Lens</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Myopia</td>
                                <td>Can't see far objects</td>
                                <td>In front of retina</td>
                                <td>Concave (Diverging)</td>
                            </tr>
                            <tr>
                                <td>Hypermetropia</td>
                                <td>Can't see near objects</td>
                                <td>Behind retina</td>
                                <td>Convex (Converging)</td>
                            </tr>
                            <tr>
                                <td>Presbyopia</td>
                                <td>Age-related near vision loss</td>
                                <td>Behind retina (for near)</td>
                                <td>Convex or Bi-focal</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="phenomenon-box">
                        <h3>Remember</h3>
                        <p>💡 <strong>Concave lens</strong> = Diverges light = Corrects Myopia (far point problem)</p>
                        <p>💡 <strong>Convex lens</strong> = Converges light = Corrects Hypermetropia & Presbyopia (near point problem)</p>
                    </div>
                </div>

                <!-- Problem Solving Content -->
                <div class="display-section" id="problem-content">
                    <div class="info-panel">
                        <div class="info-title">📝 Sample Problem</div>
                        <p>Let's solve a real problem about vision correction</p>
                    </div>

                    <div class="problem-solution">
                        <h4>Question:</h4>
                        <p style="font-size: 1.1rem; margin: 15px 0;">
                            A person with a myopic eye cannot see objects beyond 1.2 m distinctly. 
                            What should be the type of the corrective lens used to restore proper vision?
                        </p>
                    </div>

                    <div class="phenomenon-box">
                        <h3>Solution:</h3>
                        <div style="margin-left: 20px; line-height: 2;">
                            <p><strong>Given:</strong> Far point of myopic eye = 1.2 m</p>
                            <p><strong>Required:</strong> Type of corrective lens</p>
                            <br>
                            <p><strong>Analysis:</strong></p>
                            <ul style="margin-left: 20px;">
                                <li>The person has myopia (near-sightedness)</li>
                                <li>Far point is at 1.2 m instead of infinity</li>
                                <li>Image of distant objects forms in front of retina</li>
                            </ul>
                            <br>
                            <p><strong>Answer:</strong></p>
                            <p style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(52, 152, 219, 0.2)); padding: 15px; border-radius: 10px; margin-top: 10px;">
                                A <span class="myopia-indicator">CONCAVE LENS</span> (diverging lens) should be used. 
                                This lens will diverge the light rays from distant objects so that they appear to come from 1.2 m, 
                                allowing the myopic eye to focus them properly on the retina.
                            </p>
                        </div>
                    </div>

                    <div class="info-panel" style="background: rgba(231, 76, 60, 0.2);">
                        <p><strong>Quick Tip:</strong> For myopia correction, the focal length of the concave lens should equal the negative of the far point distance. In this case, f = -1.2 m</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="control-btn active" data-mode="lesson">🎯 Complete Lesson</button>
            <button class="control-btn" data-mode="myopia">🔍 Myopia</button>
            <button class="control-btn" data-mode="hypermetropia">🔎 Hypermetropia</button>
            <button class="control-btn" data-mode="presbyopia">👴 Presbyopia</button>
            <button class="control-btn" data-mode="comparison">📊 Compare Defects</button>
            <button class="control-btn" data-mode="problem">📝 Problem Solving</button>
            <button class="control-btn reset-btn" data-mode="reset">🔄 Reset Lesson</button>
        </div>
    </div>

    <script>
        // Global Variables
        let audioEnabled = true;
        let currentMode = 'lesson';
        let lessonSequence = null;
        let animationFrames = {};
        let lessonStarted = false;

        // Audio System
        class AudioNarrator {
            constructor() {
                this.synth = window.speechSynthesis;
                this.enabled = true;
                this.speaking = false;
            }

            speak(text, priority = false) {
                if (!this.enabled) return Promise.resolve();
                
                return new Promise((resolve) => {
                    if (priority) {
                        this.stop();
                    }
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.9;
                    
                    utterance.onend = () => {
                        this.speaking = false;
                        resolve();
                    };
                    
                    this.synth.speak(utterance);
                    this.speaking = true;
                });
            }

            stop() {
                this.synth.cancel();
                this.speaking = false;
            }

            toggle() {
                this.enabled = !this.enabled;
                if (!this.enabled) this.stop();
                return this.enabled;
            }
        }

        const narrator = new AudioNarrator();

        // Animation Functions
        function animateMyopia() {
            const canvas = document.getElementById('myopiaCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let time = 0;
            let showingCorrected = false;
            
            function draw() {
                ctx.fillStyle = 'rgba(15, 15, 30, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('MYOPIA (Near-sightedness)', 50, 40);
                
                // Toggle between normal and corrected view
                if (time % 240 === 120) {
                    showingCorrected = !showingCorrected;
                }
                
                // Draw three eyes: Normal, Myopic, Corrected
                
                // Normal Eye
                ctx.save();
                ctx.translate(200, 150);
                ctx.fillStyle = '#2ecc71';
                ctx.font = '14px Arial';
                ctx.fillText('Normal Eye', -40, -80);
                
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 80, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Light rays for normal eye (coming from right)
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(200, -20);
                ctx.lineTo(80, -10);
                ctx.lineTo(-75, 0);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(200, 20);
                ctx.lineTo(80, 10);
                ctx.lineTo(-75, 0);
                ctx.stroke();
                
                // Focus point on retina
                ctx.fillStyle = '#2ecc71';
                ctx.beginPath();
                ctx.arc(-75, 0, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Myopic Eye (Defective)
                ctx.save();
                ctx.translate(200, 280);
                ctx.fillStyle = '#e74c3c';
                ctx.font = '14px Arial';
                ctx.fillText('Myopic Eye', -40, -60);
                
                // Elongated eyeball
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 95, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Light rays focusing before retina (coming from right)
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(200, -20);
                ctx.lineTo(80, -10);
                ctx.lineTo(-55, 0); // Focus before retina
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(200, 20);
                ctx.lineTo(80, 10);
                ctx.lineTo(-55, 0);
                ctx.stroke();
                
                // Show focus point before retina
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(-55, 0, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Blurred image on retina
                ctx.strokeStyle = '#e74c3c';
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(-55, 0);
                ctx.lineTo(-90, -10);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(-55, 0);
                ctx.lineTo(-90, 10);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.restore();
                
                // Corrected Eye
                ctx.save();
                ctx.translate(200, 410);
                
                if (showingCorrected) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.font = '14px Arial';
                    ctx.fillText('Corrected with Concave Lens', -80, -60);
                    
                    // Draw concave lens
                    ctx.strokeStyle = '#3498db';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(150, -25);
                    ctx.quadraticCurveTo(140, 0, 150, 25);
                    ctx.stroke();
                    
                    // Elongated eyeball
                    ctx.strokeStyle = '#87CEEB';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 95, 50, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Light rays with correction
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 1.5;
                    
                    // Rays diverged by lens
                    ctx.beginPath();
                    ctx.moveTo(200, -20);
                    ctx.lineTo(150, -15);
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(80, -12);
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(-90, 0);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(200, 20);
                    ctx.lineTo(150, 15);
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(80, 12);
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(-90, 0);
                    ctx.stroke();
                    
                    // Focus on retina
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(-90, 0, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
                
                // Labels and distant object
                ctx.save();
                ctx.translate(900, 250);
                
                // Draw distant object (tree) - moved to right side
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(20, 20, 20, 40);
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.arc(30, 10, 30, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '16px Arial';
                ctx.fillText('Distant Object', 10, 80);
                
                // Vision clarity indicators
                ctx.font = '14px Arial';
                ctx.fillStyle = '#2ecc71';
                ctx.fillText('✓ Clear vision at all distances', -200, -80);
                
                ctx.fillStyle = '#e74c3c';
                ctx.fillText('✗ Blurred distant vision', -200, 50);
                ctx.fillText('✓ Clear near vision', -200, 70);
                
                if (showingCorrected) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillText('✓ Vision restored with concave lens', -250, 180);
                }
                
                ctx.restore();
                
                time++;
                animationFrames.myopia = requestAnimationFrame(draw);
            }
            
            draw();
        }

        function animateHypermetropia() {
            const canvas = document.getElementById('hypermetropiaCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let time = 0;
            let showingCorrected = false;
            
            function draw() {
                ctx.fillStyle = 'rgba(15, 15, 30, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('HYPERMETROPIA (Far-sightedness)', 50, 40);
                
                // Toggle between normal and corrected view
                if (time % 240 === 120) {
                    showingCorrected = !showingCorrected;
                }
                
                // Normal Eye
                ctx.save();
                ctx.translate(200, 150);
                ctx.fillStyle = '#2ecc71';
                ctx.font = '14px Arial';
                ctx.fillText('Normal Eye', -40, -80);
                
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 80, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Near object rays (coming from right)
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(120, -20);
                ctx.lineTo(80, -10);
                ctx.lineTo(-75, 0);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(120, 20);
                ctx.lineTo(80, 10);
                ctx.lineTo(-75, 0);
                ctx.stroke();
                
                ctx.fillStyle = '#2ecc71';
                ctx.beginPath();
                ctx.arc(-75, 0, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Hypermetropic Eye
                ctx.save();
                ctx.translate(200, 280);
                ctx.fillStyle = '#f39c12';
                ctx.font = '14px Arial';
                ctx.fillText('Hypermetropic Eye', -55, -60);
                
                // Shortened eyeball
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 65, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Light rays focusing behind retina (coming from right)
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(120, -20);
                ctx.lineTo(80, -10);
                ctx.lineTo(-60, -3);
                ctx.lineTo(-90, 0); // Virtual focus behind retina
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(120, 20);
                ctx.lineTo(80, 10);
                ctx.lineTo(-60, 3);
                ctx.lineTo(-90, 0);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Virtual focus point behind retina
                ctx.fillStyle = '#f39c12';
                ctx.beginPath();
                ctx.arc(-90, 0, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Corrected Eye
                ctx.save();
                ctx.translate(200, 410);
                
                if (showingCorrected) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.font = '14px Arial';
                    ctx.fillText('Corrected with Convex Lens', -100, -60);
                    
                    // Draw convex lens
                    ctx.strokeStyle = '#3498db';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(150, -25);
                    ctx.quadraticCurveTo(160, 0, 150, 25);
                    ctx.stroke();
                    
                    // Shortened eyeball
                    ctx.strokeStyle = '#87CEEB';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 65, 50, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Converging rays - rays should appear to come from further right
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(200, -20); // Start from further right
                    ctx.lineTo(150, -15); // Hit lens
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(80, -8); // Bend through lens
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(-60, 0); // Focus on retina
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(200, 20); // Start from further right
                    ctx.lineTo(150, 15); // Hit lens
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(80, 8); // Bend through lens
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(-60, 0); // Focus on retina
                    ctx.stroke();
                    
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(-60, 0, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
                
                // Near object (book)
                ctx.save();
                ctx.translate(900, 250);
                
                // ctx.fillStyle = '#8B4513';
                // ctx.fillRect(30, -390, -400, 30);
                // ctx.fillStyle = '#FFFFFF';
                // ctx.font = '10px Arial';
                // ctx.fillText('BOOK', -400, 0);
                
                ctx.font = '16px Arial';
                ctx.fillText('Near Object (25 cm)', -380, 40);
                
                // Vision indicators
                ctx.font = '14px Arial';
                ctx.fillStyle = '#2ecc71';
                ctx.fillText('✓ Clear vision at 25 cm', -200, -80);
                
                ctx.fillStyle = '#f39c12';
                ctx.fillText('✗ Blurred near vision', -200, 50);
                ctx.fillText('✓ Clear distant vision', -200, 70);
                
                if (showingCorrected) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillText('✓ Vision restored with convex lens', -250, 180);
                }
                
                ctx.restore();
                
                time++;
                animationFrames.hypermetropia = requestAnimationFrame(draw);
            }
            
            draw();
        }

        function animatePresbyopia() {
            const canvas = document.getElementById('presbyopiaCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let time = 0;
            
            function draw() {
                ctx.fillStyle = 'rgba(15, 15, 30, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('PRESBYOPIA (Age-related vision changes)', 50, 40);
                
                // Young eye vs Old eye comparison
                
                // Young Eye
                ctx.save();
                ctx.translate(300, 150);
                
                ctx.fillStyle = '#2ecc71';
                ctx.font = '16px Arial';
                ctx.fillText('Young Eye (Age < 40)', -60, -70);
                
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 80, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Flexible lens (animated)
                const flexAmount = Math.sin(time * 0.03) * 5;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.ellipse(-30, 0, 20 + flexAmount, 30 + flexAmount, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Strong ciliary muscles
                ctx.strokeStyle = '#2ecc71';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.ellipse(-30, 0, 35, 40, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.fillStyle = '#2ecc71';
                ctx.font = '14px Arial';
                ctx.fillText('Strong ciliary muscles', -80, 80);
                ctx.fillText('Flexible lens', -60, 100);
                
                ctx.restore();
                
                // Old Eye
                ctx.save();
                ctx.translate(300, 320);
                
                ctx.fillStyle = '#9b59b6';
                ctx.font = '16px Arial';
                ctx.fillText('Presbyopic Eye (Age > 40)', 75, 50);
                
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 80, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Rigid lens (no animation)
                ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
                ctx.beginPath();
                ctx.ellipse(-30, 0, 20, 30, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Weak ciliary muscles
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.ellipse(-30, 0, 35, 40, 0, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#9b59b6';
                ctx.font = '14px Arial';
                ctx.fillText('Weak ciliary muscles', -80, 80);
                ctx.fillText('Rigid lens', -50, 100);
                
                ctx.restore();
                
                // Bi-focal lens demonstration
                ctx.save();
                ctx.translate(800, 250);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('Bi-focal Lens Solution', -60, -120);
                
                // Draw bi-focal lens
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                
                // Upper part (concave for distance)
                ctx.beginPath();
                ctx.moveTo(-40, -60);
                ctx.quadraticCurveTo(-30, -30, -40, 0);
                ctx.stroke();
                
                ctx.fillStyle = '#e74c3c';
                ctx.font = '12px Arial';
                ctx.fillText('Concave', -100, -30);
                ctx.fillText('(Distance)', -105, -15);
                
                // Lower part (convex for reading)
                ctx.beginPath();
                ctx.moveTo(-40, 0);
                ctx.quadraticCurveTo(-50, 30, -40, 60);
                ctx.stroke();
                
                ctx.fillStyle = '#f39c12';
                ctx.fillText('Convex', -95, 30);
                ctx.fillText('(Reading)', -100, 45);
                
                // Frame
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-40, -60);
                ctx.lineTo(40, -60);
                ctx.lineTo(40, 60);
                ctx.lineTo(-40, 60);
                ctx.closePath();
                ctx.stroke();
                
                // Dividing line
                ctx.strokeStyle = '#888';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(-40, 0);
                ctx.lineTo(40, 0);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.restore();
                
                // Age progression bar
                ctx.save();
                ctx.translate(600, 450);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '14px Arial';
                ctx.fillText('Near Point Distance with Age:', -200, -50);
                
                // Draw scale
                const ages = [20, 30, 40, 50, 60, 70];
                const distances = [10, 15, 25, 40, 60, 100];
                
                for (let i = 0; i < ages.length; i++) {
                    const x = i * 60 - 150;
                    const height = distances[i] * 0.8;
                    
                    const gradient = ctx.createLinearGradient(0, 0, 0, -height);
                    gradient.addColorStop(0, '#2ecc71');
                    gradient.addColorStop(0.5, '#f39c12');
                    gradient.addColorStop(1, '#e74c3c');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x - 15, 0, 30, -height);
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '12px Arial';
                    ctx.fillText(ages[i] + 'y', x - 10, 20);
                    ctx.fillText(distances[i] + 'cm', x - 15, -height - 5);
                }
                
                ctx.restore();
                
                time++;
                animationFrames.presbyopia = requestAnimationFrame(draw);
            }
            
            draw();
        }

        function animateComparison() {
            const canvas = document.getElementById('comparisonCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let time = 0;
            
            function draw() {
                ctx.fillStyle = '#0a0a1a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 24px Arial';
                ctx.fillText('Vision Defects Comparison', 400, 40);
                
                // Draw three eyes side by side
                const defects = [
                    { name: 'MYOPIA', color: '#e74c3c', x: 200 },
                    { name: 'HYPERMETROPIA', color: '#f39c12', x: 600 },
                    { name: 'PRESBYOPIA', color: '#9b59b6', x: 1000 }
                ];
                
                defects.forEach((defect, index) => {
                    ctx.save();
                    ctx.translate(defect.x, 200);
                    
                    // Title
                    ctx.fillStyle = defect.color;
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(defect.name, -50, -120);
                    
                    // Eye shape
                    ctx.strokeStyle = '#87CEEB';
                    ctx.lineWidth = 2;
                    
                    if (defect.name === 'MYOPIA') {
                        // Elongated eye
                        ctx.beginPath();
                        ctx.ellipse(0, 0, 90, 50, 0, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // Focus before retina
                        ctx.strokeStyle = '#FFD700';
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        ctx.moveTo(-150, -20);
                        ctx.lineTo(60, 0);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(-150, 20);
                        ctx.lineTo(60, 0);
                        ctx.stroke();
                        
                        ctx.fillStyle = defect.color;
                        ctx.beginPath();
                        ctx.arc(60, 0, 3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Correction lens
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(-120, -30);
                        ctx.quadraticCurveTo(-110, 0, -120, 30);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '12px Arial';
                        ctx.fillText('Concave Lens', -140, 60);
                        
                    } else if (defect.name === 'HYPERMETROPIA') {
                        // Shortened eye
                        ctx.beginPath();
                        ctx.ellipse(0, 0, 65, 50, 0, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // Focus behind retina
                        ctx.strokeStyle = '#FFD700';
                        ctx.lineWidth = 1.5;
                        ctx.setLineDash([3, 3]);
                        ctx.beginPath();
                        ctx.moveTo(-150, -20);
                        ctx.lineTo(60, -5);
                        ctx.lineTo(90, 0);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(-150, 20);
                        ctx.lineTo(60, 5);
                        ctx.lineTo(90, 0);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        ctx.fillStyle = defect.color;
                        ctx.beginPath();
                        ctx.arc(90, 0, 3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Correction lens
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(-120, -30);
                        ctx.quadraticCurveTo(-130, 0, -120, 30);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '12px Arial';
                        ctx.fillText('Convex Lens', -140, 60);
                        
                    } else {
                        // Normal size but weak muscles
                        ctx.beginPath();
                        ctx.ellipse(0, 0, 75, 50, 0, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // Weak ciliary muscles
                        ctx.strokeStyle = defect.color;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([2, 2]);
                        ctx.beginPath();
                        ctx.ellipse(-30, 0, 30, 35, 0, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Bi-focal lens
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(-120, -30);
                        ctx.quadraticCurveTo(-115, -15, -120, 0);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(-120, 0);
                        ctx.quadraticCurveTo(-125, 15, -120, 30);
                        ctx.stroke();
                        
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '12px Arial';
                        ctx.fillText('Bi-focal Lens', -140, 60);
                    }
                    
                    // Problem indicators
                    ctx.fillStyle = defect.color;
                    ctx.font = '12px Arial';
                    
                    if (defect.name === 'MYOPIA') {
                        ctx.fillText('Far objects blur', -50, 100);
                        ctx.fillText('Near vision OK', -50, 120);
                    } else if (defect.name === 'HYPERMETROPIA') {
                        ctx.fillText('Near objects blur', -55, 100);
                        ctx.fillText('Far vision OK', -45, 120);
                    } else {
                        ctx.fillText('Age-related', -40, 100);
                        ctx.fillText('Near point recedes', -60, 120);
                    }
                    
                    ctx.restore();
                });
                
                // Summary box
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.fillRect(100, 350, 1000, 100);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '16px Arial';
                ctx.fillText('Quick Reference:', 120, 380);
                ctx.font = '14px Arial';
                ctx.fillText('• Myopia → Can\'t see far → Concave lens (diverges light)', 120, 405);
                ctx.fillText('• Hypermetropia → Can\'t see near → Convex lens (converges light)', 120, 425);
                ctx.fillText('• Presbyopia → Age-related → Convex or Bi-focal lens', 620, 405);
                ctx.fillText('• Modern alternatives: Contact lenses, Laser surgery', 620, 425);
                
                time++;
                animationFrames.comparison = requestAnimationFrame(draw);
            }
            
            draw();
        }

        function animateProblem() {
            const canvas = document.getElementById('problemCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let time = 0;
            let step = 0;
            
            function draw() {
                ctx.fillStyle = 'rgba(10, 10, 20, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Problem statement
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 18px Arial';
                ctx.fillText('PROBLEM: Myopic person cannot see beyond 1.2 m', 50, 40);
                
                // Change step every 180 frames
                if (time % 180 === 0) {
                    step = (step + 1) % 4;
                }
                
                // Draw the problem visualization
                ctx.save();
                ctx.translate(600, 250);
                
                // Draw eye
                ctx.strokeStyle = '#87CEEB';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.ellipse(0, 0, 90, 50, 0, 0, Math.PI * 2);
                ctx.stroke();
                
                // Draw 1.2m marker
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(-400, -100);
                ctx.lineTo(-400, 100);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#e74c3c';
                ctx.font = '16px Arial';
                ctx.fillText('1.2 m', -430, -110);
                ctx.fillText('Far Point', -440, 120);
                
                // Draw infinity marker
                ctx.strokeStyle = '#888';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(-550, -100);
                ctx.lineTo(-550, 100);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#888';
                ctx.font = '16px Arial';
                ctx.fillText('∞', -560, -110);
                
                // Animate based on step
                if (step === 0) {
                    // Show problem
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Arial';
                    ctx.fillText('Step 1: Identify the Problem', -100, -150);
                    
                    // Light from distant object
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(-550, -30);
                    ctx.lineTo(-90, -10);
                    ctx.lineTo(60, 0);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-550, 30);
                    ctx.lineTo(-90, 10);
                    ctx.lineTo(60, 0);
                    ctx.stroke();
                    
                    // Focus before retina
                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(60, 0, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = '14px Arial';
                    ctx.fillText('✗ Image forms before retina', 100, 0);
                    
                } else if (step === 1) {
                    // Show analysis
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Arial';
                    ctx.fillText('Step 2: Analyze the Defect', -100, -150);
                    
                    ctx.fillStyle = '#f39c12';
                    ctx.font = '14px Arial';
                    ctx.fillText('• Person has MYOPIA', -100, -190);
                    ctx.fillText('• Far point = 1.2 m (instead of ∞)', -100, -170);
                    ctx.fillText('• Needs diverging lens', 200, -190);
                    
                } else if (step === 2) {
                    // Show solution
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Arial';
                    ctx.fillText('Step 3: Apply Correction', -100, -150);
                    
                    // Draw concave lens
                    ctx.strokeStyle = '#3498db';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(-200, -35);
                    ctx.quadraticCurveTo(-190, 0, -200, 35);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#3498db';
                    ctx.font = '14px Arial';
                    ctx.fillText('Concave Lens', -240, -50);
                    ctx.fillText('f = -1.2 m', -230, 60);
                    
                    // Corrected light path
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(-550, -30);
                    ctx.lineTo(-200, -20);
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(-90, -12);
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(85, 0);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(-550, 30);
                    ctx.lineTo(-200, 20);
                    ctx.strokeStyle = '#3498db';
                    ctx.lineTo(-90, 12);
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineTo(85, 0);
                    ctx.stroke();
                    
                    // Focus on retina
                    ctx.fillStyle = '#2ecc71';
                    ctx.beginPath();
                    ctx.arc(85, 0, 4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#2ecc71';
                    ctx.font = '14px Arial';
                    ctx.fillText('✓ Image now on retina!', 100, 0);
                    
                } else if (step === 3) {
                    // Show result
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Arial';
                    ctx.fillText('Step 4: Result', -100, -150);
                    
                    // Success message
                    ctx.fillStyle = '#2ecc71';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText('SOLUTION: Use CONCAVE LENS', -120, 150);
                    ctx.font = '14px Arial';
                    ctx.fillText('The lens diverges light to make distant objects', -150, 175);
                    ctx.fillText('appear to come from 1.2 m, within eye\'s range', -150, 195);
                }
                
                ctx.restore();
                
                // Formula box
                if (step >= 2) {
                    ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
                    ctx.fillRect(850, 300, 320, 130);
                    
                    // Improve text rendering for formula
                    ctx.textBaseline = 'top';
                    ctx.textAlign = 'left';
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '16px Arial';
                    ctx.fillText('Lens Formula:', 870, 325);
                    ctx.font = '14px Arial';
                    ctx.fillText('For correction:', 870, 350);
                    ctx.fillText('Focal length = -(Far point)', 870, 370);
                    ctx.fillText('f = -1.2 m', 870, 390);
                }
                
                time++;
                animationFrames.problem = requestAnimationFrame(draw);
            }
            
            draw();
        }

        // Complete Lesson Sequence
        class LessonSequence {
            constructor() {
                this.sections = [
                    { id: 'myopia', name: 'Myopia (Near-sightedness)', duration: 10000 },
                    { id: 'hypermetropia', name: 'Hypermetropia (Far-sightedness)', duration: 10000 },
                    { id: 'presbyopia', name: 'Presbyopia (Age-related)', duration: 10000 },
                    { id: 'comparison', name: 'Comparing Defects', duration: 8000 },
                    { id: 'problem', name: 'Problem Solving', duration: 12000 }
                ];
                this.currentSection = 0;
                this.running = false;
            }

            async start() {
                this.stop();
                this.running = true;
                this.currentSection = 0;
                
                this.showProgressBar();
                
                await narrator.speak("Welcome! Let's learn about vision defects and how corrective lenses restore clear sight. The eye may gradually lose its power of accommodation, causing blurred vision.");
                
                await this.runNextSection();
            }

            showStartMessage() {
                const html = `
                    <div class="start-message">
                        <h2 style="color: #87CEEB; margin-bottom: 20px;">
                            👓 Ready to Learn About Vision Defects?
                        </h2>
                        <p style="font-size: 1.2rem; color: #e2e8f0; margin-bottom: 30px;">
                            Click "Complete Lesson" to explore how vision problems occur and how they're corrected!
                        </p>
                        <div style="color: #87CEEB;">
                            <p>You'll learn about:</p>
                            <ul style="list-style: none; margin-top: 10px;">
                                <li>✓ Myopia (Near-sightedness)</li>
                                <li>✓ Hypermetropia (Far-sightedness)</li>
                                <li>✓ Presbyopia (Age-related changes)</li>
                                <li>✓ Corrective Lenses (Concave, Convex, Bi-focal)</li>
                                <li>✓ Problem Solving Techniques</li>
                            </ul>
                        </div>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = html;
            }

            showProgressBar() {
                const html = `
                    <div class="lesson-progress">
                        <div class="section-indicator" style="color: #87CEEB;">
                            Current Section: <span id="currentSectionName">Starting...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                        <p style="color: #e2e8f0; margin-top: 10px;">
                            Section <span id="currentNum">1</span> of ${this.sections.length}
                        </p>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = html;
            }

            updateProgress() {
                const progress = ((this.currentSection + 1) / this.sections.length) * 100;
                const progressFill = document.getElementById('progressFill');
                const currentSectionName = document.getElementById('currentSectionName');
                const currentNum = document.getElementById('currentNum');
                
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (currentSectionName && this.sections[this.currentSection]) {
                    currentSectionName.textContent = this.sections[this.currentSection].name;
                }
                if (currentNum) currentNum.textContent = this.currentSection + 1;
            }

            async runNextSection() {
                if (!this.running || this.currentSection >= this.sections.length) {
                    if (this.running) {
                        await narrator.speak("Excellent! You now understand vision defects and their corrections. Remember: Concave lenses for myopia, convex lenses for hypermetropia and presbyopia!");
                        this.showCompletionMessage();
                    }
                    return;
                }

                const section = this.sections[this.currentSection];
                this.updateProgress();
                
                // Clear all animations
                this.clearAnimations();
                
                // Clear all sections
                document.querySelectorAll('.demo-container .display-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                document.querySelectorAll('.content-container .display-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                // Activate current sections
                document.getElementById(`${section.id}-section`).classList.add('active');
                document.getElementById(`${section.id}-content`).classList.add('active');
                
                // Start animations and narration
                switch(section.id) {
                    case 'myopia':
                        animateMyopia();
                        await narrator.speak("Myopia, or near-sightedness, occurs when a person can see nearby objects clearly but cannot see distant objects distinctly. The far point is nearer than infinity. This happens because the image forms in front of the retina, either due to excessive curvature of the eye lens or elongation of the eyeball. It's corrected using a concave lens that diverges light rays.");
                        break;
                        
                    case 'hypermetropia':
                        animateHypermetropia();
                        await narrator.speak("Hypermetropia, or far-sightedness, is when a person can see distant objects clearly but cannot see nearby objects distinctly. The near point is farther than the normal 25 centimeters. Light from nearby objects focuses behind the retina. This occurs when the focal length of the eye lens is too long or the eyeball is too small. A convex lens provides the additional focusing power needed.");
                        break;
                        
                    case 'presbyopia':
                        animatePresbyopia();
                        await narrator.speak("Presbyopia is an age-related condition where the power of accommodation decreases. The near point gradually recedes with age due to weakening ciliary muscles and diminishing lens flexibility. People often need reading glasses with convex lenses. If someone has both myopia and hypermetropia, bi-focal lenses are used - concave on top for distance, convex below for reading.");
                        break;
                        
                    case 'comparison':
                        animateComparison();
                        await narrator.speak("Let's compare these defects: Myopia affects far vision and needs concave lenses. Hypermetropia affects near vision and needs convex lenses. Presbyopia is age-related and typically needs convex or bi-focal lenses. Modern alternatives include contact lenses and surgical interventions.");
                        break;
                        
                    case 'problem':
                        animateProblem();
                        await narrator.speak("Here's a practical problem: A myopic person can't see beyond 1.2 meters. Since they have myopia with a far point at 1.2 meters instead of infinity, they need a concave lens. The focal length should be negative 1.2 meters. This diverging lens makes distant objects appear to come from within the eye's range, restoring clear vision.");
                        break;
                }
                
                await this.wait(section.duration);
                
                if (this.running) {
                    this.currentSection++;
                    await this.runNextSection();
                }
            }

            showCompletionMessage() {
                const html = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #87CEEB; margin-bottom: 20px;">
                            🎉 Lesson Complete!
                        </h2>
                        <p style="font-size: 1.2rem;">You've mastered vision defects and their corrections!</p>
                        <ul style="margin: 20px auto; max-width: 400px; text-align: left; list-style: none;">
                            ${this.sections.map(s => `
                                <li style="margin: 10px 0; color: #87CEEB;">
                                    ✓ ${s.name}
                                </li>
                            `).join('')}
                        </ul>
                        <p style="margin-top: 30px;">
                            Explore individual sections or click Reset to start over.
                        </p>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = html;
            }

            wait(ms) {
                return new Promise(resolve => {
                    this.timeout = setTimeout(resolve, ms);
                });
            }

            stop() {
                this.running = false;
                if (this.timeout) {
                    clearTimeout(this.timeout);
                    this.timeout = null;
                }
                narrator.stop();
                this.clearAnimations();
            }

            reset() {
                this.stop();
                lessonStarted = false;
                this.showStartMessage();
            }

            clearAnimations() {
                Object.values(animationFrames).forEach(frame => {
                    if (typeof frame === 'number') {
                        cancelAnimationFrame(frame);
                    }
                });
                animationFrames = {};
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1500);

            lessonSequence = new LessonSequence();
            lessonSequence.showStartMessage();

            // Control buttons
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    
                    // Handle reset button
                    if (mode === 'reset') {
                        lessonSequence.reset();
                        document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-mode="lesson"]').classList.add('active');
                        
                        document.querySelectorAll('.display-section').forEach(section => {
                            section.classList.remove('active');
                        });
                        document.getElementById('lesson-section').classList.add('active');
                        
                        narrator.speak("Lesson has been reset. Click 'Complete Lesson' to start again!", true);
                        return;
                    }
                    
                    // Stop any running sequences
                    if (lessonSequence) lessonSequence.stop();
                    narrator.stop();
                    
                    // Clear animations
                    Object.values(animationFrames).forEach(frame => {
                        if (typeof frame === 'number') {
                            cancelAnimationFrame(frame);
                        }
                    });
                    animationFrames = {};
                    
                    // Update active states
                    document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Clear all sections
                    document.querySelectorAll('.display-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    currentMode = mode;
                    
                    // Activate appropriate sections
                    switch(mode) {
                        case 'lesson':
                            document.getElementById('lesson-section').classList.add('active');
                            if (!lessonStarted) {
                                lessonStarted = true;
                                lessonSequence.start();
                            }
                            break;
                            
                        case 'myopia':
                            document.getElementById('myopia-section').classList.add('active');
                            document.getElementById('myopia-content').classList.add('active');
                            animateMyopia();
                            narrator.speak("Myopia or near-sightedness: can see near objects but not distant ones. The image forms before the retina. Corrected with concave lenses that diverge light.", true);
                            break;
                            
                        case 'hypermetropia':
                            document.getElementById('hypermetropia-section').classList.add('active');
                            document.getElementById('hypermetropia-content').classList.add('active');
                            animateHypermetropia();
                            narrator.speak("Hypermetropia or far-sightedness: can see distant objects but not near ones. The image forms behind the retina. Corrected with convex lenses that converge light.", true);
                            break;
                            
                        case 'presbyopia':
                            document.getElementById('presbyopia-section').classList.add('active');
                            document.getElementById('presbyopia-content').classList.add('active');
                            animatePresbyopia();
                            narrator.speak("Presbyopia is age-related vision decline. Ciliary muscles weaken and the lens loses flexibility. Corrected with convex lenses or bi-focals for those with multiple defects.", true);
                            break;
                            
                        case 'comparison':
                            document.getElementById('comparison-section').classList.add('active');
                            document.getElementById('comparison-content').classList.add('active');
                            animateComparison();
                            narrator.speak("Compare the three defects: Myopia needs concave lenses, Hypermetropia needs convex lenses, and Presbyopia typically needs convex or bi-focal lenses.", true);
                            break;
                            
                        case 'problem':
                            document.getElementById('problem-section').classList.add('active');
                            document.getElementById('problem-content').classList.add('active');
                            animateProblem();
                            narrator.speak("Sample problem: For a myopic person who can't see beyond 1.2 meters, use a concave lens with focal length negative 1.2 meters to correct the vision.", true);
                            break;
                    }
                });
            });

            // Audio toggle
            document.getElementById('audio-toggle').addEventListener('click', function() {
                audioEnabled = narrator.toggle();
                this.textContent = audioEnabled ? '🔊' : '🔇';
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            narrator.stop();
            if (lessonSequence) lessonSequence.stop();
        });
    </script>
</body>
</html>