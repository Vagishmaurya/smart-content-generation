/**
 * If I Were You - Story Content
 */

// Story content
const storyContent = `
<div class="story-section">
    <h3 class="section-subtitle">SCENE</h3>
    <p>A small cottage interior. There is an entrance back right (which may be curtained). Another door to the left must be a practical door. The furniture is simple, consisting of a small table towards the left, a chair or two, and a divan rather upstage on the right. On the table is a telephone.</p>

    <p>(When the curtain rises Gerrard is standing by the table making a phone call. He is of medium height, and wearing horn-rimmed glasses . . . He is dressed in a lounge suit and a great coat. His voice is <span class="highlight-vocab" data-definition="sophisticated; well mannered">cultured</span>.)</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">. .. Well, tell him to phone up directly. I must know ... Yes, I expect I'll still be here, but you mustn't <span class="highlight-vocab" data-definition="depend on; rely on">count on</span> that ... In about ten minutes' time. Right-ho. Goodbye.</p>

    <p>(He puts down the phone and goes to the divan on the left, where there is a travelling bag, and starts packing. Whilst he is thus <span class="highlight-vocab" data-definition="occupied; busy">engaged</span>, another man, similar in build to Gerrard enters from the right silently — revolver in hand. He is flashily dressed in an overcoat and a soft hat. He bumps accidentally against the table, and at the sound Gerrard turns quickly.)</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">(pleasantly) Why, this is a surprise, Mr— er —</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I'm glad you're pleased to see me. I don't think you'll be pleased for long. Put those paws up!</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">This is all very <span class="highlight-vocab" data-definition="exaggerated">melodramatic</span>, not very original, perhaps, but…</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Trying to be calm and — er—</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">'<span class="highlight-vocab" data-definition="showing a lack of interest or excitement">Nonchalant</span>' is your word, I think.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Thanks a lot. You'll soon stop being smart. I'll make you crawl. I want to know a few things, see.</p>

    <p class="highlighted-quote">"You'll soon stop being smart. I'll make you crawl."</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Anything you like. I know all the answers. But before we begin I should like to change my position; you may be comfortable, but I am not.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Sit down there, and no funny business. (Motions to a chair, and seats himself on the divan by the bag.) Now then, we'll have a nice little talk about yourself!</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">At last a sympathetic audience! I'll tell you the story of my life. How as a child I was stolen by the gypsies, and why at the age of thirty-two, I find myself in my lonely Essex cottage, how ...</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Keep it to yourself, and just answer my questions. You live here alone? Well, do you?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">I'm sorry. I thought you were telling me, not asking me. A question of <span class="highlight-vocab" data-definition="here, a tone of voice">inflection</span>; your voice is unfamiliar.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(with emphasis) Do you live here alone?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">And if I don't answer?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">You've got enough sense not to want to get hurt.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">I think good sense is shown more in the ability to avoid pain than in the mere desire to do so. What do you think, Mr— er—</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Never mind my name. I like yours better, Mr Gerrard. What are your Christian names?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Vincent Charles.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Do you run a car?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">No.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">That's a lie. You're not dealing with a fool. I'm as smart as you and smarter, and I know you run a car. Better be careful, <span class="highlight-vocab" data-definition="(American English) a person who pretends to know a lot">wise guy</span>!</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Are you American, or is that merely a clever imitation?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Listen, this gun's no toy. I can hurt you without killing you, and still get my answers.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Of course, if you put it like that, I'll be glad to assist you. I do possess a car, and it's in the garage round the corner.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">That's better. Do people often come out here?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Very rarely. Surprisingly few people take the trouble to visit me. There's the baker and the greengrocer, of course; and then there's the milkman — quite charming, but no one so interesting as yourself.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I happen to know that you never see <span class="highlight-vocab" data-definition="merchants">tradespeople</span>.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">You seem to have taken a considerable amount of trouble. Since you know so much about me, won't you say something about yourself? You have been so modest.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I could tell you plenty. You think you're smart, but I'm the top of the class round here. I've got brains and I use them. That's how I've got where I have.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">And where precisely have you got? It didn't require a great brain to break into my little cottage.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">When you know why I've broken into your little cottage, you'll be surprised, and it won't be a pleasant surprise.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">With you figuring so largely in it, that is understandable. By the way, what particular line of crime do you embrace, or aren't you a specialist?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">My speciality's jewel robbery. Your car will do me a treat. It's certainly <span class="highlight-vocab" data-definition="an informal expression for a fashionable vehicle">a dandy bus</span>.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">I'm afraid jewels are few and far between in the wilds of Essex.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">So are the cops. I can retire here nicely for a little while.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">You mean to live with me? A trifle sudden isn't it; you've not been invited.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">You won't be here long; so I didn't trouble to ask.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">What do you mean?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">This is your big surprise. I'm going to kill you.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">A little harsh, isn't it?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(with heavy sarcasm) Yeah, I'll be sorry to do it. I've taken a fancy to you, but it's just got to be done.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Why add murder to your other crimes? It's a grave step you're taking.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I'm not taking it for fun. I've been hunted long enough. I'm wanted for murder already, and they can't hang me twice.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">You're planning a <span class="highlight-vocab" data-definition="unnecessary and usually harmful">gratuitous</span> double, so to speak. Admitted you've nothing to lose, but what have you to gain?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I've got freedom to gain. As for myself, I'm a poor hunted rat. As Vincent Charles Gerrard I'm free to go places and do nothing. I can eat well and sleep and without having to be ready to beat it at the sight of a cop.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">In most melodramas the villain is foolish enough to delay his killing long enough to be frustrated. You are much luckier.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">I'm O.K. I've got a reason for everything. I'm going to be Vincent Charles Gerrard, see. I've got to know what he talks like. Now I know. That posh stuff comes easy. This is Mr V.C. Gerrard speaking. (Pantomime of phoning, in imitation cultured voice.) And that's not all. (He stands up.) Get up a minute (Gerrard stands.) Now take a look at me.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">You're not particularly decorative.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">No! Well, that goes for you, too. I've only got to wear specs and I'll be enough like you to get away with it.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">What about your clothes? They'll let you down if you're not careful.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">That'll be all right. Yours will fit me fine.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">That is extremely interesting, but you seem to miss the point of my remark. I said, you were luckier than most melodramatic villains. It was not a tribute to your intelligence. You won't kill me for a very good reason.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">So that's what you think.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">You'll let me go, and thank God you didn't shoot sooner.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Come on. What's on your mind! Better be quick. This conversation bores me.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Your idea is to elude the police by killing me and taking on my identity?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Yes, I like the idea.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">But are you sure it's going to help you?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Now listen here. I've got this all planned. I did a job in town. Things went wrong and I killed a cop. Since then I've done nothing but <span class="highlight-vocab" data-definition="avoid">dodge</span>.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">And this is where dodging has brought you?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">It brought me to Aylesbury. That's where I saw you in the car. Two other people saw you and started to talk. I listened. It looks like you're a bit queer — kind of a mystery man.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">A mystery which I propose to explain.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(disregarding him) You phone your orders and sometimes you go away suddenly and come back just the same. Those are just the things I want to do. Hearing about you was one of my <span class="highlight-vocab" data-definition="an unexpected opportunity for success">lucky breaks</span>.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Apparently you haven't the intelligence to ask why I am invested in this cloak of mystery.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(preparing to shoot) As I said before, this conversation bores me.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Don't be a fool. If you shoot, you'll hang for sure. If not as yourself, then as Vincent Charles Gerrard.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">What is this?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">This is your big surprise. I said you wouldn't kill me and I was right. Why do you think I am here today and gone tomorrow, never see tradespeople? You say my habits would suit you. You are a crook. Do you think I am a <span class="highlight-vocab" data-definition="a Christian religious teacher who teaches on Sundays in Church">Sunday-school teacher</span>?</p>
    
    <p class="dialogue">The game's up as far as I'm concerned. Things went wrong with me. I said it with bullets and got away. Unfortunately they got one of my men, and found things the fool should have burnt. Tonight I'm expecting trouble. My bag's packed ready to clear off. There it is.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">It's a bag all right and this is a gun all right. What's all this?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">That's a disguise outfit; false moustaches and what not. Now do you believe me?</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(musingly) I don't know.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">For God's sake clear that muddled head of yours and let's go. Come with me in the car. I can use you. If you find it's a <span class="highlight-vocab" data-definition="trap">frame</span>, you've got me in the car, and you've still got your gun.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">May be you're right.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Then don't waste time. (Goes and picks up hat and bag.)</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">Careful, boss, I'm watching you.</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">I have got a man posted on the main road. He'll ring up if he sees the police, but I don't want to leave ... (telephone bell rings) Come on! They're after us. Through here straight to the garage.</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">How do I know that you are telling the truth?</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Oh, don't be a fool. Look for yourself.</p>

    <p>(Gerrard opens door and steps away. Intruder leans forward to inspect it, with his side towards Gerrard, but with the revolver ready. As he turns his head, Gerrard gives him a push into the cupboard, knocking the revolver out of his hand. He slams the door and locks it, picks up the revolver and goes to the phone, where he stands with the gun pointed at the cupboard door.)</p>

    <p class="character-name">INTRUDER:</p>
    <p class="dialogue">(rattles door and shouts) Let me out of here!</p>

    <p class="character-name">GERRARD:</p>
    <p class="dialogue">Hello. Yes, speaking. Sorry I can't let you have the props in time for rehearsal, I've had a spot of bother — quite amusing. I think I'll put it in my next play. Listen, can you tell our friend the Sergeant to come up here at once? You'll probably find him in the Public Bar.</p>

    <p class="play-end">DOUGLAS JAMES</p>
</div>
`;

// Function to handle read aloud for the story
function readStoryAloud() {
    // Check if we have the narrator functionality available
    if (!window.narrator) {
        console.error('Narrator functionality not available');
        return;
    }
    
    // Get the story content element
    const storyContentElement = document.getElementById('storyContent');
    
    // Add reading indicator
    const indicator = document.createElement('div');
    indicator.className = 'reading-indicator';
    indicator.innerHTML = '<div class="reading-spinner"></div> <span>Reading story aloud...</span>';
    storyContentElement.prepend(indicator);
    
    // Extract paragraphs for reading
    const paragraphs = storyContentElement.querySelectorAll('p');
    let storyText = '';
    paragraphs.forEach(p => {
        // Skip character names and just focus on dialogue and narration
        if (!p.classList.contains('character-name') && !p.classList.contains('play-end')) {
            storyText += p.textContent + " ";
        }
    });

    // Removed paragraph highlighting functionality
    window.highlightTimeouts = [];

    // Break the story into manageable chunks
    const storyChunks = storyText.match(/.{1,300}(?:\s|$)/g) || [storyText];
    let currentChunkIndex = 0;
    
    // Function to read the next chunk
    const readNextChunk = () => {
        if (currentChunkIndex >= storyChunks.length) {
            // We're done, remove the reading indicator
            indicator.classList.add('fade-out');
            setTimeout(() => {
                indicator.remove();
            }, 500);
            return;
        }
        
        // Paragraph highlighting functionality has been removed
        
        // Set callback for when this chunk ends
        window.narrator.onEndCallback = () => {
            currentChunkIndex++;
            window.readingTimeout = setTimeout(readNextChunk, 500); // Small pause between chunks
        };
        
        // Read the current chunk
        window.narrator.speak(storyChunks[currentChunkIndex]);
    };
    
    // Start reading
    readNextChunk();
}

// Function to highlight vocabulary in the story
function highlightVocabulary() {
    // Get all vocabulary spans
    const vocabSpans = document.querySelectorAll('.highlight-vocab');
    
    // Toggle their visibility
    vocabSpans.forEach(span => {
        span.classList.toggle('active');
        
        // If we're activating, ensure tooltip is created
        if (span.classList.contains('active')) {
            // Check if tooltip already exists
            if (!span.querySelector('.vocab-tooltip')) {
                const tooltip = document.createElement('span');
                tooltip.className = 'vocab-tooltip';
                tooltip.textContent = span.dataset.definition;
                span.appendChild(tooltip);
            }
        }
    });
    
    // Show a message to the user
    const storyContent = document.getElementById('storyContent');
    const feedbackMsg = document.createElement('div');
    feedbackMsg.className = 'feedback-message show success';
    
    if (vocabSpans[0]?.classList.contains('active')) {
        feedbackMsg.textContent = 'Vocabulary highlighting is now ON. Hover over highlighted words to see definitions.';
    } else {
        feedbackMsg.textContent = 'Vocabulary highlighting is now OFF.';
    }
    
    storyContent.prepend(feedbackMsg);
    
    // Remove the message after 3 seconds
    setTimeout(() => {
        feedbackMsg.classList.add('fade-out');
        setTimeout(() => {
            feedbackMsg.remove();
        }, 500);
    }, 3000);
}

// No poem content in this chapter

// Additional styling for story
document.addEventListener('DOMContentLoaded', function() {
    // Apply custom styling to story elements
    const style = document.createElement('style');
    style.innerHTML = `
        .character-name {
            font-weight: bold;
            color: #4a6572;
            margin-bottom: 5px;
            margin-top: 15px;
        }
        
        .dialogue {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .highlighted-quote {
            font-style: italic;
            font-size: 1.2em;
            color: #f78361;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .play-end {
            text-align: right;
            font-weight: bold;
            margin-top: 30px;
            font-style: italic;
        }
        
        .section-subtitle {
            color: #333;
            font-size: 1.2rem;
            margin: 20px 0 10px;
            text-align: center;
        }
        
        .story-section p {
            line-height: 1.8;
        }
    `;
    document.head.appendChild(style);
});
