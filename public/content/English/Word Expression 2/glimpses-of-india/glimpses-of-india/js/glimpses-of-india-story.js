/**
 * Story content and related functions for Glimpses of India
 */

// Story Content
const storyContent = {
    part1: `
        <div class="story-part active" id="storyPart1">
            <h3 class="story-part-title">Text I: The Parsi Community in India</h3>
            
            <p>The following is an excerpt about the Parsi community in India and their food. Read the passage and answer the questions.</p>
            
            <p>"<span class="highlight-vocab" data-meaning="Come!">Aavoji, aavo, aavo</span>! Welcome to Delhi! Let me show you my beautiful city." The booming voice of Nowrosji Kapadia could be heard across the <span class="highlight-vocab" data-meaning="In all directions">length and breadth</span> of the platform. It was Nowrosji's favourite pastime: a walk to the Old Delhi railway station to greet the Frontier Mail as it <span class="highlight-vocab" data-meaning="Moved with a characteristic steam engine sound">chugged into</span> Delhi from Mumbai to Peshawar. With this refrain, an eager Nowrosji would <span class="highlight-vocab" data-meaning="Persuade someone to do something">cajole</span> Parsi visitors off the train and take them home for a meal and often persuade some to stay overnight or for a few days. He would use this opportunity to tell them about the advantages of shifting to Delhi. Though his wife Jer Bai would occasionally object to unknown visitors, she was always <span class="highlight-vocab" data-meaning="Rejected, ignored">overruled</span>. This was the beginning of the community of Parsis in Delhi...</p>
            
            <p>Writing about Parsis in the Delhi of old is not easy. There are memories of my grandparents and parents — a collective memory of generations past and people <span class="highlight-vocab" data-meaning="Departed, no longer present">long gone</span>, yet here in spirit....</p>
            
            <p>During festive gatherings, the women went to town with the food; <span class="highlight-vocab" data-meaning="Hiring external caterers">outside catering</span> was unheard of. The poorer members of the community never knew who had paid for what. This tradition continued in the northern cities of Lucknow, Kanpur, and Allahabad well into the '70s. Sadly, that kind of life has almost gone forever.</p>
            
            <p>Food preparations began two days in advance. Dar ni pori (rich pastry stuffed with sweetened lentils) and malido (halwa) were carried in big vatus (pots) and served with puris. Anyone who has made malido can <span class="highlight-vocab" data-meaning="Verify, confirm">vouch for</span> the fact that you need strong biceps; it is an exhausting exercise. The first time I made it under my grandmother's supervision was also the last. I could hardly move my arms for the next two days! Since then, I gained a healthy respect for my <span class="highlight-vocab" data-meaning="Delicate, small and fine">dainty</span> grandmother.</p>
            
            <p>The menu was <span class="highlight-vocab" data-meaning="Large and varied">extensive</span>. Breakfast would start with either sev—brown vermicelli cooked in milk and served with fresh cream—or ravo, semolina pudding, Mithu dahi or sweetened curd made with full cream milk was an absolute must. This was followed by bafellaeeda, hard-boiled eggs, and kheemo kaleji, mutton mince with liver. For lunch, there was almost always smori dal chawal and macchi no patio — white boiled rice with yellow dal offset by a tart and tangy fish curry.</p>
            
            <p>Teatime was special at our home. My grandmother made it a point to dress for tea; I was made to do the same. Once we were ready, <span class="highlight-vocab" data-meaning="Appeared suddenly">out came the treats</span>: Parsi biscuits — batasa, nan-khatai and flaky khari; patrel, rolled, steamed arbi leaves stuffed with besan masala; kumas, rich Parsi cake; and my favourite, bhakra, sweet deep fried doughnuts. That tradition has stayed with me. I certainly don't dress up, but I still need a snack with at least three cups of tea!...</p>
            
            <div class="vocabulary-note">
                <span class="word">cajole:</span> <span class="definition">to persuade someone to do something by sustained coaxing or flattery</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">dainty:</span> <span class="definition">delicately small and pretty</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">extensive:</span> <span class="definition">covering or affecting a large area; having a wide range</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">overruled:</span> <span class="definition">to reject or disallow by exercising one's superior authority</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">vouch:</span> <span class="definition">to confirm or support as being true</span>
            </div>
        </div>
    `,
    part2: `
        <div class="story-part" id="storyPart2">
            <h3 class="story-part-title">Text II: Coffee in Araku Valley</h3>
            
            <p>You have read about Coorg, its rainforests, and coffee and tea from Assam in 'Glimpses of India' (First Flight, Class X textbook, NCERT). The following extract is about the cultivation of coffee in Araku valley in Andhra Pradesh. The story of Araku Valley <span class="highlight-vocab" data-meaning="Follows an unusual path">traverses an unusual trajectory</span> through Adivasi empowerment, hot-air balloons and some of the best coffee in the world.</p>
            
            <p>Located at about 1,200m above sea level, the valley, <span class="highlight-vocab" data-meaning="Hidden away">tucked away</span> in the north-eastern corner of Andhra Pradesh, shares a border with Odisha. For guests and participants at the Araku Balloon Festival (ABF), held between 18-20 January every year, this is sightseeing like nothing else.</p>
            
            <p>The drive to <span class="highlight-vocab" data-meaning="Remote, distant">far-flung</span> coffee estates takes us through the five northern <span class="highlight-vocab" data-meaning="Administrative divisions">mandals</span> of Anantha giri, Dumbriguda, Hukumpeta, Munchingi Puttu and Araku valley. The name Araku for the coffee was chosen simply because it sounded poetic. The view from the ground level is as impressive as the one from above — the landscape changes from <span class="highlight-vocab" data-meaning="Thickly covered with trees">densely forested hills</span> to sweeping valleys and terrace farms surrounding occasional <span class="highlight-vocab" data-meaning="Groups of villages">village clusters</span>. The journey of Araku Coffee from a livelihood initiative by the Naandi Foundation to a globally appreciated product has been in the making for over a decade. It is also <span class="highlight-vocab" data-meaning="Essentially, fundamentally">intrinsically</span> tied to the history of how coffee arrived in this valley. It was a British civil servant, N.S. Brodie, who introduced coffee to these hill tracts in 1898.</p>
            
            <p>Today, Araku coffee is a brand that works with 517 villages and 10,986 farmers, all of whom are estate owners and <span class="highlight-vocab" data-meaning="Business owners">entrepreneurs</span> with a stake in the business. The reason the coffee is of such high quality is that it follows the best practices of <span class="highlight-vocab" data-meaning="Organic farming approach">bio-dynamic farming</span> by creating an interconnected and symbiotic ecosystem. The soil is <span class="highlight-vocab" data-meaning="Improved in quality">enriched</span> through composting and a variety of shade trees are planted, including cash-yielding fruit trees like mango and jackfruit. <span class="highlight-vocab" data-meaning="Land with specific soil and climate characteristics">Terroirs</span> are assessed and careful standard operating procedures are put in place from "sapling to savouring", which ensures healthier plants and sweeter cherries and eventually a far superior coffee <span class="highlight-vocab" data-meaning="Distinctive smell">aroma</span> and flavour.</p>
            
            <div class="vocabulary-note">
                <span class="word">bio-dynamic:</span> <span class="definition">a holistic, ecological, and ethical approach to farming, gardening, food, and nutrition</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">entrepreneurs:</span> <span class="definition">people who set up and run businesses, taking on financial risks in the hope of profit</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">intrinsically:</span> <span class="definition">in an essential or natural way; by nature</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">mandals:</span> <span class="definition">administrative divisions in some states of India</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">terroirs:</span> <span class="definition">the complete natural environment in which a particular crop is produced, including factors such as the soil, topography, and climate</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">trajectory:</span> <span class="definition">a path, progression, or line of development resembling a physical trajectory</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">traverses:</span> <span class="definition">to travel across or through</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">tucked:</span> <span class="definition">hidden or placed in a particular position</span>
            </div>
        </div>
    `
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Load both parts at initialization
    const storyContentElement = document.getElementById('storyContent');
    if (storyContentElement) {
        // Load both parts at once
        storyContentElement.innerHTML = storyContent.part1 + storyContent.part2;
        
        // Only show part 1 initially
        document.querySelectorAll('.story-part').forEach(p => p.classList.remove('active'));
        const part1 = document.getElementById('storyPart1');
        if (part1) part1.classList.add('active');
        
        // Setup navigation
        const navBtns = document.querySelectorAll('.story-nav-btn');
        navBtns[0].classList.add('active');
        navBtns[0].setAttribute('aria-pressed', 'true');
        
        // Setup tooltips
        setupVocabularyTooltips();
        
        // Start reading part 1
        setTimeout(() => {
            readStoryPartAloud(1, false);
        }, 300);
    }
});

// Show Story Part
function showStoryPart(part) {
    console.log(`Switching to story part ${part}`);
    
    // Stop any ongoing narration when switching parts
    if (window.narrator && window.narrator.currentUtterance) {
        console.log('Stopping ongoing narration due to part switch');
        window.narrator.stop();
        
        // Clear any reading indicators
        document.querySelectorAll('.reading-indicator').forEach(indicator => {
            indicator.classList.add('fade-out');
            setTimeout(() => {
                if (indicator.parentNode) indicator.remove();
            }, 500);
        });
        
        // No paragraph highlights to clear
        
        // Clear any timeouts
        if (window.readingTimeout && typeof clearTimeout === 'function') {
            clearTimeout(window.readingTimeout);
        }
        
        if (window.highlightTimeouts && typeof clearTimeout === 'function') {
            window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
            window.highlightTimeouts = [];
        }
    }
    
    // Show the right part
    document.querySelectorAll('.story-part').forEach(p => p.classList.remove('active'));
    
    const partElement = document.getElementById('storyPart' + part);
    if (partElement) {
        partElement.classList.add('active');
    } else {
        console.error(`Story part element #storyPart${part} not found`);
    }
    
    // Update navigation
    document.querySelectorAll('.story-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
    });
    
    const navBtns = document.querySelectorAll('.story-nav-btn');
    if (navBtns[part - 1]) {
        navBtns[part - 1].classList.add('active');
        navBtns[part - 1].setAttribute('aria-pressed', 'true');
    }
    
    // Start reading the new part automatically after a short delay
    setTimeout(() => {
        readStoryPartAloud(part, false); // false = automatic call
    }, 300);
    
    // Scroll to top of story
    const storyContentElement = document.getElementById('storyContent');
    if (storyContentElement) {
        storyContentElement.scrollTop = 0;
    }
}

// Setup vocabulary tooltips
function setupVocabularyTooltips() {
    document.querySelectorAll('.highlight-vocab').forEach(vocab => {
        const meaning = vocab.dataset.meaning;
        if (meaning) {
            // Create tooltip if it doesn't exist
            if (!vocab.querySelector('.vocab-tooltip')) {
                const tooltip = document.createElement('span');
                tooltip.className = 'vocab-tooltip';
                tooltip.textContent = meaning;
                vocab.appendChild(tooltip);
            }
        }
    });
}

// Read story part aloud
function readStoryPartAloud(part, isManual = true) {
    if (!window.narrator || !window.narrator.enabled) {
        console.log('Narrator not available or disabled');
        return;
    }
    
    // Stop any ongoing narration
    window.narrator.stop();
    
    // Get the story part content
    const storyPart = document.getElementById('storyPart' + part);
    if (!storyPart) {
        console.error('Story part not found:', part);
        return;
    }
    
    // Remove any existing reading indicators first
    document.querySelectorAll('.reading-indicator').forEach(existingIndicator => {
        existingIndicator.remove();
    });
    
    // Create a reading indicator
    const storyContent = document.querySelector('.story-content');
    const indicator = document.createElement('div');
    indicator.className = 'reading-indicator';
    indicator.id = `reading-indicator-part-${part}`;
    indicator.innerHTML = '<div class="reading-spinner"></div><span>Reading aloud...</span>';
    storyContent.appendChild(indicator);
    
    // Collect all paragraphs to read
    const paragraphs = storyPart.querySelectorAll('p');
    let textToRead = '';
    
    // Start with the title
    const title = storyPart.querySelector('.story-part-title');
    if (title) {
        textToRead += title.textContent + ". ";
    }
    
    // Add each paragraph with proper spacing
    paragraphs.forEach((p, index) => {
        textToRead += p.textContent + " ";
    });
    
    // Function to read paragraphs with highlighting
    const prepareNarration = () => {
        // Clear any existing timeouts
        if (window.highlightTimeouts && typeof clearTimeout === 'function') {
            window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
        }
        
        // Storage for timeout references
        window.highlightTimeouts = [];
        
        // Ensure the active story part is visible
        const activeStoryPart = document.querySelector('.story-part.active');
        if (activeStoryPart) {
            // Scroll to the top of the story
            const storyContentElement = document.getElementById('storyContent');
            if (storyContentElement) {
                storyContentElement.scrollTop = 0;
            }
        }
        
        // Add a single timeout to scroll back to top after narration starts
        const timeout = setTimeout(() => {
            console.log('Ensuring story is visible');
            
            // Scroll to keep story visible
            const storyContentElement = document.getElementById('storyContent');
            if (storyContentElement) {
                storyContentElement.scrollTop = 0;
            }
        }, 500);
        
        window.highlightTimeouts.push(timeout);
    };
    
    // Start reading without paragraph highlighting
    window.narrator.speak(textToRead);
    prepareNarration();
    
    // Add synchronization tracking for debugging
    console.log(`Starting narration of ${paragraphs.length} paragraphs`);
    
    // Add an event for when reading ends
    window.narrator.onEndCallback = function() {
        // Remove the reading indicator
        if (indicator.parentNode) {
            indicator.classList.add('fade-out');
            setTimeout(() => {
                if (indicator.parentNode) indicator.remove();
            }, 500);
        }
        
        // Clear any remaining timeouts
        window.readingTimeout = setTimeout(() => {
            // Clear any timeouts
            if (window.highlightTimeouts && typeof clearTimeout === 'function') {
                window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
                window.highlightTimeouts = [];
            }
        }, 1000);
        
        // If this was automatic narration and not user-initiated, don't show achievement
        if (isManual) {
            // Update progress and show achievement if appropriate
            if (!window.modulesCompleted || !window.modulesCompleted.includes('story')) {
                if (typeof window.showAchievement === 'function') {
                    window.showAchievement('Story Reading Completed!');
                }
                
                if (typeof window.updateProgress === 'function' && window.modulesCompleted) {
                    if (!window.modulesCompleted.includes('story')) {
                        window.modulesCompleted.push('story');
                        window.updateProgress();
                    }
                }
            }
        }
    };
}
