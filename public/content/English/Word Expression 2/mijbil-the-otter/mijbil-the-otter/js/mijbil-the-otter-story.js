/**
 * Story content and related functions for Mijbil the Otter
 */

// Story Content
const storyContent = {
    part1: `
        <div class="story-part active" id="storyPart1">
            <h3 class="story-part-title">Text I: Baby Bhakat</h3>
            
            <p>The following is a story of a baby Civet cat that fell from a tree and was raised by humans. It is a true story from Assam written by Rommel Shunmugam who is a conservation photographer. Through his photo stories, he seeks to <span class="highlight-vocab" data-meaning="instill or establish an idea, feeling, or habit">inculcate</span> in children a love for nature and wildlife.</p>
            
            <p>Civet cats are found in most parts of India. They are also called toddy cats. They live on palm trees and love to drink the sweet sap, which is collected by toddy tappers to make wine! Dharini and his family rescues and <span class="highlight-vocab" data-meaning="restores to good health or normal life by training and therapy">rehabilitates</span> wild animals. These are mostly babies or animals that cannot look after themselves.</p>
            
            <h4>Baby Bhakat</h4>
            
            <p>Hi! My name is Bhakat. I am a baby Civet cat. I am three month old. Shhh! I am taking a nap with my brothers. Yes, I live in a family of humans. They treat me like their own Baby!</p>
            
            <p>My home is a little thatched hut by a river in a small village in Assam. The hut has an earthen floor and mud-splattered walls. Its doors are always open. I come and go as I please! Mama takes care of all three of us! Her name is Anjali. She cooks, cleans and plays with me. I secretly think she loves me the most. She lets me be real naughty!</p>
            
            <p>Mama is about to make brunch! She is making roti and vegetables. I don't like vegetables, but I like fruits. I love meat. I am <span class="highlight-vocab" data-meaning="feeding on both plants and animals">omnivorous</span>. Mama always feeds me before anyone else! I love things dipped in milk. They are yummy!</p>
            
            <p>The man of the house is Dharini. If not for him, I would not be alive today! My civet mother built a nest for me in a very tall coconut tree. One night I slipped and fell to the ground! When villagers found me they took me to Dharini. Dharini loves animals. I began to live in his home. I was very small. I could not walk. I ate and slept a lot!</p>
            
            <p>Do you know why my eyes are so large? That's because I am a <span class="highlight-vocab" data-meaning="active at night">nocturnal</span> animal. I sleep in the day and am active in the night. My large eyes help me see better in the dark! I also have a very long tail! It helps me balance on tree-tops and branches. I mostly live on trees, though I do come down to the ground. Animals like me are called <span class="highlight-vocab" data-meaning="tree-dwelling">arboreal</span>!</p>
            
            <p>Inside Dharini's house, I always snooze in the rafters. I like being high up; it reminds me of trees! One day I woke up to find a strange sight, Dharini's house was filling with water! In the night, the river behind the house started overflowing its banks! Inside everything was helter-skelter. Things were piled on top of one another! The monsoon had arrived!</p>
            
            <p>Dharini and Anjali carried us babies outside the house! There was water everywhere and it was very muddy! But the sun was out and it was not raining! I stayed high on the fence and made sure even my long tail did not get wet! Dharini went to pick snails.</p>
            
            <p>Snails had climbed branches and walls to escape drowning in the flood! Every gardener knows that snails eat plants. By eating snails, I ensure that they do not overrun your garden. I maintain the balance of life in nature!</p>
            
            <p>When it floods, you find fish everywhere! Dharini cast his net in the garden and began catching fishes. They are kept in a pan of water to keep them alive and fresh to eat!</p>
            
            <p>Montu, my brother, tried to be naughty! He caught me and threatened to dip me in water! He got a scolding from Dharini. I hate to be in water! Back inside the house, it is time for me to play with Mama! I shall rest awhile and then be up again at night. Mama always leaves a midnight snack by the lantern!</p>
            
            <div class="vocabulary-note">
                <span class="word">arboreal:</span> <span class="definition">living in trees or adapted for living in trees</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">inculcate:</span> <span class="definition">to instill or establish an idea, feeling, or habit through persistent instruction</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">nocturnal:</span> <span class="definition">active at night rather than during the day</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">omnivorous:</span> <span class="definition">feeding on both plants and animals</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">rehabilitates:</span> <span class="definition">restores to good health or normal life by training and therapy</span>
            </div>
        </div>
    `,
    part2: `
        <div class="story-part" id="storyPart2">
            <h3 class="story-part-title">Text II: Human-Wildlife Conflict</h3>
            
            <p>Read the passage given below and answer the questions that follow.</p>
            
            <h4>It's not easy having Elephants in your backyard.</h4>
            
            <p>Around the world, as communities expand, and natural wild places are reduced, people and wildlife are increasingly coming into conflict over living space and food.</p>
            
            <p>It might be baboons in Namibia attacking young goats or elephants in Nepal eating crops or European bears and wolves killing livestock. The problem is universal, affects rich and poor, and is bad news for all concerned.</p>
            
            <p>The impacts are often huge. People lose their crops and <span class="highlight-vocab" data-meaning="farm animals collectively">livestock</span> (and therefore a source of income and food security), property, and sometimes their lives — even a severe injury caused by wildlife can result in a loss of livelihood. The animals, some of which are already threatened or even <span class="highlight-vocab" data-meaning="at risk of extinction">endangered</span>, are sometimes killed in <span class="highlight-vocab" data-meaning="revenge or counter-attack">retaliation</span> or to prevent future conflicts.</p>
            
            <p>Human-wildlife <span class="highlight-vocab" data-meaning="serious disagreement or argument">conflict</span> is happening more and more, affecting a lot of different species. The effects of climate change will probably make the problem worse.</p>
            
            <h4>How we are tackling human-wildlife conflict</h4>
            
            <p>The solutions are often specific to the wildlife or area concerned, and are often creative and simple — for instance planting a barrier of crops that repel the animals (elephants and some other wildlife don't like chilli, for example).</p>
            
            <p>An important aspect of the work is that it benefits both the animals and local people and actively involves the communities concerned (in the case of chilli, it can be sold to increase income). It's about finding solutions that lead to mutually beneficial <span class="highlight-vocab" data-meaning="living together peacefully">coexistence</span>.</p>
            
            <p>The work has also often led to people being more enthusiastic and supportive of conservation, and has demonstrated that people can live alongside wildlife while developing sustainable livelihoods.</p>
            
            <div class="vocabulary-note">
                <span class="word">coexistence:</span> <span class="definition">the state of living or existing together at the same time or in the same place</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">conflict:</span> <span class="definition">serious disagreement or argument, typically a protracted one</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">endangered:</span> <span class="definition">(of a species) seriously at risk of extinction</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">livestock:</span> <span class="definition">farm animals such as cows, sheep, and pigs collectively</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">retaliation:</span> <span class="definition">the action of returning a military attack; counter-attack</span>
            </div>
        </div>
    `,
    part3: `
        <div class="story-part" id="storyPart3">
            <h3 class="story-part-title">Text III: Animal Rights</h3>
            
            <p>Read the passage given below and answer the questions that follow.</p>
            
            <h4>Animal rights</h4>
            
            <p>People who support animal rights recognise that all animals have an <span class="highlight-vocab" data-meaning="existing as a natural or permanent feature">inherent</span> worth, a value completely separate from their usefulness to humans. Every being with a will to live has the right to live free from exploitation and suffering.</p>
            
            <p>All animals have the ability to suffer in the same way and to the same degree that humans do. They feel pain, pleasure, fear, frustration, loneliness, and <span class="highlight-vocab" data-meaning="relating to or occurring in a family">familial</span> love. Whenever we consider doing something that would interfere with their needs, we are morally obligated to take them into account.</p>
            
            <p>People often ask if animal rights mean that animals should have the right to vote or drive a car. Of course, that would be silly because those aren't rights that would benefit animals. But animals have the right not to suffer at the hands of humans and to live their lives free from suffering and <span class="highlight-vocab" data-meaning="unfair treatment for one's own benefit">exploitation</span> because they have an interest in doing so. That is the difference between equal <span class="highlight-vocab" data-meaning="careful thought">consideration</span> and equal treatment.</p>
            
            <p>Almost everyone cares about animals in some context, whether it's a beloved family companion, an irresistibly cute kitten or a majestic wild animal seen in a <span class="highlight-vocab" data-meaning="film presenting facts about a subject">documentary</span>. After all, we each have some built-in capacity for <span class="highlight-vocab" data-meaning="ability to understand feelings of another">empathy</span> and <span class="highlight-vocab" data-meaning="sympathetic concern for suffering of others">compassion</span>, as can be seen from the lengths that children often go to in order to help animals.</p>
            
            <p>Logically and morally, there is no reason to differentiate in the way we treat the animals we share our homes with and those who are farmed for food. They are all individuals, with the same capacity to feel pain and fear. Animal rights help us to look past the <span class="highlight-vocab" data-meaning="based on random choice, not based on reason">arbitrary</span> distinctions between different species, to rediscover our innate compassion, and to respect all animals equally.</p>
            
            <p>Anyone who cares about animals can start putting these principles into practice every single day with the food they eat, the clothes they wear, and the products they buy. These choices are a form of non-violent protest that makes a real difference both by reducing the profits of corporations that harm or kill animals and by creating a growing market for cruelty-free food, fashion, services, and entertainment.</p>
            
            <div class="vocabulary-note">
                <span class="word">arbitrary:</span> <span class="definition">based on random choice or personal whim, rather than any reason or system</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">compassion:</span> <span class="definition">sympathetic concern for the sufferings or misfortunes of others</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">consideration:</span> <span class="definition">careful thought, typically over a period of time</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">documentary:</span> <span class="definition">a film or television program presenting facts about a subject</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">empathy:</span> <span class="definition">the ability to understand and share the feelings of another</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">exploitation:</span> <span class="definition">the action or fact of treating someone unfairly in order to benefit from their work</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">familial:</span> <span class="definition">relating to or occurring in a family or its members</span>
            </div>
            
            <div class="vocabulary-note">
                <span class="word">inherent:</span> <span class="definition">existing in something as a permanent, essential, or characteristic attribute</span>
            </div>
        </div>
    `
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Load all parts at initialization
    const storyContentElement = document.getElementById('storyContent');
    if (storyContentElement) {
        // Load all parts at once
        storyContentElement.innerHTML = storyContent.part1 + storyContent.part2 + storyContent.part3;
        
        // Only show part 1 initially
        document.querySelectorAll('.story-part').forEach(p => p.classList.remove('active'));
        const part1 = document.getElementById('storyPart1');
        if (part1) part1.classList.add('active');
        
        // Setup navigation
        const navBtns = document.querySelectorAll('.story-nav-btn');
        navBtns[0].classList.add('active');
        navBtns[0].setAttribute('aria-pressed', 'true');
        
        // Setup tooltips
        setupVocabularyTooltips();
        
        // Start reading part 1
        setTimeout(() => {
            readStoryPartAloud(1, false);
        }, 300);
    }
});

// Show Story Part
function showStoryPart(part) {
    console.log(`Switching to story part ${part}`);
    
    // Stop any ongoing narration when switching parts
    if (window.narrator && window.narrator.currentUtterance) {
        console.log('Stopping ongoing narration due to part switch');
        window.narrator.stop();
        
        // Clear any reading indicators
        document.querySelectorAll('.reading-indicator').forEach(indicator => {
            indicator.classList.add('fade-out');
            setTimeout(() => {
                if (indicator.parentNode) indicator.remove();
            }, 500);
        });
        
        // No paragraph highlights to clear
        
        // Clear any timeouts
        if (window.readingTimeout && typeof clearTimeout === 'function') {
            clearTimeout(window.readingTimeout);
        }
        
        if (window.highlightTimeouts && typeof clearTimeout === 'function') {
            window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
            window.highlightTimeouts = [];
        }
    }
    
    // Show the right part
    document.querySelectorAll('.story-part').forEach(p => p.classList.remove('active'));
    
    const partElement = document.getElementById('storyPart' + part);
    if (partElement) {
        partElement.classList.add('active');
    } else {
        console.error(`Story part element #storyPart${part} not found`);
    }
    
    // Update navigation
    document.querySelectorAll('.story-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
    });
    
    const navBtns = document.querySelectorAll('.story-nav-btn');
    if (navBtns[part - 1]) {
        navBtns[part - 1].classList.add('active');
        navBtns[part - 1].setAttribute('aria-pressed', 'true');
    }
    
    // Start reading the new part automatically after a short delay
    setTimeout(() => {
        readStoryPartAloud(part, false); // false = automatic call
    }, 300);
    
    // Scroll to top of story
    const storyContentElement = document.getElementById('storyContent');
    if (storyContentElement) {
        storyContentElement.scrollTop = 0;
    }
}

// Setup vocabulary tooltips
function setupVocabularyTooltips() {
    document.querySelectorAll('.highlight-vocab').forEach(vocab => {
        const meaning = vocab.dataset.meaning;
        if (meaning) {
            // Create tooltip if it doesn't exist
            if (!vocab.querySelector('.vocab-tooltip')) {
                const tooltip = document.createElement('span');
                tooltip.className = 'vocab-tooltip';
                tooltip.textContent = meaning;
                vocab.appendChild(tooltip);
            }
        }
    });
}

// Read story part aloud
function readStoryPartAloud(part, isManual = true) {
    if (!window.narrator || !window.narrator.enabled) {
        console.log('Narrator not available or disabled');
        return;
    }
    
    // Stop any ongoing narration
    window.narrator.stop();
    
    // Get the story part content
    const storyPart = document.getElementById('storyPart' + part);
    if (!storyPart) {
        console.error('Story part not found:', part);
        return;
    }
    
    // Create a reading indicator
    const storyContent = document.querySelector('.story-content');
    const indicator = document.createElement('div');
    indicator.className = 'reading-indicator';
    indicator.innerHTML = '<div class="reading-spinner"></div><span>Reading aloud...</span>';
    storyContent.appendChild(indicator);
    
    // Collect all paragraphs to read
    const paragraphs = storyPart.querySelectorAll('p');
    let textToRead = '';
    
    // Start with the title
    const title = storyPart.querySelector('.story-part-title');
    if (title) {
        textToRead += title.textContent + ". ";
    }
    
    // Add subtitles if present
    const subtitles = storyPart.querySelectorAll('h4');
    subtitles.forEach(subtitle => {
        textToRead += subtitle.textContent + ". ";
    });
    
    // Add each paragraph with proper spacing
    paragraphs.forEach((p, index) => {
        textToRead += p.textContent + " ";
    });
    
    // Function to prepare narration (highlighting disabled)
    const prepareNarration = () => {
        // Clear any existing timeouts
        if (window.highlightTimeouts && typeof clearTimeout === 'function') {
            window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
        }
        
        // Storage for timeout references
        window.highlightTimeouts = [];
        
        // Ensure the active story part is visible
        const activeStoryPart = document.querySelector('.story-part.active');
        if (activeStoryPart) {
            // Scroll to the top of the story
            const storyContentElement = document.getElementById('storyContent');
            if (storyContentElement) {
                storyContentElement.scrollTop = 0;
            }
        }
    };
    
    // Start reading without paragraph highlighting
    window.narrator.speak(textToRead);
    prepareNarration();
    
    // Add an event for when reading ends
    window.narrator.onEndCallback = function() {
        // Remove the reading indicator
        if (indicator.parentNode) {
            indicator.classList.add('fade-out');
            setTimeout(() => {
                if (indicator.parentNode) indicator.remove();
            }, 500);
        }
        
        // Clear any remaining timeouts
        window.readingTimeout = setTimeout(() => {
            // Clear any timeouts
            if (window.highlightTimeouts && typeof clearTimeout === 'function') {
                window.highlightTimeouts.forEach(timeout => clearTimeout(timeout));
                window.highlightTimeouts = [];
            }
        }, 1000);
        
        // If this was automatic narration and not user-initiated, don't show achievement
        if (isManual) {
            // Update progress and show achievement if appropriate
            if (!window.modulesCompleted || !window.modulesCompleted.includes('story')) {
                if (typeof window.showAchievement === 'function') {
                    window.showAchievement('Story Reading Completed!');
                }
                
                if (typeof window.updateProgress === 'function' && window.modulesCompleted) {
                    if (!window.modulesCompleted.includes('story')) {
                        window.modulesCompleted.push('story');
                        window.updateProgress();
                    }
                }
            }
        }
    };
}
