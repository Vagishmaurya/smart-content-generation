<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Respiratory System - Breathing Journey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            overflow: hidden;
            position: relative;
            height: 100vh;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            opacity: 0.1;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.2" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,197.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') repeat-x;
            animation: wave 10s linear infinite;
        }

        @keyframes wave {
            0% { background-position-x: 0; }
            100% { background-position-x: 1440px; }
        }

        /* Museum Interface - Compact Header */
        .museum-header {
            position: absolute;
            top: 10px;
            left: 20px;
            text-align: left;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            padding: 10px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .museum-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(45deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .exhibit-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breathing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
            animation: breathing-pulse 2s ease-in-out infinite;
        }

        @keyframes breathing-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.6; }
        }

        /* Journey Navigation - Enhanced */
        .journey-navigation {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 320px;
        }

        .journey-title {
            font-size: 14px;
            font-weight: 600;
            color: #3498db;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .journey-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .journey-btn {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.4);
            color: white;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .journey-btn:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .journey-btn.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
            animation: pulse 2s infinite;
        }

        .journey-btn.completed {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* 3D Model Container */
        .model-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
            overflow: hidden;
            border: none;
            z-index: 100;
        }

        .sketchfab-embed-wrapper {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
        }

        .sketchfab-embed-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
        }

        /* Information Panel - Enhanced */
        .info-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            width: 380px;
            max-height: calc(100vh - 140px);
            z-index: 800;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .info-icon {
            font-size: 28px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .info-title {
            flex: 1;
        }

        .info-title h2 {
            font-size: 18px;
            color: #3498db;
            margin-bottom: 4px;
        }

        .info-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-content {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Progress Tracker */
        .progress-tracker {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(44, 62, 80, 0.1));
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .progress-header {
            font-size: 13px;
            font-weight: 600;
            color: #3498db;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-percentage {
            font-size: 18px;
            color: #e74c3c;
            font-weight: 700;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            border-radius: 4px;
            transition: width 0.8s ease;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        .progress-steps-mini {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .step-mini {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-mini.active {
            color: #e74c3c;
            font-weight: 600;
        }

        .step-mini.completed {
            color: #2ecc71;
        }

        /* Information Cards */
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
        }

        .info-card-title {
            color: #3498db;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-card-content {
            color: rgba(255, 255, 255, 0.85);
            font-size: 12px;
            line-height: 1.5;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .info-list li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #3498db;
        }

        /* Fun Fact Box */
        .fun-fact {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.1), rgba(52, 152, 219, 0.1));
            border: 1px solid rgba(44, 62, 80, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
        }

        .fun-fact:before {
            content: "💨";
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 60px;
            opacity: 0.1;
        }

        .fun-fact-title {
            color: #2c3e50;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .fun-fact-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        /* Voice Controls */
        .voice-controls {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
        }

        .control-btn:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            transform: scale(1.1);
        }

        .control-btn.active {
            background: rgba(52, 152, 219, 0.4);
            border-color: #3498db;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        .control-tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .control-btn:hover .control-tooltip {
            opacity: 1;
        }

        /* Loading Screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 1s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-breath {
            font-size: 60px;
            animation: breath-cycle 3s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes breath-cycle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        .loading-text {
            color: white;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            animation: loading 2s ease-in-out infinite;
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }

        /* Voice Indicator */
        .voice-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(52, 152, 219, 0.5);
            border-radius: 30px;
            padding: 14px 28px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .voice-indicator.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .voice-waves {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .voice-wave {
            width: 3px;
            height: 20px;
            background: linear-gradient(180deg, #3498db, #2c3e50);
            border-radius: 2px;
            animation: voice-wave 1s ease-in-out infinite;
        }

        .voice-wave:nth-child(2) { animation-delay: 0.1s; }
        .voice-wave:nth-child(3) { animation-delay: 0.2s; }
        .voice-wave:nth-child(4) { animation-delay: 0.3s; }
        .voice-wave:nth-child(5) { animation-delay: 0.4s; }

        @keyframes voice-wave {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        .narration-text {
            color: white;
            font-size: 13px;
            max-width: 300px;
        }

        /* Quick Actions */
        .quick-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .action-btn:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        /* Custom Scrollbar */
        .info-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3498db, #2c3e50);
            border-radius: 3px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .info-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                max-height: 50vh;
                border-radius: 20px 20px 0 0;
            }
            
            .journey-navigation {
                bottom: 52vh;
                max-width: calc(100% - 40px);
            }
            
            .voice-controls {
                top: auto;
                bottom: 55vh;
                right: 10px;
            }
            
            .quick-actions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-breath">💨</div>
            <div class="loading-text">Exploring Respiratory Systems...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Museum Header -->
    <div class="museum-header">
        <div class="museum-title">Human Respiratory System</div>
        <div class="exhibit-subtitle">
            <span class="breathing-indicator"></span>
            The Science of Breathing
        </div>
    </div>

    <!-- Journey Navigation -->
    <div class="journey-navigation">
        <div class="journey-title">
            <span>💨</span>
            <span>Breathing Journey</span>
        </div>
        <div class="journey-steps">
            <button class="journey-btn active" onclick="loadJourneyStep('introduction')">
                <span>🌟</span> Overview
            </button>
            <button class="journey-btn" onclick="loadJourneyStep('fish_breathing')">
                <span>🐠</span> Fish Gills
            </button>
            <button class="journey-btn" onclick="loadJourneyStep('lung_structure')">
                <span>🫁</span> Lungs
            </button>
            <button class="journey-btn" onclick="loadJourneyStep('breathing_mechanism')">
                <span>⚙️</span> Breathing
            </button>
            <button class="journey-btn" onclick="loadJourneyStep('gas_exchange')">
                <span>🔄</span> Gas Exchange
            </button>
            <button class="journey-btn" onclick="loadJourneyStep('diaphragm_action')">
                <span>💪</span> Diaphragm
            </button>
        </div>
    </div>

    <!-- 3D Model Container -->
    <div class="model-container">
        <div class="sketchfab-embed-wrapper">
            <iframe id="api-frame"
                    title="Respiratory System Model" 
                    frameborder="0" 
                    allowfullscreen 
                    mozallowfullscreen="true" 
                    webkitallowfullscreen="true" 
                    allow="autoplay; fullscreen; xr-spatial-tracking"
                    xr-spatial-tracking 
                    execution-while-out-of-viewport 
                    execution-while-not-rendered 
                    web-share 
                    src="https://sketchfab.com/models/ce09f4099a68467880f46e61eb9a3531/embed?autostart=1&internal=1&tracking=0&ui_ar=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_theatre=1&ui_watermark=0">
            </iframe>
        </div>
    </div>

    <!-- Information Panel -->
    <div class="info-panel" id="infoPanel">
        <div class="info-header">
            <div class="info-icon" id="stepIcon">🌟</div>
            <div class="info-title">
                <h2 id="stepTitle">Human Respiratory System Overview</h2>
                <div class="info-subtitle" id="stepSubtitle">The mechanics of breathing and gas exchange</div>
            </div>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-tracker">
            <div class="progress-header">
                <span>Breathing Progress</span>
                <span class="progress-percentage" id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-steps-mini">
                <span class="step-mini active" onclick="loadJourneyStep('introduction')">Intro</span>
                <span class="step-mini" onclick="loadJourneyStep('fish_breathing')">Fish</span>
                <span class="step-mini" onclick="loadJourneyStep('lung_structure')">Lungs</span>
                <span class="step-mini" onclick="loadJourneyStep('breathing_mechanism')">Breathing</span>
                <span class="step-mini" onclick="loadJourneyStep('gas_exchange')">Exchange</span>
                <span class="step-mini" onclick="loadJourneyStep('diaphragm_action')">Diaphragm</span>
            </div>
        </div>

        <div class="info-content" id="mainDescription">
            The human respiratory system is a sophisticated network of organs designed to extract oxygen from air and remove carbon dioxide from the body. This vital system enables the gas exchange necessary for cellular respiration and maintaining life.
        </div>

        <div class="info-card">
            <div class="info-card-title">
                <span>🔬</span> Key Components
            </div>
            <div class="info-card-content">
                <ul class="info-list" id="keyConcepts">
                    <li>Lungs provide massive surface area for gas exchange</li>
                    <li>Diaphragm drives breathing movements</li>
                    <li>Alveoli are sites of oxygen and CO2 exchange</li>
                    <li>Airways deliver air to respiratory surfaces</li>
                </ul>
            </div>
        </div>

        <div class="fun-fact">
            <div class="fun-fact-title">Breathing Fact!</div>
            <div class="fun-fact-text" id="funFact">
                You breathe about 20,000 times per day, moving roughly 11,000 liters of air through your lungs!
            </div>
        </div>

        <div class="info-card">
            <div class="info-card-title">
                <span>🎯</span> Learning Objectives
            </div>
            <div class="info-card-content" id="learningObjectives">
                Understand respiratory system structure, explore breathing mechanisms, and learn how gas exchange occurs at the alveolar level.
            </div>
        </div>
    </div>

    <!-- Voice Controls -->
    <div class="voice-controls">
        <button class="control-btn active" id="voiceToggle" onclick="toggleVoice()">
            🔊
            <span class="control-tooltip">Voice Narration</span>
        </button>
        <button class="control-btn" onclick="toggleAutoPlay()">
            ▶️
            <span class="control-tooltip">Auto Journey</span>
        </button>
        <button class="control-btn" onclick="toggleInfo()">
            ℹ️
            <span class="control-tooltip">Toggle Info</span>
        </button>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="action-btn" onclick="startGuidedTour()">
            <span>🚀</span> Guided Tour
        </button>
        <button class="action-btn" onclick="showQuiz()">
            <span>🎯</span> Test Knowledge
        </button>
    </div>

    <!-- Voice Indicator -->
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-waves">
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
            <div class="voice-wave"></div>
        </div>
        <div class="narration-text" id="narrationText">Narrating...</div>
    </div>

    <script>
        // Journey Step Data with Complete Pedagogical Content
        const JOURNEY_DATA = {
            introduction: {
                title: "Human Respiratory System Overview",
                subtitle: "The mechanics of breathing and gas exchange",
                icon: "🌟",
                modelUrl: "https://sketchfab.com/models/ce09f4099a68467880f46e61eb9a3531/embed?autostart=1&internal=1&tracking=0&ui_ar=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_theatre=1&ui_watermark=0",
                description: "The human respiratory system is a sophisticated network of organs designed to extract oxygen from air and remove carbon dioxide from the body. This vital system enables the gas exchange necessary for cellular respiration and maintaining life.",
                concepts: [
                    "Lungs provide massive surface area for gas exchange",
                    "Diaphragm drives breathing movements",
                    "Alveoli are sites of oxygen and CO2 exchange",
                    "Airways deliver air to respiratory surfaces"
                ],
                funFact: "You breathe about 20,000 times per day, moving roughly 11,000 liters of air through your lungs!",
                objectives: "Understand respiratory system structure, explore breathing mechanisms, and learn how gas exchange occurs at the alveolar level.",
                narration: "Welcome to the human respiratory system - one of the most essential and elegant biological systems for sustaining life! You're looking at the lungs, the primary organs responsible for gas exchange in humans. The respiratory system is far more than just breathing in and out - it's a sophisticated network designed to extract oxygen from the atmosphere and deliver it to every cell in your body while simultaneously removing the carbon dioxide waste that cellular respiration produces. The system includes your nose and mouth, trachea, bronchi, bronchioles, and millions of tiny air sacs called alveoli. What makes this system remarkable is its efficiency - with each breath, air travels through branching airways that get progressively smaller, like an inverted tree, until reaching the alveoli where the actual gas exchange occurs. The entire process happens automatically, controlled by your brain stem, about 12-20 times per minute throughout your entire life."
            },
            fish_breathing: {
                title: "Activity 5.6 - Fish Breathing Observation",
                subtitle: "Comparing aquatic and terrestrial respiration",
                icon: "🐠",
                modelUrl: "https://sketchfab.com/models/04ab11e9bc3d4211912a38d89cd22665/embed?autostart=1&internal=1&tracking=0&ui_ar=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_theatre=1&ui_watermark=0",
                description: "Fish gills demonstrate an alternative respiratory strategy, extracting dissolved oxygen from water. This counter-current flow system is highly efficient, allowing fish to extract up to 85% of available oxygen from water, compared to only 25% extraction from air in mammalian lungs.",
                concepts: [
                    "Gills extract dissolved oxygen from water",
                    "Counter-current flow maximizes oxygen extraction",
                    "Water flows in opposite direction to blood",
                    "Fish achieve 85% oxygen extraction efficiency"
                ],
                funFact: "Fish gills are so efficient that they extract more oxygen from water (85%) than human lungs extract from air (25%)!",
                objectives: "Compare aquatic and terrestrial respiratory strategies and understand how counter-current flow maximizes gas exchange efficiency.",
                narration: "Here we see the intricate gill structure of a parrotfish, demonstrating nature's solution for extracting oxygen from water! In Activity 5.6, observing fish breathing reveals fundamental principles of respiratory physiology. Fish face a major challenge - water contains much less dissolved oxygen than air, and water is much denser and more viscous than air. To solve this, fish have evolved gills with an incredibly efficient counter-current flow system. As water flows over the gill filaments in one direction, blood flows through the gill capillaries in the opposite direction. This arrangement ensures that as blood picks up oxygen and approaches oxygen saturation, it encounters water with the highest oxygen concentration. The result is extraordinary efficiency - fish can extract up to 85% of the available oxygen from water, while mammals only extract about 25% of the oxygen from air! The feathery structure you see maximizes surface area while the precise flow arrangement maximizes the concentration gradient for oxygen diffusion. This elegant system allows fish to thrive in an environment where oxygen is precious."
            },
            lung_structure: {
                title: "Lung Structure and Organization",
                subtitle: "Branching airways and respiratory surfaces",
                icon: "🫁",
                modelUrl: "https://sketchfab.com/models/ce09f4099a68467880f46e61eb9a3531/embed?autostart=1&internal=1&tracking=0&ui_ar=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_theatre=1&ui_watermark=0",
                description: "The lungs feature a branching tree-like structure that delivers air efficiently to millions of alveoli. This design maximizes surface area while minimizing the distance gases must travel for exchange. The entire respiratory tree contains about 23 generations of branching.",
                concepts: [
                    "Trachea divides into left and right bronchi",
                    "Bronchi branch into progressively smaller bronchioles",
                    "Terminal bronchioles lead to alveolar sacs",
                    "About 23 generations of airway branching"
                ],
                funFact: "If you could unfold all the alveoli in your lungs and lay them flat, they would cover an area roughly the size of a tennis court!",
                objectives: "Explore the hierarchical organization of lung structure and understand how branching maximizes respiratory efficiency.",
                narration: "The lung structure before you reveals one of nature's most efficient designs for gas exchange! The lungs are organized like an inverted tree, with the trachea as the trunk that splits into two main bronchi - one for each lung. These bronchi then undergo about 23 generations of branching, dividing into smaller and smaller airways called bronchioles. This branching pattern serves multiple purposes: it distributes air evenly throughout the lungs, slows air flow as it reaches the exchange surfaces, and creates an enormous surface area packed into a relatively compact space. The final branches, called terminal bronchioles, lead to clusters of tiny air sacs called alveoli. What's remarkable is that this branching system can fit about 300-500 million alveoli into the space of your chest cavity! The walls of the bronchi and bronchioles contain smooth muscle that can contract or relax to control airflow, while the airways are lined with cilia and mucus that help filter and clean incoming air. This hierarchical organization efficiently delivers fresh air to the respiratory surfaces while providing multiple levels of air conditioning and filtration."
            },
            breathing_mechanism: {
                title: "Breathing Mechanism",
                subtitle: "How air moves in and out of lungs",
                icon: "⚙️",
                modelUrl: "https://sketchfab.com/models/b62b76467c6948fbb735c78c0c428d65/embed?autostart=1&internal=1&tracking=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_watermark=0",
                description: "Breathing involves coordinated muscle movements that change the volume and pressure within the thoracic cavity. The diaphragm is the primary breathing muscle, working with intercostal muscles to create pressure gradients that drive air flow.",
                concepts: [
                    "Diaphragm contracts and flattens during inspiration",
                    "Intercostal muscles expand the ribcage",
                    "Volume increase creates negative pressure",
                    "Air flows from high to low pressure"
                ],
                funFact: "Your diaphragm moves up and down about 12-20 times per minute and travels roughly 700 km per year just from breathing!",
                objectives: "Understand the mechanical basis of breathing and how pressure changes drive air movement.",
                narration: "Here we see the diaphragm - the dome-shaped muscle that powers breathing! The breathing mechanism is based on a simple physical principle: air flows from areas of high pressure to areas of low pressure. When you breathe in, your diaphragm contracts and flattens, moving downward. Simultaneously, the intercostal muscles between your ribs contract, lifting and expanding your ribcage outward. These coordinated movements increase the volume of your thoracic cavity, which decreases the pressure inside your lungs below atmospheric pressure. This pressure difference causes air to rush into your lungs. During normal quiet breathing, exhaling is mostly passive - the diaphragm relaxes and returns to its dome shape, the elastic lungs recoil, and the decreased thoracic volume increases pressure, pushing air out. During forced breathing, additional muscles help expand the chest during inspiration and compress it during expiration. The diaphragm does about 80% of the work during quiet breathing, making it one of the most important muscles in your body. This elegant mechanical system ensures continuous, automatic ventilation of your lungs."
            },
            gas_exchange: {
                title: "Gas Exchange in Alveoli",
                subtitle: "Where oxygen enters and CO2 exits",
                icon: "🔄",
                modelUrl: "https://sketchfab.com/models/f15898fffdca4c5792efb2774ddab372/embed?autostart=1&internal=1&tracking=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_watermark=0",
                description: "Alveoli are microscopic air sacs where gas exchange occurs. Their thin walls allow rapid diffusion of oxygen into blood and carbon dioxide out of blood. Each alveolus is surrounded by a dense network of capillaries to maximize gas exchange efficiency.",
                concepts: [
                    "Alveolar walls are only one cell thick",
                    "Dense capillary networks surround each alveolus",
                    "Oxygen diffuses from alveoli into blood",
                    "CO2 diffuses from blood into alveoli"
                ],
                funFact: "The total surface area of all your alveoli is about 70 square meters - 40 times larger than your skin surface!",
                objectives: "Examine the microscopic structure of alveoli and understand how their design facilitates efficient gas exchange.",
                narration: "You're now looking at the microscopic level where the real magic of breathing happens - the bronchi, bronchioles, and alveoli! These tiny air sacs are where oxygen from the air you breathe actually enters your bloodstream. Each alveolus is incredibly thin-walled - only about 0.2 micrometers thick, which is thinner than a soap bubble! This ultra-thin barrier, called the respiratory membrane, consists of the alveolar epithelium, the capillary endothelium, and their shared basement membrane. Surrounding each alveolus is a dense network of capillaries carrying blood from the right side of your heart. The proximity is so close that red blood cells practically squeeze against the alveolar walls as they pass through. Oxygen dissolves in the thin layer of fluid lining the alveoli and then diffuses across the respiratory membrane into the blood, where it binds to hemoglobin in red blood cells. Simultaneously, carbon dioxide diffuses in the opposite direction - from the blood into the alveolar air to be exhaled. This two-way exchange happens with every breath, allowing your body to acquire the oxygen needed for cellular respiration while eliminating the carbon dioxide waste produced by your cells."
            },
            diaphragm_action: {
                title: "Diaphragm Action and Control",
                subtitle: "The primary muscle of breathing",
                icon: "💪",
                modelUrl: "https://sketchfab.com/models/b62b76467c6948fbb735c78c0c428d65/embed?autostart=1&internal=1&tracking=0&ui_infos=0&ui_snapshots=1&ui_stop=0&ui_watermark=0",
                description: "The diaphragm is a dome-shaped muscle that separates the thoracic and abdominal cavities. Its rhythmic contractions are controlled by the phrenic nerve and respiratory centers in the brain stem, ensuring automatic and continuous breathing throughout life.",
                concepts: [
                    "Dome-shaped muscle separating chest and abdomen",
                    "Controlled by phrenic nerve from brain stem",
                    "Contracts downward during inspiration",
                    "Relaxes upward during expiration"
                ],
                funFact: "The diaphragm is so important that damage to the phrenic nerve can cause severe breathing difficulties or even require mechanical ventilation!",
                objectives: "Learn about diaphragm structure and function, and understand how breathing is controlled by the nervous system.",
                narration: "The diaphragm is truly the unsung hero of respiration - this dome-shaped muscle works tirelessly every moment of your life! Located at the base of your ribcage, it forms a complete partition between your thoracic cavity above and abdominal cavity below. The diaphragm has openings for important structures like the esophagus, aorta, and vena cava to pass through. What makes the diaphragm special is its dual nature - it's both voluntary and involuntary. While breathing happens automatically thanks to signals from the respiratory control centers in your brain stem via the phrenic nerves, you can also consciously control your diaphragm for activities like speaking, singing, or holding your breath. When the diaphragm contracts, it flattens and moves downward, creating more space in the chest cavity. This action alone accounts for about 75% of the air that enters your lungs during quiet breathing. The diaphragm is incredibly strong and enduring - it contracts and relaxes over 20,000 times per day without rest, making it one of the most hardworking muscles in your body. Understanding diaphragm function is crucial because many respiratory problems involve diaphragm weakness or paralysis."
            }
        };

        // Global Variables
        let currentStep = 'introduction';
        let voiceEnabled = true;
        let autoPlayEnabled = false;
        let currentSpeech = null;
        let selectedVoice = null;
        let journeyProgress = 0;
        let guidedTourActive = false;

        // Initialize Voice System
        function initVoiceSystem() {
            if (!('speechSynthesis' in window)) {
                console.warn('Speech synthesis not supported');
                voiceEnabled = false;
                document.getElementById('voiceToggle').style.display = 'none';
                return;
            }

            function loadVoices() {
                const voices = speechSynthesis.getVoices();
                if (voices.length === 0) return;

                const preferredVoices = [
                    'Google UK English Female',
                    'Microsoft Sonia',
                    'Microsoft Hazel',
                    'Samantha',
                    'Victoria'
                ];

                for (const name of preferredVoices) {
                    selectedVoice = voices.find(v => v.name.includes(name));
                    if (selectedVoice) break;
                }

                if (!selectedVoice) {
                    selectedVoice = voices.find(v => v.lang.startsWith('en'));
                }
            }

            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        // Load Journey Step
        function loadJourneyStep(stepId) {
            const stepData = JOURNEY_DATA[stepId];
            if (!stepData) return;

            currentStep = stepId;
            
            document.getElementById('api-frame').src = stepData.modelUrl;
            document.getElementById('stepIcon').textContent = stepData.icon;
            document.getElementById('stepTitle').textContent = stepData.title;
            document.getElementById('stepSubtitle').textContent = stepData.subtitle;
            document.getElementById('mainDescription').textContent = stepData.description;
            
            const conceptsList = document.getElementById('keyConcepts');
            conceptsList.innerHTML = stepData.concepts.map(c => `<li>${c}</li>`).join('');
            
            document.getElementById('funFact').textContent = stepData.funFact;
            document.getElementById('learningObjectives').textContent = stepData.objectives;
            
            updateNavigationButtons(stepId);
            updateProgress();
            
            if (voiceEnabled) {
                speakText(stepData.narration);
            }
        }

        function updateNavigationButtons(activeStep) {
            const buttons = document.querySelectorAll('.journey-btn');
            const steps = ['introduction', 'fish_breathing', 'lung_structure', 'breathing_mechanism', 'gas_exchange', 'diaphragm_action'];
            const activeIndex = steps.indexOf(activeStep);
            
            buttons.forEach((btn, index) => {
                btn.classList.remove('active', 'completed');
                if (index < activeIndex) {
                    btn.classList.add('completed');
                } else if (index === activeIndex) {
                    btn.classList.add('active');
                }
            });
            
            const miniSteps = document.querySelectorAll('.step-mini');
            miniSteps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index < activeIndex) {
                    step.classList.add('completed');
                } else if (index === activeIndex) {
                    step.classList.add('active');
                }
            });
        }

        function updateProgress() {
            const steps = ['introduction', 'fish_breathing', 'lung_structure', 'breathing_mechanism', 'gas_exchange', 'diaphragm_action'];
            const currentIndex = steps.indexOf(currentStep);
            const progress = ((currentIndex + 1) / steps.length) * 100;
            
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function speakText(text) {
            if (!voiceEnabled || !text) return;
            
            stopSpeech();
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            if (selectedVoice) {
                currentSpeech.voice = selectedVoice;
            }
            currentSpeech.rate = 0.9;
            currentSpeech.pitch = 1.0;
            currentSpeech.volume = 0.9;
            
            currentSpeech.onstart = () => {
                document.getElementById('voiceIndicator').classList.add('visible');
                document.getElementById('narrationText').textContent = 
                    text.substring(0, 50) + (text.length > 50 ? '...' : '');
            };
            
            currentSpeech.onend = () => {
                document.getElementById('voiceIndicator').classList.remove('visible');
                currentSpeech = null;
                
                if (guidedTourActive) {
                    setTimeout(nextStep, 2000);
                }
            };
            
            speechSynthesis.speak(currentSpeech);
        }

        function stopSpeech() {
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
                document.getElementById('voiceIndicator').classList.remove('visible');
            }
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('voiceToggle');
            btn.textContent = voiceEnabled ? '🔊' : '🔇';
            btn.classList.toggle('active', voiceEnabled);
            
            if (!voiceEnabled) {
                stopSpeech();
            }
        }

        function toggleAutoPlay() {
            autoPlayEnabled = !autoPlayEnabled;
            if (autoPlayEnabled) {
                startGuidedTour();
            } else {
                guidedTourActive = false;
            }
        }

        function toggleInfo() {
            const panel = document.getElementById('infoPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function startGuidedTour() {
            guidedTourActive = true;
            const steps = ['introduction', 'fish_breathing', 'lung_structure', 'breathing_mechanism', 'gas_exchange', 'diaphragm_action'];
            let stepIndex = 0;
            
            function tourStep() {
                if (stepIndex < steps.length && guidedTourActive) {
                    loadJourneyStep(steps[stepIndex]);
                    stepIndex++;
                } else {
                    guidedTourActive = false;
                    if (voiceEnabled) {
                        speakText("You've completed your journey through the human respiratory system! You now understand the structure and mechanics of breathing, from fish gills to human alveoli, and how gas exchange sustains life.");
                    }
                }
            }
            
            tourStep();
            window.nextStep = tourStep;
        }

        function showQuiz() {
            const questions = [
                "How do fish gills compare to human lungs in efficiency?",
                "What drives air movement during breathing?",
                "Where does gas exchange actually occur in the lungs?",
                "What role does the diaphragm play in breathing?",
                "How are the lungs structured to maximize surface area?"
            ];
            
            const randomQ = questions[Math.floor(Math.random() * questions.length)];
            
            if (voiceEnabled) {
                speakText(`Here's a respiratory system question: ${randomQ} Think about the structures and mechanisms we've explored!`);
            }
        }

        function init() {
            initVoiceSystem();
            
            setTimeout(() => {
                const loading = document.getElementById('loadingOverlay');
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                    
                    if (voiceEnabled) {
                        speakText("Welcome to your journey through respiratory systems! We'll explore how different organisms extract oxygen from their environment, from fish gills to human lungs. Discover the mechanics of breathing and the remarkable efficiency of gas exchange!");
                    }
                }, 1000);
            }, 3000);
            
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'v': toggleVoice(); break;
                    case 'i': toggleInfo(); break;
                    case 'g': startGuidedTour(); break;
                    case 'Escape': stopSpeech(); guidedTourActive = false; break;
                    case 'ArrowRight': nextStep && nextStep(); break;
                }
            });
        }

        init();
    </script>
</body>
</html>