<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propagation of Sound - Waves and Medium - Physics in Motion</title>
    <!-- GSAP for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: rgba(239, 68, 68, 1);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #ef4444, #f97316, #eab308);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Demo Stage */
        .demo-stage {
            background: linear-gradient(to bottom, #1e293b, #334155, #475569);
            border-radius: 25px;
            min-height: 500px;
            position: relative;
            margin: 40px 0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 3px solid rgba(239, 68, 68, 0.4);
            padding: 40px;
        }

        /* Sound Introduction Demo */
        .sound-intro-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .sound-intro-demo.active {
            display: block;
        }

        .motion-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: 100%;
        }

        .motion-type {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .motion-title {
            color: #ef4444;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .wave-container {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
        }

        .particle {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .wave-display {
            background: rgba(239, 68, 68, 0.2);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: #fca5a5;
            margin: 15px 0;
            border: 2px solid rgba(239, 68, 68, 0.4);
            font-family: 'Courier New', monospace;
        }

        .motion-description {
            line-height: 1.6;
            color: #e2e8f0;
            font-size: 1.1rem;
        }

        /* Density Pressure Demo */
        .density-pressure-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .density-pressure-demo.active {
            display: block;
        }

        .pressure-container {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            height: 100%;
        }

        .pressure-title {
            color: #ef4444;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .pressure-visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .pressure-graph {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            position: relative;
        }

        .graph-title {
            color: #fbbf24;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Sound Formula Demo */
        .sound-formula-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .sound-formula-demo.active {
            display: block;
        }

        .formula-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }

        .formula-section {
            background: rgba(15, 23, 42, 0.9);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(251, 191, 36, 0.4);
            text-align: center;
            min-width: 350px;
        }

        .formula-title {
            color: #fbbf24;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .formula {
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
            color: #fbbf24;
            margin: 20px 0;
            padding: 20px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .formula-explanation {
            color: #e2e8f0;
            line-height: 1.6;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        .interactive-calculator {
            background: rgba(15, 23, 42, 0.9);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(239, 68, 68, 0.4);
            min-width: 350px;
        }

        .calc-title {
            color: #ef4444;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-label {
            display: block;
            color: #fca5a5;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(239, 68, 68, 0.4);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        .calc-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 0;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .result-display {
            background: rgba(16, 185, 129, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(16, 185, 129, 0.4);
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #10b981;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Wave Types Demo */
        .wave-types-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .wave-types-demo.active {
            display: block;
        }

        /* Info Panel */
        .wave-info-overlay {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            border: 2px solid rgba(239, 68, 68, 0.4);
        }
        
        .wave-info-title {
            color: #ef4444;
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .wave-info-text {
            color: #e2e8f0;
            line-height: 1.5;
            font-size: 1rem;
        }
        
        /* Type Selection Buttons */
        .wave-type-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .wave-type-btn {
            background: linear-gradient(135deg, #334155, #1e293b);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .wave-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }
        
        .wave-type-btn.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Animation Stage */
        .wave-animation-stage {
            position: relative;
            height: 350px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Demo Containers */
        .wave-demo-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .wave-demo-container.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Slinky for waves */
        .slinky-container {
            position: relative;
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slinky-coil {
            width: 2px;
            height: 60px;
            background: #f39c12;
            margin: 0 2px;
            border-radius: 1px;
            position: absolute;
        }
        
        /* Data Panel */
        .wave-data-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .wave-data-item {
            flex: 1;
            text-align: center;
        }
        
        .wave-data-label {
            display: block;
            color: #e2e8f0;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .wave-data-value {
            display: block;
            color: #f39c12;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Pitch and Amplitude Demo */
        .pitch-amplitude-demo {
            display: none;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .pitch-amplitude-demo.active {
            display: block;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: 100%;
        }

        .demo-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .demo-card-title {
            color: #ef4444;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .wave-canvas {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
        }

        .demo-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }

        .control-button {
            background: linear-gradient(135deg, #334155, #1e293b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .control-button.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Visual Motion Demo */
        .visual-motion-demo {
            display: none;
            position: relative;
            width: 100%;
            min-height: 500px;
        }

        .visual-motion-demo.active {
            display: block;
        }

        .motion-scenarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .scenario-title {
            color: #ef4444;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .wave-visualization {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            margin: 15px 0;
            overflow: hidden;
        }

        .sound-source {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        .sound-wave-ring {
            position: absolute;
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 20px;
            transform: translate(-50%, -50%);
        }

        .scenario-info {
            text-align: center;
            color: #e2e8f0;
            margin-top: 10px;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        /* Speed Table */
        .speed-table {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .speed-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .speed-table th {
            background: rgba(239, 68, 68, 0.3);
            padding: 12px;
            text-align: left;
            color: #fbbf24;
            font-weight: 600;
        }

        .speed-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .speed-table tr:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Activity Demo */
        .activity-demo {
            display: none;
            padding: 30px;
        }

        .activity-demo.active {
            display: block;
        }

        .activity-visualization {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            margin: 20px 0;
        }

        .slinky-demo {
            position: relative;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-slinky-coil {
            width: 3px;
            height: 80px;
            background: linear-gradient(to bottom, #fbbf24, #f59e0b);
            margin: 0 1px;
            position: absolute;
            border-radius: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hand-marker {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-weight: bold;
            top: 50%;
            transform: translateY(-50%);
        }

        .activity-info {
            background: rgba(239, 68, 68, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #ef4444;
            color: #e2e8f0;
            line-height: 1.6;
        }

        /* Example Demo */
        .example-demo {
            display: none;
            padding: 15px 10px;
            overflow-x: hidden;
        }

        .example-demo.active {
            display: block;
        }

        .example-container {
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        .example-card {
            background: rgba(15, 23, 42, 0.9);
            padding: 20px 15px;
            border-radius: 15px;
            border: 2px solid rgba(239, 68, 68, 0.3);
            width: 98%;
            max-width: 100%;
            margin: 0 auto;
        }

        .example-title {
            color: #ef4444;
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05));
            padding: 10px;
            border-radius: 10px;
        }

        .example-problem {
            background: rgba(239, 68, 68, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px auto;
            border-left: 4px solid #ef4444;
            line-height: 1.6;
            font-size: 1rem;
            max-width: 95%;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        .solution-section {
            margin-bottom: 20px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .solution-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 100%;
            margin: 0 auto;
        }

        .solution-step {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            opacity: 1;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
            display: flex;
            flex-direction: column;
        }

        .solution-step.show {
            opacity: 1;
        }

        .step-label {
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .step-calculation {
            font-family: 'Courier New', monospace;
            color: #10b981;
            font-size: 1.2rem;
            margin: 8px 0;
            text-align: center;
            background: rgba(16, 185, 129, 0.1);
            padding: 8px;
            border-radius: 6px;
        }

        .final-answer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(251, 191, 36, 0.3));
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
            color: #fbbf24;
            border: 2px solid rgba(251, 191, 36, 0.4);
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Questions Demo */
        .questions-demo {
            display: none;
            padding: 30px;
        }

        .questions-demo.active {
            display: block;
        }
        
        /* Questions Carousel */
        .questions-carousel {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .questions-container {
            display: flex;
            transition: transform 0.5s ease;
            min-height: 400px;
        }
        
        .question-slide {
            flex: 0 0 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            position: absolute;
            width: 100%;
            left: 0;
            top: 0;
        }
        
        .question-slide.active {
            opacity: 1;
            visibility: visible;
            position: relative;
        }
        
        .carousel-nav {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 15px;
        }
        
        .carousel-btn {
            background: linear-gradient(135deg, #334155, #1e293b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .carousel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }
        
        .carousel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .carousel-indicator {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        
        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .indicator-dot.active {
            background: #ef4444;
            transform: scale(1.2);
        }

        .question-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin: 10px 0;
            border-left: 4px solid #ef4444;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .question-number {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .answer-section {
            background: rgba(239, 68, 68, 0.1);
            padding: 15px;
            margin-top: 5px;
            border-radius: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
        }

        .answer-section.show {
            opacity: 1;
            transform: translateY(0);
        }

        .show-answer-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .show-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #ef4444;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
            min-width: 150px;
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(239, 68, 68, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Theory Section */
        .theory-section {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(239, 68, 68, 0.4);
            backdrop-filter: blur(15px);
        }

        .concept-box {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(248, 113, 113, 0.2));
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .concept-box-title {
            font-size: 1.5rem;
            color: #ef4444;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .concept-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #e2e8f0;
        }

        .formula-highlight {
            background: rgba(251, 191, 36, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 2px solid rgba(251, 191, 36, 0.3);
        }

        .main-formula {
            font-size: 2rem;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 2.2rem; }
            .demo-stage { padding: 30px 20px; min-height: 400px; }
            .demo-buttons { flex-direction: column; align-items: center; }
            .motion-comparison { grid-template-columns: 1fr; }
            .formula-container { flex-direction: column; gap: 20px; }
            .motion-scenarios { grid-template-columns: 1fr; }
            .demo-grid { grid-template-columns: 1fr; }
            .pressure-visualization { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .container { padding: 20px 15px; }
            .header h1 { font-size: 1.8rem; }
            .demo-stage { padding: 20px 15px; }
            .theory-section { padding: 20px; }
            .main-formula { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">ðŸ”Š</span>
            <span class="mute-icon">ðŸ”‡</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Propagation of Sound</h1>
            <p>Discover how sound travels through different media, understand sound waves as mechanical waves, and learn about their characteristics and speed!</p>
        </div>

        <!-- Demo Stage -->
        <div class="demo-stage" id="stage">
            <!-- Sound Introduction Demo -->
            <div class="sound-intro-demo" id="sound-intro-demo">
                <div class="motion-comparison">
                    <div class="motion-type">
                        <div class="motion-title">Sound in Medium</div>
                        <div class="wave-container">
                            <div class="particle" id="particle-1" style="left: 20px;"></div>
                            <div class="particle" id="particle-2" style="left: 50px;"></div>
                            <div class="particle" id="particle-3" style="left: 80px;"></div>
                            <div class="particle" id="particle-4" style="left: 110px;"></div>
                            <div class="particle" id="particle-5" style="left: 140px;"></div>
                        </div>
                        <div class="wave-display" id="medium-display">Medium: Air</div>
                        <div class="motion-description">
                            Sound needs a medium to travel. Particles vibrate about their mean position but don't travel forward.
                            <br><br><strong>Mechanical Wave</strong>
                        </div>
                    </div>

                    <div class="motion-type">
                        <div class="motion-title">Compressions & Rarefactions</div>
                        <div class="wave-container">
                            <canvas id="wave-canvas" width="300" height="120"></canvas>
                        </div>
                        <div class="wave-display" id="wave-display">C - R - C - R</div>
                        <div class="motion-description">
                            Sound travels as alternating compressions (high pressure) and rarefactions (low pressure).
                            <br><br><strong>Longitudinal Wave</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Density Pressure Demo -->
            <div class="density-pressure-demo" id="density-pressure-demo">
                <div class="pressure-container">
                    <div class="pressure-title">Sound Propagates as Density & Pressure Variations</div>
                    <div class="pressure-visualization">
                        <div class="pressure-graph">
                            <div class="graph-title">Density Variation</div>
                            <canvas id="density-canvas" width="350" height="250"></canvas>
                        </div>
                        <div class="pressure-graph">
                            <div class="graph-title">Pressure Variation</div>
                            <canvas id="pressure-canvas" width="350" height="250"></canvas>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px; color: #e2e8f0; font-size: 1.1rem;">
                        Sound waves carry energy through alternating regions of high and low density/pressure
                    </div>
                </div>
            </div>

            <!-- Pitch and Amplitude Demo -->
            <div class="pitch-amplitude-demo" id="pitch-amplitude-demo">
                <div class="demo-grid">
                    <div class="demo-card">
                        <div class="demo-card-title">Pitch & Frequency</div>
                        <canvas id="pitch-canvas" class="wave-canvas" width="400" height="150"></canvas>
                        <div class="demo-controls">
                            <button class="control-button" id="low-pitch-btn" onclick="showPitch('low')">Low Pitch</button>
                            <button class="control-button" id="high-pitch-btn" onclick="showPitch('high')">High Pitch</button>
                        </div>
                        <div style="text-align: center; color: #e2e8f0; margin-top: 10px;">
                            <span id="pitch-info">Low frequency = Low pitch</span>
                        </div>
                    </div>

                    <div class="demo-card">
                        <div class="demo-card-title">Loudness & Amplitude</div>
                        <canvas id="amplitude-canvas" class="wave-canvas" width="400" height="150"></canvas>
                        <div class="demo-controls">
                            <button class="control-button" id="soft-sound-btn" onclick="showAmplitude('soft')">Soft Sound</button>
                            <button class="control-button" id="loud-sound-btn" onclick="showAmplitude('loud')">Loud Sound</button>
                        </div>
                        <div style="text-align: center; color: #e2e8f0; margin-top: 10px;">
                            <span id="amplitude-info">Small amplitude = Soft sound</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sound Formula Demo -->
            <div class="sound-formula-demo" id="sound-formula-demo">
                <div class="formula-container">
                    <div class="formula-section">
                        <div class="formula-title">Wave Speed Formula</div>
                        <div class="formula">v = Î» Ã— Î½</div>
                        <div class="formula-explanation">
                            <strong>Where:</strong><br>
                            v = speed of sound (m/s)<br>
                            Î» = wavelength (m)<br>
                            Î½ = frequency (Hz)<br><br>
                            <strong>Also: Î½ = 1/T</strong><br>
                            T = time period (s)
                        </div>
                    </div>

                    <div class="interactive-calculator">
                        <div class="calc-title">Sound Wave Calculator</div>
                        <div class="input-group">
                            <label class="input-label">Frequency (Hz):</label>
                            <input type="number" class="input-field" id="frequency-input" placeholder="Enter frequency">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Wavelength (m):</label>
                            <input type="number" class="input-field" id="wavelength-input" placeholder="Enter wavelength">
                        </div>
                        <button class="calc-btn" onclick="calculateSoundSpeed()">Calculate Speed</button>
                        <div class="result-display" id="speed-result">
                            Enter values to calculate speed
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wave Types Demo -->
            <div class="wave-types-demo" id="wave-types-demo">
                <!-- Info Panel -->
                <div class="wave-info-overlay" id="wave-info-overlay">
                    <div class="wave-info-title" id="wave-type-title">Select a wave characteristic</div>
                    <div class="wave-info-text" id="wave-info-text">Use the buttons below to explore different characteristics of sound waves</div>
                </div>
                
                <!-- Type Selection Buttons -->
                <div class="wave-type-buttons">
                    <button class="wave-type-btn" id="longitudinal-btn" onclick="waveTypeTab('longitudinal')">Longitudinal Waves</button>
                    <button class="wave-type-btn" id="compression-btn" onclick="waveTypeTab('compression')">Compressions</button>
                    <button class="wave-type-btn" id="rarefaction-btn" onclick="waveTypeTab('rarefaction')">Rarefactions</button>
                    <button class="wave-type-btn" id="characteristics-btn" onclick="waveTypeTab('characteristics')">Wave Characteristics</button>
                </div>
                
                <!-- Animation Stage -->
                <div class="wave-animation-stage">
                    <!-- Longitudinal Wave Demo -->
                    <div class="wave-demo-container" id="longitudinal-demo">
                        <div class="slinky-container" id="slinky-box">
                            <!-- Slinky coils will be generated dynamically -->
                        </div>
                        <div class="wave-data-panel">
                            <div class="wave-data-item">
                                <span class="wave-data-label">Wave Type:</span>
                                <span class="wave-data-value">Longitudinal</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Particle Motion:</span>
                                <span class="wave-data-value">Parallel to wave</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Example:</span>
                                <span class="wave-data-value">Sound waves</span>
                            </div>
                        </div>
                    </div>

                    <!-- Compression Demo -->
                    <div class="wave-demo-container" id="compression-demo">
                        <div class="wave-container" style="height: 150px;">
                            <!-- Compression particles -->
                        </div>
                        <div class="wave-data-panel">
                            <div class="wave-data-item">
                                <span class="wave-data-label">Region:</span>
                                <span class="wave-data-value">Compression</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Pressure:</span>
                                <span class="wave-data-value" id="compression-pressure">High</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Density:</span>
                                <span class="wave-data-value">Maximum</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rarefaction Demo -->
                    <div class="wave-demo-container" id="rarefaction-demo">
                        <div class="wave-container" style="height: 150px;">
                            <!-- Rarefaction particles -->
                        </div>
                        <div class="wave-data-panel">
                            <div class="wave-data-item">
                                <span class="wave-data-label">Region:</span>
                                <span class="wave-data-value">Rarefaction</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Pressure:</span>
                                <span class="wave-data-value" id="rarefaction-pressure">Low</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Density:</span>
                                <span class="wave-data-value">Minimum</span>
                            </div>
                        </div>
                    </div>

                    <!-- Characteristics Demo -->
                    <div class="wave-demo-container" id="characteristics-demo">
                        <canvas id="characteristics-canvas" width="500" height="150"></canvas>
                        <div class="wave-data-panel">
                            <div class="wave-data-item">
                                <span class="wave-data-label">Wavelength (Î»):</span>
                                <span class="wave-data-value" id="wavelength-display">35 cm</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Frequency (Î½):</span>
                                <span class="wave-data-value" id="frequency-display">440 Hz</span>
                            </div>
                            <div class="wave-data-item">
                                <span class="wave-data-label">Amplitude:</span>
                                <span class="wave-data-value" id="amplitude-display">Medium</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visual Motion Demo -->
            <div class="visual-motion-demo" id="visual-motion-demo">
                <div class="motion-scenarios">
                    <div class="scenario-card">
                        <div class="scenario-title">Sound in Solids</div>
                        <div class="wave-visualization">
                            <div class="sound-source" id="solid-source"></div>
                            <div class="sound-wave-ring" id="solid-wave-1"></div>
                            <div class="sound-wave-ring" id="solid-wave-2"></div>
                            <div class="sound-wave-ring" id="solid-wave-3"></div>
                        </div>
                        <div class="scenario-info">
                            Speed: ~5960 m/s (steel)<br>
                            Particles closely packed<br>
                            Fastest transmission
                        </div>
                    </div>

                    <div class="scenario-card">
                        <div class="scenario-title">Sound in Liquids</div>
                        <div class="wave-visualization">
                            <div class="sound-source" id="liquid-source"></div>
                            <div class="sound-wave-ring" id="liquid-wave-1"></div>
                            <div class="sound-wave-ring" id="liquid-wave-2"></div>
                            <div class="sound-wave-ring" id="liquid-wave-3"></div>
                        </div>
                        <div class="scenario-info">
                            Speed: ~1498 m/s (water)<br>
                            Moderate particle density<br>
                            Medium transmission
                        </div>
                    </div>

                    <div class="scenario-card">
                        <div class="scenario-title">Sound in Air</div>
                        <div class="wave-visualization">
                            <div class="sound-source" id="air-source"></div>
                            <div class="sound-wave-ring" id="air-wave-1"></div>
                            <div class="sound-wave-ring" id="air-wave-2"></div>
                            <div class="sound-wave-ring" id="air-wave-3"></div>
                        </div>
                        <div class="scenario-info">
                            Speed: ~344 m/s (22Â°C)<br>
                            Particles far apart<br>
                            Slowest transmission
                        </div>
                    </div>
                </div>

                <!-- Speed Table moved here -->
                <div class="concept-box" style="margin-top: 30px;">
                    <div class="concept-box-title">Speed of Sound in Different Media at 25Â°C</div>
                    <div class="speed-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>Substance</th>
                                    <th>Speed (m/s)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="6">Solids</td>
                                    <td>Aluminium</td>
                                    <td>6420</td>
                                </tr>
                                <tr>
                                    <td>Nickel</td>
                                    <td>6040</td>
                                </tr>
                                <tr>
                                    <td>Steel</td>
                                    <td>5960</td>
                                </tr>
                                <tr>
                                    <td>Iron</td>
                                    <td>5950</td>
                                </tr>
                                <tr>
                                    <td>Brass</td>
                                    <td>4700</td>
                                </tr>
                                <tr>
                                    <td>Glass (Flint)</td>
                                    <td>3980</td>
                                </tr>
                                <tr>
                                    <td rowspan="4">Liquids</td>
                                    <td>Sea Water</td>
                                    <td>1531</td>
                                </tr>
                                <tr>
                                    <td>Distilled Water</td>
                                    <td>1498</td>
                                </tr>
                                <tr>
                                    <td>Ethanol</td>
                                    <td>1207</td>
                                </tr>
                                <tr>
                                    <td>Methanol</td>
                                    <td>1103</td>
                                </tr>
                                <tr>
                                    <td rowspan="5">Gases</td>
                                    <td>Hydrogen</td>
                                    <td>1284</td>
                                </tr>
                                <tr>
                                    <td>Helium</td>
                                    <td>965</td>
                                </tr>
                                <tr>
                                    <td>Air</td>
                                    <td>346</td>
                                </tr>
                                <tr>
                                    <td>Oxygen</td>
                                    <td>316</td>
                                </tr>
                                <tr>
                                    <td>Sulphur dioxide</td>
                                    <td>213</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Demo -->
            <div class="activity-demo" id="activity-demo">
                <h2 style="color: #ef4444; text-align: center; margin-bottom: 30px;">Activity 11.4: Slinky Wave Demonstration</h2>
                
                <div class="activity-visualization">
                    <div class="slinky-demo" id="slinky-demo">
                        <!-- Animated slinky will be here -->
                    </div>
                    
                    <div class="activity-info" id="activity-step-info">
                        <strong>Step 1: Setup</strong><br>
                        Take a slinky. You and your friend hold opposite ends and stretch it.
                    </div>
                </div>
            </div>

            <!-- Example Demo -->
            <div class="example-demo" id="example-demo">
                <div class="example-container">
                    <!-- Example 11.1 -->
                    <div class="example-card">
                        <div class="example-title">Example 11.1</div>
                        <div class="example-problem">
                            <strong>Problem:</strong> A sound wave has a frequency of 2 kHz and wavelength 35 cm. 
                            How long will it take to travel 1.5 km?
                        </div>

                        <div class="solution-section">
                            <div class="solution-steps">
                                <div class="solution-step" id="ex1-step1">
                                    <div class="step-label">Given:</div>
                                    <div>Frequency, Î½ = 2 kHz = 2000 Hz</div>
                                    <div>Wavelength, Î» = 35 cm = 0.35 m</div>
                                    <div>Distance, d = 1.5 km = 1500 m</div>
                                </div>
                                <div class="solution-step" id="ex1-step2">
                                    <div class="step-label">Find Speed:</div>
                                    <div class="step-calculation">v = Î» Ã— Î½</div>
                                    <div class="step-calculation">v = 0.35 Ã— 2000 = 700 m/s</div>
                                </div>
                                <div class="solution-step" id="ex1-step3">
                                    <div class="step-label">Calculate Time:</div>
                                    <div class="step-calculation">t = d / v</div>
                                    <div class="step-calculation">t = 1500 / 700 = 2.14 s</div>
                                </div>
                                <div class="final-answer" id="ex1-answer">
                                    Time taken = 2.14 seconds
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions Demo -->
            <div class="questions-demo" id="questions-demo">
                <h2 style="color: #ef4444; text-align: center; margin-bottom: 30px;">Practice Questions</h2>
                
                <div class="questions-carousel">
                    <div class="questions-container">
                        <!-- Question 1 -->
                        <div class="question-slide" id="question-slide-1">
                            <div class="question-card">
                                <div class="question-number">Q1.</div>
                                <div class="question-text" id="question-text-1">
                                    What are sound waves? Why are they called mechanical waves?
                                </div>
                                <button class="show-answer-btn" onclick="showAnswer(1)">Show Answer</button>
                                <div class="answer-section" id="answer-1">
                                    <strong>Answer:</strong><br>
                                    Sound waves are disturbances that travel through a medium when particles of the medium set neighboring particles into motion. They are called mechanical waves because:<br>
                                    â€¢ They require a material medium for propagation<br>
                                    â€¢ They involve the motion of particles in the medium<br>
                                    â€¢ The particles vibrate about their mean position but don't travel forward
                                </div>
                            </div>
                        </div>
                        
                        <!-- Question 2 -->
                        <div class="question-slide" id="question-slide-2">
                            <div class="question-card">
                                <div class="question-number">Q2.</div>
                                <div class="question-text" id="question-text-2">
                                    Distinguish between compressions and rarefactions.
                                </div>
                                <button class="show-answer-btn" onclick="showAnswer(2)">Show Answer</button>
                                <div class="answer-section" id="answer-2">
                                    <strong>Answer:</strong><br>
                                    <strong>Compressions:</strong><br>
                                    â€¢ Regions of high pressure<br>
                                    â€¢ Particles are crowded together<br>
                                    â€¢ Maximum density of particles<br><br>
                                    <strong>Rarefactions:</strong><br>
                                    â€¢ Regions of low pressure<br>
                                    â€¢ Particles are spread apart<br>
                                    â€¢ Minimum density of particles
                                </div>
                            </div>
                        </div>
                        
                        <!-- Question 3 -->
                        <div class="question-slide" id="question-slide-3">
                            <div class="question-card">
                                <div class="question-number">Q3.</div>
                                <div class="question-text" id="question-text-3">
                                    Calculate the wavelength of a sound wave whose frequency is 220 Hz and speed is 440 m/s in a given medium.
                                </div>
                                <button class="show-answer-btn" onclick="showAnswer(3)">Show Answer</button>
                                <div class="answer-section" id="answer-3">
                                    <strong>Solution:</strong><br>
                                    Given: Frequency (Î½) = 220 Hz<br>
                                    Speed (v) = 440 m/s<br><br>
                                    Using: v = Î» Ã— Î½<br>
                                    Î» = v / Î½<br>
                                    Î» = 440 / 220 = 2 m<br><br>
                                    <strong>Answer: Wavelength = 2 m</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carousel Navigation -->
                    <div class="carousel-nav">
                        <button id="prev-question" class="carousel-btn" disabled>Previous</button>
                        <button id="next-question" class="carousel-btn">Next</button>
                    </div>
                    
                    <!-- Carousel Indicators -->
                    <div class="carousel-indicator">
                        <div class="indicator-dot active" data-slide="0"></div>
                        <div class="indicator-dot" data-slide="1"></div>
                        <div class="indicator-dot" data-slide="2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="demo-title">Explore Sound Propagation</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="playCompleteLesson()">ðŸ“š Complete Lesson</button>
                <button class="demo-btn" onclick="showSoundIntro()">ðŸƒâ€â™‚ï¸ What is Sound?</button>
                <button class="demo-btn" onclick="showDensityPressure()">ðŸ“Š Density/Pressure</button>
                <button class="demo-btn" onclick="showPitchAmplitude()">ðŸŽµ Pitch & Loudness</button>
                <button class="demo-btn" onclick="showSoundFormula()">ðŸ§® Wave Formula</button>
                <button class="demo-btn" onclick="showWaveTypes()">ðŸŒŠ Wave Types</button>
                <button class="demo-btn" onclick="showVisualMotion()">ðŸ‘ï¸ Sound in Media</button>
                <button class="demo-btn" onclick="showActivity()">ðŸ”¬ Activity 11.4</button>
                <button class="demo-btn" onclick="showExample()">ðŸ“– NCERT Example</button>
                <button class="demo-btn" onclick="showQuestions()">â“ Questions</button>
                <button class="demo-btn" onclick="resetAllClick()">ðŸ”„ Reset</button>
            </div>
        </div>

        <!-- Theory Section -->
        <div class="theory-section">
            <div class="concept-box">
                <div class="concept-box-title">Understanding Sound Propagation</div>
                <div class="concept-text">
                    Sound is produced by vibrating objects and travels through a medium (solid, liquid, or gas). 
                    The disturbance moves through the medium, not the particles themselves. Particles only vibrate 
                    about their mean position, making sound a mechanical wave.
                </div>
            </div>

            <div class="formula-highlight">
                <div class="main-formula">v = Î» Ã— Î½</div>
                <div style="margin-top: 15px; line-height: 1.8; color: #e2e8f0;">
                    <strong>Speed of Sound = Wavelength Ã— Frequency</strong><br>
                    <strong>SI Units:</strong> Speed (m/s), Wavelength (m), Frequency (Hz)<br>
                    <strong>Nature:</strong> Longitudinal mechanical wave
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div class="concept-box">
                    <div class="concept-box-title">Sound Wave Characteristics</div>
                    <div class="concept-text">
                        â€¢ <strong>Frequency:</strong> Number of oscillations per second (Hz)<br>
                        â€¢ <strong>Wavelength:</strong> Distance between consecutive compressions<br>
                        â€¢ <strong>Amplitude:</strong> Maximum displacement from mean<br>
                        â€¢ <strong>Time Period:</strong> Time for one complete oscillation<br>
                        â€¢ <strong>Pitch:</strong> How brain interprets frequency<br>
                        â€¢ <strong>Loudness:</strong> Determined by amplitude
                    </div>
                </div>
                <div class="concept-box">
                    <div class="concept-box-title">Longitudinal Waves</div>
                    <div class="concept-text">
                        â€¢ Particles oscillate parallel to wave direction<br>
                        â€¢ Create compressions and rarefactions<br>
                        â€¢ Compression: High pressure region<br>
                        â€¢ Rarefaction: Low pressure region<br>
                        â€¢ Sound cannot travel in vacuum<br>
                        â€¢ Speed depends on medium properties
                    </div>
                </div>
            </div>

            <div class="concept-box">
                <div class="concept-box-title">Key Points to Remember</div>
                <div class="concept-text">
                    â€¢ Sound needs a medium to travel - it cannot travel through vacuum<br>
                    â€¢ Speed of sound: Solids > Liquids > Gases<br>
                    â€¢ Speed increases with temperature<br>
                    â€¢ Sound travels slower than light (that's why we see lightning before hearing thunder)<br>
                    â€¢ Frequency remains constant when sound travels through different media<br>
                    â€¢ Higher frequency = Higher pitch; Greater amplitude = Louder sound<br>
                    â€¢ Sound intensity decreases with distance from source
                </div>
            </div>
        </div>
    </div>

    <script>
        // Voice Teacher System
        class PhysicsTeacher {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global state management
        let globalAudioEnabled = true;
        let currentTeacher = null;
        let isPlaying = false;
        let animationTimeline = null;
        let currentDemoAborted = false;
        let activeAnimations = [];
        let currentRunId = 0;
        let currentTaskId = null;

        // State management functions
        function createNewTimeline() {
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            activeAnimations.forEach(anim => {
                if (anim) anim.kill();
            });
            activeAnimations = [];
            gsap.killTweensOf("*");
            
            const newTimeline = gsap.timeline();
            animationTimeline = newTimeline;
            return newTimeline;
        }

        function trackAnimation(animation) {
            if (animation) {
                activeAnimations.push(animation);
            }
            return animation;
        }

        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentRunId++;
            
            if (currentTeacher) {
                currentTeacher.destroy();
                currentTeacher = null;
            }
            
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            
            activeAnimations.forEach(anim => {
                if (anim && typeof anim.kill === 'function') {
                    anim.kill();
                } else if (anim && typeof anim === 'object') {
                    // For interval-based animations
                    clearInterval(anim);
                }
            });
            activeAnimations = [];
            
            gsap.killTweensOf("*");
            
            document.querySelectorAll('.sound-intro-demo, .density-pressure-demo, .pitch-amplitude-demo, .sound-formula-demo, .wave-types-demo, .visual-motion-demo, .activity-demo, .example-demo, .questions-demo').forEach(demo => {
                demo.classList.remove('active');
            });
            
            isPlaying = false;
        }

        function shouldContinue(taskId) {
            if (!taskId) {
                return !currentDemoAborted;
            }
            return !currentDemoAborted && currentTaskId === taskId;
        }

        function createNewTeacher(taskId) {
            if (currentTeacher) {
                currentTeacher.destroy();
                currentTeacher = null;
            }
            currentDemoAborted = false;
            
            if (taskId) {
                currentTaskId = taskId;
            }
            currentTeacher = new PhysicsTeacher();
            return currentTeacher;
        }

        // Initialize
        window.addEventListener('load', () => {
            const teacher = createNewTeacher();
            teacher.speak("Welcome to Propagation of Sound! Let's explore how sound travels through different media and understand the nature of sound waves!");
        });

        // Complete Lesson
        async function playCompleteLesson() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(0);
            
            const teacher = createNewTeacher('complete-lesson');
            
            await resetAll();
            await wait(100);
            if (!shouldContinue('complete-lesson')) return;
            
            updateTitle("ðŸ“š Complete Sound Propagation Lesson");
            
            await teacher.speak("Let's begin our complete lesson on Propagation of Sound. We'll understand how sound travels and its wave characteristics.");
            if (!shouldContinue('complete-lesson')) return;
            
            await showSoundIntroInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Now let's see how sound propagates as density and pressure variations.");
            if (!shouldContinue('complete-lesson')) return;
            await showDensityPressureInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Let's understand how frequency affects pitch and amplitude affects loudness.");
            if (!shouldContinue('complete-lesson')) return;
            await showPitchAmplitudeInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Now let's learn the mathematical relationship between wave speed, wavelength, and frequency.");
            if (!shouldContinue('complete-lesson')) return;
            await showSoundFormulaInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Next, let's understand different types and characteristics of sound waves.");
            if (!shouldContinue('complete-lesson')) return;
            await showWaveTypesInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Now let's see how sound travels differently through solids, liquids, and gases.");
            if (!shouldContinue('complete-lesson')) return;
            await showVisualMotionInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Let's explore the slinky activity that demonstrates longitudinal wave motion.");
            if (!shouldContinue('complete-lesson')) return;
            await showActivityInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await wait(2000);
            
            await teacher.speak("Finally, let's solve the NCERT example to apply our understanding of wave calculations.");
            if (!shouldContinue('complete-lesson')) return;
            await showExampleInternal(teacher);
            if (!shouldContinue('complete-lesson')) return;
            
            await teacher.speak("Excellent! You now understand how sound propagates through media as longitudinal waves with compressions and rarefactions!");
            
            isPlaying = false;
        }

        // Sound Introduction Demo
        async function showSoundIntro() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(1);
            
            const teacher = createNewTeacher('sound-intro');
            await showSoundIntroInternal(teacher);
            
            isPlaying = false;
        }

        async function showSoundIntroInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸƒâ€â™‚ï¸ Understanding Sound Propagation");
            
            document.getElementById('sound-intro-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Sound is produced by vibrating objects and needs a medium to travel. Let's see how particles behave when sound travels through them.");
            if (!shouldContinue(taskId)) return;
            
            animateParticles();
            await wait(2000);
            
            await teacher.speak("Notice how particles vibrate about their mean position but don't travel forward. The disturbance moves through the medium, not the particles themselves.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            animateWavePattern();
            await wait(2000);
            
            await teacher.speak("Sound travels as alternating compressions and rarefactions. This makes sound a longitudinal mechanical wave!");
            if (!shouldContinue(taskId)) return;
        }

        function animateParticles() {
            for (let i = 1; i <= 5; i++) {
                const particle = document.getElementById(`particle-${i}`);
                const delay = (i - 1) * 0.2;
                
                trackAnimation(gsap.to(particle, {
                    duration: 1,
                    x: "+=20",
                    repeat: -1,
                    yoyo: true,
                    ease: "sine.inOut",
                    delay: delay
                }));
            }
        }

        function animateWavePattern() {
            const canvas = document.getElementById('wave-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 120;
            
            let time = 0;
            
            function drawWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw compressions and rarefactions
                for (let x = 0; x < canvas.width; x += 5) {
                    const density = Math.sin((x - time) * 0.05) * 30 + 60;
                    const opacity = density / 90;
                    
                    ctx.fillStyle = `rgba(239, 68, 68, ${opacity})`;
                    ctx.fillRect(x, 60 - density/2, 3, density);
                }
                
                time += 2;
                if (time > 126) time = 0;
            }
            
            const waveAnimation = setInterval(drawWave, 50);
            activeAnimations.push(waveAnimation);
        }

        // Density Pressure Demo
        async function showDensityPressure() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(2);
            
            const teacher = createNewTeacher('density-pressure');
            await showDensityPressureInternal(teacher);
            
            isPlaying = false;
        }

        async function showDensityPressureInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸ“Š Density & Pressure Variations");
            
            document.getElementById('density-pressure-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Sound propagates as variations in density and pressure. Let's visualize how these variations create the wave pattern.");
            if (!shouldContinue(taskId)) return;
            
            animateDensityPressureGraphs();
            
            await wait(3000);
            
            await teacher.speak("Notice how density and pressure vary above and below the average value. High density regions are compressions, low density regions are rarefactions.");
            if (!shouldContinue(taskId)) return;
        }

        function animateDensityPressureGraphs() {
            const densityCanvas = document.getElementById('density-canvas');
            const pressureCanvas = document.getElementById('pressure-canvas');
            
            if (!densityCanvas || !pressureCanvas) return;
            
            const densityCtx = densityCanvas.getContext('2d');
            const pressureCtx = pressureCanvas.getContext('2d');
            
            densityCanvas.width = 350;
            densityCanvas.height = 250;
            pressureCanvas.width = 350;
            pressureCanvas.height = 250;
            
            let time = 0;
            
            function drawGraphs() {
                // Clear canvases
                densityCtx.clearRect(0, 0, densityCanvas.width, densityCanvas.height);
                pressureCtx.clearRect(0, 0, pressureCanvas.width, pressureCanvas.height);
                
                // Draw axes
                densityCtx.strokeStyle = '#6b7280';
                densityCtx.lineWidth = 2;
                densityCtx.beginPath();
                densityCtx.moveTo(30, 20);
                densityCtx.lineTo(30, 220);
                densityCtx.lineTo(330, 220);
                densityCtx.stroke();
                
                pressureCtx.strokeStyle = '#6b7280';
                pressureCtx.lineWidth = 2;
                pressureCtx.beginPath();
                pressureCtx.moveTo(30, 20);
                pressureCtx.lineTo(30, 220);
                pressureCtx.lineTo(330, 220);
                pressureCtx.stroke();
                
                // Draw average line
                densityCtx.strokeStyle = '#94a3b8';
                densityCtx.setLineDash([5, 5]);
                densityCtx.beginPath();
                densityCtx.moveTo(30, 120);
                densityCtx.lineTo(330, 120);
                densityCtx.stroke();
                densityCtx.setLineDash([]);
                
                pressureCtx.strokeStyle = '#94a3b8';
                pressureCtx.setLineDash([5, 5]);
                pressureCtx.beginPath();
                pressureCtx.moveTo(30, 120);
                pressureCtx.lineTo(330, 120);
                pressureCtx.stroke();
                pressureCtx.setLineDash([]);
                
                // Draw waves
                densityCtx.strokeStyle = '#fbbf24';
                densityCtx.lineWidth = 3;
                densityCtx.beginPath();
                
                pressureCtx.strokeStyle = '#ef4444';
                pressureCtx.lineWidth = 3;
                pressureCtx.beginPath();
                
                for (let x = 0; x < 300; x++) {
                    const y = 120 + Math.sin((x - time) * 0.03) * 60;
                    
                    if (x === 0) {
                        densityCtx.moveTo(30 + x, y);
                        pressureCtx.moveTo(30 + x, y);
                    } else {
                        densityCtx.lineTo(30 + x, y);
                        pressureCtx.lineTo(30 + x, y);
                    }
                }
                
                densityCtx.stroke();
                pressureCtx.stroke();
                
                // Labels
                densityCtx.fillStyle = '#e2e8f0';
                densityCtx.font = '12px Arial';
                densityCtx.fillText('Distance', 160, 240);
                densityCtx.save();
                densityCtx.translate(10, 120);
                densityCtx.rotate(-Math.PI/2);
                densityCtx.fillText('Density', 0, 0);
                densityCtx.restore();
                
                pressureCtx.fillStyle = '#e2e8f0';
                pressureCtx.font = '12px Arial';
                pressureCtx.fillText('Distance', 160, 240);
                pressureCtx.save();
                pressureCtx.translate(10, 120);
                pressureCtx.rotate(-Math.PI/2);
                pressureCtx.fillText('Pressure', 0, 0);
                pressureCtx.restore();
                
                time += 3;
                if (time > 210) time = 0;
            }
            
            const graphAnimation = setInterval(drawGraphs, 50);
            activeAnimations.push(graphAnimation);
        }

        // Pitch and Amplitude Demo
        async function showPitchAmplitude() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(3);
            
            const teacher = createNewTeacher('pitch-amplitude');
            await showPitchAmplitudeInternal(teacher);
            
            isPlaying = false;
        }

        async function showPitchAmplitudeInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸŽµ Pitch & Loudness");
            
            document.getElementById('pitch-amplitude-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Let's see how frequency affects pitch and amplitude affects loudness of sound.");
            if (!shouldContinue(taskId)) return;
            
            // Show low pitch with animation
            showPitch('low');
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Low frequency produces low pitch sound, like a bass drum.");
            if (!shouldContinue(taskId)) return;
            
            // Show high pitch with animation
            showPitch('high');
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("High frequency produces high pitch sound, like a whistle.");
            if (!shouldContinue(taskId)) return;
            
            // Show soft sound with animation
            showAmplitude('soft');
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Small amplitude produces soft sound, like whispering.");
            if (!shouldContinue(taskId)) return;
            
            // Show loud sound with animation
            showAmplitude('loud');
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Large amplitude produces loud sound, like shouting. The energy carried by the wave increases with amplitude.");
            if (!shouldContinue(taskId)) return;
        }

        // Store animation intervals for pitch and amplitude
        let pitchAnimation = null;
        let amplitudeAnimation = null;

        function showPitch(type) {
            const canvas = document.getElementById('pitch-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 150;
            
            // Clear buttons active state
            document.getElementById('low-pitch-btn').classList.remove('active');
            document.getElementById('high-pitch-btn').classList.remove('active');
            
            // Clear previous animation
            if (pitchAnimation) {
                clearInterval(pitchAnimation);
                pitchAnimation = null;
            }
            
            // Set active button
            if (type === 'low') {
                document.getElementById('low-pitch-btn').classList.add('active');
                document.getElementById('pitch-info').textContent = 'Low frequency = Low pitch';
            } else {
                document.getElementById('high-pitch-btn').classList.add('active');
                document.getElementById('pitch-info').textContent = 'High frequency = High pitch';
            }
            
            // Animate wave
            let time = 0;
            const frequency = type === 'low' ? 0.02 : 0.06;
            const speed = type === 'low' ? 2 : 6;
            
            function drawWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let x = 0; x < canvas.width; x++) {
                    const y = 75 + Math.sin((x - time) * frequency) * 40;
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                time += speed;
                if (time > canvas.width) time = 0;
            }
            
            drawWave();
            pitchAnimation = setInterval(drawWave, 50);
            activeAnimations.push(pitchAnimation);
        }

        function showAmplitude(type) {
            const canvas = document.getElementById('amplitude-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 150;
            
            // Clear buttons active state
            document.getElementById('soft-sound-btn').classList.remove('active');
            document.getElementById('loud-sound-btn').classList.remove('active');
            
            // Clear previous animation
            if (amplitudeAnimation) {
                clearInterval(amplitudeAnimation);
                amplitudeAnimation = null;
            }
            
            // Set active button
            if (type === 'soft') {
                document.getElementById('soft-sound-btn').classList.add('active');
                document.getElementById('amplitude-info').textContent = 'Small amplitude = Soft sound';
            } else {
                document.getElementById('loud-sound-btn').classList.add('active');
                document.getElementById('amplitude-info').textContent = 'Large amplitude = Loud sound';
            }
            
            // Animate wave
            let time = 0;
            const amplitude = type === 'soft' ? 20 : 60;
            
            function drawWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let x = 0; x < canvas.width; x++) {
                    const y = 75 + Math.sin((x - time) * 0.03) * amplitude;
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                time += 3;
                if (time > canvas.width) time = 0;
            }
            
            drawWave();
            amplitudeAnimation = setInterval(drawWave, 50);
            activeAnimations.push(amplitudeAnimation);
        }

        // Sound Formula Demo
        async function showSoundFormula() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(4);
            
            const teacher = createNewTeacher('sound-formula');
            await showSoundFormulaInternal(teacher);
            
            isPlaying = false;
        }

        async function showSoundFormulaInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸ§® Wave Speed Formula");
            
            document.getElementById('sound-formula-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue()) return;
            
            await teacher.speak("The speed of sound equals wavelength times frequency. This fundamental relationship helps us calculate wave properties. Try the calculator!");
            if (!shouldContinue()) return;
            
            await wait(2500);
            
            await teacher.speak("Remember, frequency is the reciprocal of time period. The speed of sound depends on the medium and temperature.");
        }

        // Sound Calculator Function
        function calculateSoundSpeed() {
            const frequency = parseFloat(document.getElementById('frequency-input').value);
            const wavelength = parseFloat(document.getElementById('wavelength-input').value);
            const resultDiv = document.getElementById('speed-result');
            
            if (isNaN(frequency) || isNaN(wavelength) || frequency <= 0 || wavelength <= 0) {
                resultDiv.innerHTML = 'âš ï¸ Please enter valid values';
                return;
            }
            
            const speed = (frequency * wavelength).toFixed(2);
            const timePeriod = (1 / frequency).toFixed(6);
            
            resultDiv.innerHTML = `
                <div>
                    <strong>Speed:</strong> ${speed} m/s<br>
                    <small>Time Period: ${timePeriod} s</small>
                </div>
            `;
            
            if (currentTeacher) {
                currentTeacher.speak(`The speed of sound is ${speed} meters per second.`);
            }
        }

        // Wave Types Demo
        async function showWaveTypes() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(5);
            
            const teacher = createNewTeacher('wave-types');
            await showWaveTypesInternal(teacher);
            
            isPlaying = false;
        }

        async function showWaveTypesInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸŒŠ Types of Sound Waves");
            
            document.getElementById('wave-types-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Sound waves are longitudinal waves with compressions and rarefactions. Let's explore their characteristics one by one.");
            if (!shouldContinue(taskId)) return;
            
            await wait(500);
            
            // Play wave types sequentially
            await playWaveTypesSequentially(teacher, taskId);
        }

        async function playWaveTypesSequentially(teacher, taskId) {
            // Show longitudinal waves
            showLongitudinalWave();
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Longitudinal waves have particles oscillating parallel to wave direction. This is exactly how sound waves propagate through a medium.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            // Show compression
            showCompression();
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Compressions are high-pressure regions where particles are pushed together. These represent the peaks in a sound wave.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            // Show rarefaction
            showRarefaction();
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Rarefactions are low-pressure regions where particles are spread apart. These represent the troughs in a sound wave.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            if (!shouldContinue(taskId)) return;
            
            // Show characteristics
            showCharacteristics();
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Wave characteristics include wavelength, frequency, and amplitude. These determine the pitch and loudness of sound.");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
        }

        function waveTypeTab(which) {
            if (which === 'longitudinal') {
                showLongitudinalWave();
            } else if (which === 'compression') {
                showCompression();
            } else if (which === 'rarefaction') {
                showRarefaction();
            } else if (which === 'characteristics') {
                showCharacteristics();
            }
        }

        function showLongitudinalWave() {
            resetWaveDemos();
            setActiveWaveButton("longitudinal-btn");
            document.getElementById('longitudinal-demo').classList.add('active');
            
            document.getElementById('wave-type-title').textContent = "Longitudinal Waves";
            document.getElementById('wave-info-text').textContent = 
                "In longitudinal waves, particles oscillate parallel to the direction of wave propagation. Sound waves are longitudinal.";
            
            // Create slinky animation
            const slinkyBox = document.getElementById('slinky-box');
            slinkyBox.innerHTML = '';
            
            for (let i = 0; i < 40; i++) {
                const coil = document.createElement('div');
                coil.className = 'slinky-coil';
                coil.style.left = `${i * 8}px`;
                slinkyBox.appendChild(coil);
                
                trackAnimation(gsap.to(coil, {
                    duration: 2,
                    x: Math.sin(i * 0.3) * 15,
                    repeat: -1,
                    ease: "sine.inOut",
                    delay: i * 0.05
                }));
            }
        }

        function showCompression() {
            resetWaveDemos();
            setActiveWaveButton("compression-btn");
            document.getElementById('compression-demo').classList.add('active');
            
            document.getElementById('wave-type-title').textContent = "Compressions";
            document.getElementById('wave-info-text').textContent = 
                "Compressions are regions where particles are crowded together, creating high pressure and maximum density.";
            
            const container = document.querySelector('#compression-demo .wave-container');
            container.innerHTML = '';
            
            // Create compressed particles
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const spacing = i < 10 ? 8 : 20; // Compressed in middle
                particle.style.left = `${50 + i * spacing}px`;
                container.appendChild(particle);
                
                trackAnimation(gsap.to(particle, {
                    duration: 1.5,
                    scale: i < 10 ? 1.2 : 0.8,
                    repeat: -1,
                    yoyo: true
                }));
            }
        }

        function showRarefaction() {
            resetWaveDemos();
            setActiveWaveButton("rarefaction-btn");
            document.getElementById('rarefaction-demo').classList.add('active');
            
            document.getElementById('wave-type-title').textContent = "Rarefactions";
            document.getElementById('wave-info-text').textContent = 
                "Rarefactions are regions where particles are spread apart, creating low pressure and minimum density.";
            
            const container = document.querySelector('#rarefaction-demo .wave-container');
            container.innerHTML = '';
            
            // Create rarefied particles
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const spacing = i > 5 && i < 10 ? 40 : 15; // Spread in middle
                particle.style.left = `${30 + i * spacing}px`;
                container.appendChild(particle);
                
                trackAnimation(gsap.to(particle, {
                    duration: 1.5,
                    scale: i > 5 && i < 10 ? 0.6 : 1,
                    opacity: i > 5 && i < 10 ? 0.5 : 1,
                    repeat: -1,
                    yoyo: true
                }));
            }
        }

        function showCharacteristics() {
            resetWaveDemos();
            setActiveWaveButton("characteristics-btn");
            document.getElementById('characteristics-demo').classList.add('active');
            
            document.getElementById('wave-type-title').textContent = "Wave Characteristics";
            document.getElementById('wave-info-text').textContent = 
                "Sound waves have wavelength, frequency, amplitude, and time period. These determine pitch and loudness.";
            
            // Draw wave characteristics on canvas
            const canvas = document.getElementById('characteristics-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = 500;
                canvas.height = 150;
                
                function drawCharacteristics() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw wave
                    ctx.strokeStyle = '#f39c12';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let x = 0; x < canvas.width; x++) {
                        const y = 75 + Math.sin(x * 0.02) * 40;
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    
                    // Draw wavelength arrow
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(50, 120);
                    ctx.lineTo(365, 120);
                    ctx.stroke();
                    
                    // Arrow heads
                    ctx.beginPath();
                    ctx.moveTo(50, 120);
                    ctx.lineTo(60, 115);
                    ctx.moveTo(50, 120);
                    ctx.lineTo(60, 125);
                    ctx.moveTo(365, 120);
                    ctx.lineTo(355, 115);
                    ctx.moveTo(365, 120);
                    ctx.lineTo(355, 125);
                    ctx.stroke();
                    
                    // Label
                    ctx.fillStyle = '#ef4444';
                    ctx.font = '14px Arial';
                    ctx.fillText('Î» (wavelength)', 180, 140);
                    
                    // Amplitude lines
                    ctx.strokeStyle = '#10b981';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(0, 35);
                    ctx.lineTo(canvas.width, 35);
                    ctx.moveTo(0, 115);
                    ctx.lineTo(canvas.width, 115);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                drawCharacteristics();
            }
        }

        function resetWaveDemos() {
            document.querySelectorAll('.wave-demo-container').forEach(demo => {
                demo.classList.remove('active');
            });
            
            document.querySelectorAll('.wave-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            gsap.killTweensOf(".particle, .slinky-coil");
        }

        function setActiveWaveButton(id) {
            document.querySelectorAll('.wave-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        // Visual Motion Demo
        async function showVisualMotion() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(6);
            
            const teacher = createNewTeacher('visual-motion');
            await showVisualMotionInternal(teacher);
            
            isPlaying = false;
        }

        async function showVisualMotionInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸ‘ï¸ Sound in Different Media");
            
            document.getElementById('visual-motion-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Sound travels at different speeds through solids, liquids, and gases. Let's visualize this difference.");
            if (!shouldContinue(taskId)) return;
            
            animateSoundWaves();
            
            await wait(3000);
            
            await teacher.speak("Notice how sound travels fastest in solids at about 5960 meters per second in steel, medium speed in liquids at about 1498 meters per second in water, and slowest in gases at about 344 meters per second in air!");
            if (!shouldContinue(taskId)) return;
        }

        function animateSoundWaves() {
            // Animate solid waves (fastest)
            animateWaveRings('solid', 0.5);
            
            // Animate liquid waves (medium speed)
            animateWaveRings('liquid', 1.5);
            
            // Animate air waves (very slow)
            animateWaveRings('air', 3.5);
        }

        function animateWaveRings(medium, duration) {
            for (let i = 1; i <= 3; i++) {
                const ring = document.getElementById(`${medium}-wave-${i}`);
                
                trackAnimation(gsap.to(ring, {
                    duration: duration,
                    width: 150,
                    height: 150,
                    opacity: 0,
                    repeat: -1,
                    delay: (i - 1) * duration / 3,
                    ease: "power2.out",
                    onRepeat: function() {
                        gsap.set(ring, {
                            width: 30,
                            height: 30,
                            opacity: 1
                        });
                    }
                }));
            }
        }

        // Activity Demo
        async function showActivity() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(7);
            
            const teacher = createNewTeacher('activity');
            await showActivityInternal(teacher);
            
            isPlaying = false;
        }

        async function showActivityInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸ”¬ Activity 11.4: Slinky Demonstration");
            
            document.getElementById('activity-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Activity 11.4 demonstrates longitudinal waves using a slinky. Let's see each step in action.");
            if (!shouldContinue(taskId)) return;
            
            // Step 1: Setup
            await animateActivityStep1(teacher, taskId);
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            // Step 2: Push motion
            await animateActivityStep2(teacher, taskId);
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            // Step 3: Push-pull motion
            await animateActivityStep3(teacher, taskId);
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            // Step 4: Observation
            await animateActivityStep4(teacher, taskId);
            if (!shouldContinue(taskId)) return;
        }

        async function animateActivityStep1(teacher, taskId) {
            const stepInfo = document.getElementById('activity-step-info');
            stepInfo.innerHTML = `<strong>Step 1: Setup</strong><br>Take a slinky. You and your friend hold opposite ends and stretch it.`;
            
            const slinkyDemo = document.getElementById('slinky-demo');
            slinkyDemo.innerHTML = '';
            
            // Create slinky coils first
            for (let i = 0; i < 50; i++) {
                const coil = document.createElement('div');
                coil.className = 'activity-slinky-coil';
                coil.style.left = `${70 + i * 6}px`;
                slinkyDemo.appendChild(coil);
            }
            
            // Add hands at the ends of the slinky
            const leftHand = document.createElement('div');
            leftHand.className = 'hand-marker';
            leftHand.id = 'left-hand';
            leftHand.style.left = '20px';
            leftHand.textContent = 'L';
            slinkyDemo.appendChild(leftHand);
            
            const rightHand = document.createElement('div');
            rightHand.className = 'hand-marker';
            rightHand.id = 'right-hand';
            // Calculate position: last coil position (70 + 49*6) + some offset for the hand
            rightHand.style.left = `${70 + 49 * 6 + 10}px`; // Position at the actual end of the slinky
            rightHand.textContent = 'R';
            slinkyDemo.appendChild(rightHand);
            
            await teacher.speak("First, stretch the slinky between you and your friend. Each person holds one end.");
        }

        async function animateActivityStep2(teacher, taskId) {
            const stepInfo = document.getElementById('activity-step-info');
            stepInfo.innerHTML = `<strong>Step 2: Create Compression</strong><br>Give the slinky a sharp push towards your friend. Observe how the compression travels.`;
            
            const leftHand = document.getElementById('left-hand');
            const coils = document.querySelectorAll('.activity-slinky-coil');
            
            // Animate hand push
            trackAnimation(gsap.to(leftHand, {
                duration: 0.3,
                x: 50,
                yoyo: true,
                repeat: 1,
                ease: "power2.inOut"
            }));
            
            // Create compression wave
            coils.forEach((coil, i) => {
                trackAnimation(gsap.to(coil, {
                    duration: 0.5,
                    x: i < 10 ? 30 : 0,
                    delay: i * 0.02,
                    yoyo: true,
                    repeat: 1,
                    ease: "power2.inOut"
                }));
            });
            
            await teacher.speak("Push the slinky sharply. See how the compression travels along the slinky from one end to the other.");
        }

        async function animateActivityStep3(teacher, taskId) {
            const stepInfo = document.getElementById('activity-step-info');
            stepInfo.innerHTML = `<strong>Step 3: Continuous Wave</strong><br>Move your hand pushing and pulling alternatively. This creates a series of compressions and rarefactions.`;
            
            const leftHand = document.getElementById('left-hand');
            const coils = document.querySelectorAll('.activity-slinky-coil');
            
            // Animate continuous push-pull
            trackAnimation(gsap.to(leftHand, {
                duration: 1,
                x: "+=30",
                repeat: 4,
                yoyo: true,
                ease: "sine.inOut"
            }));
            
            // Create wave pattern in slinky
            coils.forEach((coil, i) => {
                trackAnimation(gsap.to(coil, {
                    duration: 2,
                    x: function() {
                        return Math.sin(i * 0.2) * 20;
                    },
                    repeat: 2,
                    yoyo: true,
                    ease: "sine.inOut",
                    delay: i * 0.03
                }));
            });
            
            await teacher.speak("Push and pull repeatedly. This creates alternating compressions and rarefactions, just like sound waves!");
        }

        async function animateActivityStep4(teacher, taskId) {
            const stepInfo = document.getElementById('activity-step-info');
            stepInfo.innerHTML = `<strong>Step 4: Observation</strong><br>Mark a dot on the slinky. Notice it moves back and forth parallel to wave direction, not forward. This demonstrates longitudinal wave motion.`;
            
            const slinkyDemo = document.getElementById('slinky-demo');
            const coils = document.querySelectorAll('.activity-slinky-coil');
            
            // Add a marked coil
            if (coils[25]) {
                coils[25].style.background = '#ef4444';
                coils[25].style.height = '100px';
                
                // Animate the marked coil
                trackAnimation(gsap.to(coils[25], {
                    duration: 2,
                    x: "+=40",
                    repeat: 3,
                    yoyo: true,
                    ease: "sine.inOut"
                }));
            }
            
            await teacher.speak("The marked point oscillates back and forth but doesn't travel forward. This shows that particles in a sound wave vibrate about their mean position!");
        }

        // Example Demo
        async function showExample() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(8);
            
            const teacher = createNewTeacher('example');
            await showExampleInternal(teacher);
            
            isPlaying = false;
        }

        async function showExampleInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("ðŸ“– NCERT Example 11.1");
            
            document.getElementById('example-demo').classList.add('active');
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Let's solve Example 11.1 about calculating the time for sound to travel a given distance.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            await teacher.speak("Given frequency 2 kilohertz and wavelength 35 centimeters, we first find the speed using v equals lambda times nu.");
            if (!shouldContinue(taskId)) return;
            
            await animateExampleSteps();
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            await teacher.speak("The speed is 700 meters per second. To travel 1.5 kilometers, the time is 2.14 seconds!");
        }

        async function animateExampleSteps() {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`ex1-step${i}`);
                if (stepElement) {
                    stepElement.classList.add('show');
                }
            }
            
            const answerElement = document.getElementById('ex1-answer');
            if (answerElement) {
                gsap.set(answerElement, {
                    opacity: 1,
                    scale: 1
                });
            }
            
            await wait(500);
        }

        // Questions Demo
        async function showQuestions() {
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton(9);
            
            const teacher = createNewTeacher('questions');
            await showQuestionsInternal(teacher);
            
            isPlaying = false;
        }

        async function showQuestionsInternal(teacher) {
            await resetAll();
            await wait(50);
            const taskId = currentTaskId;
            if (!shouldContinue(taskId)) return;
            
            updateTitle("â“ Practice Questions");
            
            document.getElementById('questions-demo').classList.add('active');
            
            initQuestionsCarousel();
            
            await wait(50);
            if (!shouldContinue(taskId)) return;
            
            await teacher.speak("Test your understanding with practice questions. Click 'Show Answer' to see detailed solutions.");
            if (!shouldContinue(taskId)) return;
            
            const questionText = document.getElementById('question-text-1').textContent.trim();
            await teacher.speak(`Question 1: ${questionText}`);
        }

        // Questions Carousel
        let currentQuestionIndex = 0;
        const totalQuestions = 3;
        
        function initQuestionsCarousel() {
            document.getElementById('question-slide-1').classList.add('active');
            
            document.getElementById('prev-question').addEventListener('click', showPreviousQuestion);
            document.getElementById('next-question').addEventListener('click', showNextQuestion);
            
            document.querySelectorAll('.indicator-dot').forEach((dot, index) => {
                dot.addEventListener('click', () => goToQuestion(index));
            });
        }
        
        function showNextQuestion() {
            if (currentQuestionIndex < totalQuestions - 1) {
                goToQuestion(currentQuestionIndex + 1);
            }
        }
        
        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                goToQuestion(currentQuestionIndex - 1);
            }
        }
        
        function goToQuestion(index) {
            document.querySelectorAll('.question-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            document.getElementById(`question-slide-${index + 1}`).classList.add('active');
            
            document.querySelectorAll('.indicator-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            document.getElementById('prev-question').disabled = index === 0;
            document.getElementById('next-question').disabled = index === totalQuestions - 1;
            
            currentQuestionIndex = index;
            
            if (currentTeacher && currentTeacher.speak) {
                const questionText = document.getElementById(`question-text-${index + 1}`).textContent.trim();
                currentTeacher.speak(`Question ${index + 1}: ${questionText}`);
            }
            
            document.querySelectorAll('.answer-section').forEach(section => {
                section.classList.remove('show');
            });
        }
        
        function showAnswer(questionNumber) {
            const answerSection = document.getElementById(`answer-${questionNumber}`);
            answerSection.classList.add('show');
            
            if (currentTeacher) {
                const answers = {
                    1: "Sound waves are mechanical waves that require a medium for propagation. They involve particle vibration about mean positions.",
                    2: "Compressions are high-pressure regions with maximum particle density. Rarefactions are low-pressure regions with minimum particle density.",
                    3: "Using the formula v equals lambda times nu, wavelength equals 440 divided by 220, which gives 2 meters."
                };
                currentTeacher.speak(answers[questionNumber]);
            }
        }

        // Helper Functions
        async function resetAll() {
            if (animationTimeline) {
                animationTimeline.kill();
                animationTimeline = null;
            }
            gsap.killTweensOf("*");
            
            activeAnimations.forEach(anim => {
                if (anim && typeof anim.kill === 'function') {
                    anim.kill();
                } else if (anim && typeof anim === 'number') {
                    clearInterval(anim);
                }
            });
            activeAnimations = [];
            
            if (currentTeacher) {
                currentTeacher.stop();
            }
            
            document.querySelectorAll('.sound-intro-demo, .density-pressure-demo, .pitch-amplitude-demo, .sound-formula-demo, .wave-types-demo, .visual-motion-demo, .activity-demo, .example-demo, .questions-demo').forEach(demo => {
                demo.classList.remove('active');
            });
            
            updateTitle("Explore Sound Propagation");
            
            document.getElementById('frequency-input').value = '';
            document.getElementById('wavelength-input').value = '';
            document.getElementById('speed-result').innerHTML = 'Enter values to calculate speed';
            
            gsap.set(['.particle', '.sound-wave-ring'], { x: 0, left: '20px', width: 30, height: 30, opacity: 1 });
            
            document.querySelectorAll('.solution-step').forEach(step => {
                step.classList.add('show');
                gsap.set(step, { opacity: 1, scale: 1 });
            });
            
            document.querySelectorAll('.final-answer').forEach(answer => {
                gsap.set(answer, { opacity: 1, scale: 1 });
            });
            
            document.querySelectorAll('.answer-section').forEach(section => {
                section.classList.remove('show');
            });
            
            currentQuestionIndex = 0;
            document.querySelectorAll('.question-slide').forEach((slide, index) => {
                slide.classList.toggle('active', index === 0);
            });
            document.querySelectorAll('.indicator-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === 0);
            });
            
            resetWaveDemos();
            
            await wait(500);
        }

        function updateTitle(title) {
            document.getElementById('demo-title').textContent = title;
        }

        function setActiveButton(index) {
            document.querySelectorAll('.demo-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function resetAllClick() {
            stopCurrentDemo();
            isPlaying = false;
            await resetAll();
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentTeacher) {
                currentTeacher.stop();
            }
        });

        // Enter key support for calculator
        ['frequency-input', 'wavelength-input'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    calculateSoundSpeed();
                }
            });
        });
    </script>
</body>
</html>